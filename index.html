<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vy√∫ƒçtov√°n√≠ pracovn√≠ cesty v zahraniƒç√≠</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            font-size: 12px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* Kalkulaƒçka - pro vstup dat */
        .calculator {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            padding: 30px;
        }

        .calculator h1 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group textarea {
            height: 60px;
            resize: vertical;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-print {
            background: #e74c3c;
        }

        .btn-print:hover {
            background: #c0392b;
        }

        .btn-save {
            background: #f39c12;
        }

        .btn-save:hover {
            background: #e67e22;
        }

        .btn-pdf {
            background: #9b59b6;
        }

        .btn-pdf:hover {
            background: #8e44ad;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .button-row {
            text-align: center;
            margin-top: 20px;
        }

        /* Sekce doklad≈Ø */
        .receipts-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .receipts-section h3 {
            margin-bottom: 15px;
            color: white;
        }

        .receipt-item {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .receipt-info {
            flex-grow: 1;
        }

        .receipt-amount {
            font-weight: bold;
            color: #27ae60;
            margin-left: 15px;
        }

        .add-receipt-form {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .add-receipt-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 100px;
            gap: 10px;
            align-items: end;
            margin-bottom: 10px;
        }

        /* Formul√°≈ô - pro tisk */
        .form-document {
            padding: 20px;
            display: none;
            background: white;
        }

        .form-document.show {
            display: block;
        }

        .form-header {
            background: #4CAF50;
            color: white;
            text-align: center;
            padding: 15px;
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .form-section {
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .form-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 5px 0;
            border-bottom: 1px dotted #ddd;
        }

        .form-line:last-child {
            border-bottom: none;
        }

        .form-line strong {
            margin-right: 10px;
        }

        .underline {
            border-bottom: 1px solid #000;
            min-width: 200px;
            display: inline-block;
            text-align: center;
            padding: 2px 5px;
        }

        .checkbox {
            margin: 0 10px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .table th, .table td {
            border: 1px solid #000;
            padding: 8px;
            text-align: center;
            font-size: 11px;
        }

        .table th {
            background: #f0f0f0;
            font-weight: bold;
        }

        .signature-section {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
            font-size: 10px;
        }

        .signature-box {
            text-align: center;
            border-top: 1px solid #000;
            padding-top: 5px;
            margin-top: 40px;
        }

        .receipt-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .receipt-summary h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .receipt-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            padding: 5px 0;
            border-bottom: 1px dotted #ddd;
        }

        .receipt-line:last-child {
            border-bottom: none;
            font-weight: bold;
            border-top: 1px solid #ddd;
            margin-top: 5px;
            padding-top: 10px;
        }

        /* Tiskov√© styly */
        @media print {
            body {
                background: white !important;
                padding: 0 !important;
                font-size: 11px !important;
            }

            .calculator {
                display: none !important;
            }

            .saved-trips {
                display: none !important;
            }

            .form-document {
                display: block !important;
                padding: 10px !important;
            }

            .container {
                box-shadow: none !important;
                border-radius: 0 !important;
                max-width: none !important;
            }

            .btn {
                display: none !important;
            }

            .form-section {
                break-inside: avoid;
                page-break-inside: avoid;
            }

            .table {
                break-inside: auto;
            }

            .signature-section {
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .signature-section {
                grid-template-columns: 1fr;
            }

            .add-receipt-row {
                grid-template-columns: 1fr;
            }
        }

        .saved-trips {
            background: #f8f9fa;
            padding: 20px;
            border-top: 2px solid #2ecc71;
        }

        .saved-trip {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
            cursor: pointer;
            transition: background 0.3s;
        }

        .saved-trip:hover {
            background: #e8f5e8;
        }

        .trip-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .trip-details {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Kalkulaƒçka pro vstup dat -->
        <div class="calculator" id="calculator">
            <h1>üßÆ Kalkulaƒçka cestovn√≠ho formul√°≈ôe</h1>
            
            <form id="travelForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Jm√©no zamƒõstnance:</label>
                        <input type="text" id="employeeName" placeholder="Bc. Zdenƒõk ≈†i≈°ka">
                    </div>
                    <div class="form-group">
                        <label>Bydli≈°tƒõ:</label>
                        <input type="text" id="residence" placeholder="Sokolovsk√° 397, 33441 Dob≈ôany">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Zamƒõstnavatel:</label>
                        <input type="text" id="employer" placeholder="DMDsoft s.r.o.">
                    </div>
                    <div class="form-group">
                        <label>Iƒå zamƒõstnavatele:</label>
                        <input type="text" id="employerIC" placeholder="03393356">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Cesta do:</label>
                        <input type="text" id="destination" placeholder="≈Ωilina, Pova≈æsk√° Bystrica - SK">
                    </div>
                    <div class="form-group">
                        <label>√öƒçel cesty:</label>
                        <input type="text" id="purpose" placeholder="Pracovn√≠ jedn√°n√≠">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Datum zaƒç√°tku cesty:</label>
                        <input type="date" id="startDate" required>
                    </div>
                    <div class="form-group">
                        <label>Datum konce cesty:</label>
                        <input type="date" id="endDate" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ƒåas odjezdu:</label>
                        <input type="time" id="departureTime" value="04:00">
                    </div>
                    <div class="form-group">
                        <label>ƒåas p≈ô√≠jezdu:</label>
                        <input type="time" id="arrivalTime" value="23:15">
                    </div>
                </div>

                <!-- Sekce doklad≈Ø -->
                <div class="receipts-section">
                    <h3>üìÑ Doklady o v√Ωdaj√≠ch</h3>
                    
                    <div class="add-receipt-form">
                        <div class="add-receipt-row">
                            <div>
                                <label>Popis v√Ωdaje:</label>
                                <input type="text" id="receiptDescription" placeholder="nap≈ô. Ubytov√°n√≠ Hotel Zlat√Ω B√Ωk">
                            </div>
                            <div>
                                <label>ƒå√°stka (EUR):</label>
                                <input type="number" id="receiptAmount" step="0.01" placeholder="0.00">
                            </div>
                            <div>
                                <label>Typ:</label>
                                <select id="receiptType">
                                    <option value="ubytov√°n√≠">Ubytov√°n√≠</option>
                                    <option value="tankov√°n√≠">Tankov√°n√≠</option>
                                    <option value="parkovn√©">Parkovn√©</option>
                                    <option value="m√Ωto">M√Ωto</option>
                                    <option value="ostatn√≠">Ostatn√≠ v√Ωdaje</option>
                                </select>
                            </div>
                            <div>
                                <button type="button" class="btn btn-small" onclick="addReceipt()">‚ûï P≈ôidat</button>
                            </div>
                        </div>
                    </div>

                    <div id="receiptsList"></div>

                    <div class="receipt-summary" id="receiptsSummary" style="display:none;">
                        <h4>üìä Shrnut√≠ v√Ωdaj≈Ø</h4>
                        <div id="receiptsBreakdown"></div>
                    </div>
                </div>

                <div class="button-row">
                    <button type="button" class="btn" onclick="calculateAndShowForm()">üìã Vytvo≈ôit formul√°≈ô</button>
                    <button type="button" class="btn btn-print" onclick="printForm()" id="printBtn" style="display:none">üñ®Ô∏è Vytisknout</button>
                    <button type="button" class="btn btn-pdf" onclick="exportToPDF()" id="pdfBtn" style="display:none">üìÑ Ulo≈æit PDF</button>
                    <button type="button" class="btn btn-save" onclick="saveTrip()" id="saveBtn" style="display:none">üíæ Ulo≈æit cestu</button>
                    <button type="button" class="btn" onclick="clearForm()">üóëÔ∏è Vymazat</button>
                </div>
            </form>
        </div>

        <!-- Ulo≈æen√© cesty -->
        <div class="saved-trips" id="savedTrips" style="display:none">
            <h3>üíæ Ulo≈æen√© cesty</h3>
            <div id="savedTripsList"></div>
        </div>

        <!-- Formul√°≈ô pro tisk -->
        <div class="form-document" id="formDocument">
            <div class="form-header">
                VY√öƒåTOV√ÅN√ç PRACOVN√ç CESTY V ZAHRANIƒå√ç
            </div>

            <div class="form-section">
                <div class="form-line">
                    <span><strong>Jm√©no zamƒõstnance:</strong> <span class="underline" id="printEmployeeName"></span></span>
                </div>
                <div class="form-line">
                    <span><strong>Bydli≈°tƒõ:</strong> <span class="underline" id="printResidence"></span></span>
                </div>
                <div class="form-line">
                    <span><strong>Zamƒõstnavatel:</strong> <span class="underline" id="printEmployer"></span></span>
                </div>
                <div class="form-line">
                    <span><strong>Cesta do:</strong> <span class="underline" id="printDestination"></span> <strong>vykon√°na ve dnech:</strong> <span class="underline" id="printDateRange"></span></span>
                </div>
                <div class="form-line">
                    <span><strong>Urƒçen√Ω dopravn√≠ prost≈ôedek:</strong> <span class="underline">AUS</span></span>
                </div>
            </div>

            <div class="form-section">
                <div class="form-line">
                    <span><strong>V√Ω≈°e p≈ôidƒõl≈Ø devizov√Ωch prost≈ôedk≈Ø podle p≈ôipojen√Ωch doklad≈Ø banky:</strong></span>
                </div>
                <div class="form-line">
                    <span>v ≈°ec√≠ch: .......... v hotovosti: <span class="underline">0,00</span></span>
                </div>
                <div class="form-line">
                    <span><strong>Celkem:</strong> .......... <strong>Kurs:</strong> ..........</span>
                </div>
                <div class="form-line">
                    <span><strong>V√Ω≈°e denn√≠ho stravn√©ho:</strong> <span class="underline">35,00 EUR</span> <strong>V√Ω≈°e kapesn√©ho:</strong> <span class="underline">14,00 EUR</span></span>
                </div>
                <div class="form-line">
                    <span><strong>Celodenn√≠ bezplatn√© stravov√°n√≠ poskytov√°no ve dnech:</strong> <span class="underline" id="printMealDates"></span></span>
                </div>
                <div class="form-line">
                    <span><strong>ƒå√°steƒçn√© bezplatn√© stravov√°n√≠ poskytov√°no:</strong> ano ‚òê ne ‚òí</span>
                </div>
            </div>

            <div class="form-section">
                <div class="form-line">
                    <strong>Devizov√Ω n√°rok:</strong>
                </div>
                
                <table class="table" id="dailyAllowanceTable">
                    <thead>
                        <tr>
                            <th>a) odlet/p≈ô√≠jezd ze zahraniƒç√≠</th>
                            <th>Hodina</th>
                            <th>tj.</th>
                            <th>% stravn√©/kapesn√©</th>
                            <th>n√°rok</th>
                        </tr>
                    </thead>
                    <tbody id="dailyAllowanceBody">
                    </tbody>
                </table>

                <div class="form-line">
                    <span><strong>Poƒç√°tek a ukonƒçen√≠ prac. v√Ωkonu:</strong></span>
                </div>
                <div class="form-line">
                    <span><strong>P≈ô√≠let (p≈ô√≠jezd ze zahraniƒç√≠):</strong></span>
                </div>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>Dne</th>
                            <th>Hodina</th>
                            <th>tj.</th>
                            <th>% stravn√©/kapesn√©</th>
                            <th>n√°rok</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td id="returnDate"></td>
                            <td id="returnTime"></td>
                            <td id="returnHours">40,0</td>
                            <td>% stravn√©/kapesn√©</td>
                            <td id="totalAllowance"></td>
                        </tr>
                    </tbody>
                </table>

                <div class="form-line">
                    <span><strong>b) v√Ωdaje na ubytov√°n√≠:</strong> <span id="accommodationReceipts">doklad ƒç. .........................</span></span>
                </div>
                <div class="form-line">
                    <span><strong>c) nutn√© vedlej≈°√≠ v√Ωdaje:</strong> <span id="otherReceipts">doklad ƒç. .........................</span></span>
                </div>
                <div class="form-line" id="additionalReceiptsLine" style="display:none;">
                    <span><strong>Dal≈°√≠ v√Ωdaje:</strong> <span id="additionalReceipts"></span></span>
                </div>
                <div class="form-line">
                    <span><strong>√∫hrnem n√°rok:</strong> <span class="underline" id="totalEUR"></span></span>
                </div>
            </div>

            <div class="form-section">
                <div class="form-line">
                    <strong>Zji≈°tƒõn√≠ rozd√≠lu mezi p≈ôidƒõlen√Ωmi a vynalo≈æenlmi prost≈ôedky:</strong>
                </div>
                <div class="form-line">
                    <span>P≈ô√≠jem: .........................</span>
                </div>
                <div class="form-line">
                    <span>N√°rok: <span class="underline" id="finalClaim"></span></span>
                </div>
                <div class="form-line">
                    <span>Vr√°ceno: .........................</span>
                </div>
                <div class="form-line">
                    <span>Doplatek: <span class="underline" id="finalPayment"></span></span>
                </div>
                <div class="form-line">
                    <span><strong>Rozd√≠l (dosa≈æen√° devizov√° √∫spora, p≈ô√≠p. p≈ôeƒçerp√°n√≠):</strong></span>
                </div>
                <div class="form-line">
                    <span>Vr√°ceno bance prost≈ôednictv√≠m zahraniƒçn√≠ banky: .........................</span>
                </div>
                <div class="form-line">
                    <span>Vr√°ceno bance prost≈ôednictv√≠m zamƒõstnavatele: .........................</span>
                </div>
                <div class="form-line">
                    <span>doklad ƒç. ......................... doklad ƒç. .........................</span>
                </div>
                <div class="form-line">
                    <span>vr√°ceno celkem: .........................</span>
                </div>
            </div>

            <div class="form-section">
                <div class="form-line">
                    <span>Nepou≈æit√© letenky, j√≠zdenky, lodn√≠ l√≠stky a vouchery (p≈ô√≠p. nedoƒçerpan√© vouchery) byly vr√°ceny dne: .........................</span>
                </div>
                <div class="form-line">
                    <span>Prohla≈°uji, ≈æe moje √∫daje jsou spr√°vn√© a √∫pln√©. Pokud se v dokladech o ubytov√°n√≠ vyskytuj√≠ sazby vƒçetnƒõ stravov√°n√≠ (Full board, pln√° pense), je tato skuteƒçnost na dokladech uvedena.</span>
                </div>
            </div>

            <div class="signature-section">
                <div>
                    <div class="signature-box">Dne</div>
                    <div style="text-align: center; margin-top: 10px;" id="signatureDate"></div>
                </div>
                <div>
                    <div class="signature-box">Podpis zamƒõstnance</div>
                </div>
                <div>
                    <div class="signature-box">Podpis zamƒõstnance, kter√Ω upravil vy√∫ƒçtov√°n√≠</div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px; font-size: 10px;">
                <strong>Datum a podpis odpovƒõdn√©ho pracovn√≠ka</strong>
            </div>

            <div style="text-align: center; margin-top: 30px; font-size: 8px; color: #666;">
                Vytvo≈ôeno v programu FORM studio - www.kastnersw.cz
            </div>
        </div>
    </div>

    <script>
        const EUR_TO_CZK = 25.20;
        let savedTrips = JSON.parse(localStorage.getItem('savedTrips') || '[]');
        let receipts = [];

        function addReceipt() {
            const description = document.getElementById('receiptDescription').value;
            const amount = parseFloat(document.getElementById('receiptAmount').value);
            const type = document.getElementById('receiptType').value;

            if (!description || !amount || amount <= 0) {
                alert('Pros√≠m vypl≈àte popis a platnou ƒç√°stku.');
                return;
            }

            const receipt = {
                id: Date.now(),
                description: description,
                amount: amount,
                type: type
            };

            receipts.push(receipt);
            updateReceiptsList();
            updateReceiptsSummary();

            // Vymaz√°n√≠ formul√°≈ôe
            document.getElementById('receiptDescription').value = '';
            document.getElementById('receiptAmount').value = '';
        }

        function removeReceipt(receiptId) {
            receipts = receipts.filter(r => r.id !== receiptId);
            updateReceiptsList();
            updateReceiptsSummary();
        }

        function updateReceiptsList() {
            const container = document.getElementById('receiptsList');
            container.innerHTML = '';

            receipts.forEach(receipt => {
                const item = document.createElement('div');
                item.className = 'receipt-item';
                item.innerHTML = `
                    <div class="receipt-info">
                        <strong>${receipt.description}</strong><br>
                        <small>Typ: ${receipt.type}</small>
                    </div>
                    <div class="receipt-amount">${receipt.amount.toFixed(2)} EUR</div>
                    <button class="btn btn-small btn-danger" onclick="removeReceipt(${receipt.id})">üóëÔ∏è</button>
                `;
                container.appendChild(item);
            });
        }

        function updateReceiptsSummary() {
            const summary = document.getElementById('receiptsSummary');
            const breakdown = document.getElementById('receiptsBreakdown');

            if (receipts.length === 0) {
                summary.style.display = 'none';
                return;
            }

            summary.style.display = 'block';

            // Seskupen√≠ podle typu
            const grouped = receipts.reduce((acc, receipt) => {
                if (!acc[receipt.type]) acc[receipt.type] = 0;
                acc[receipt.type] += receipt.amount;
                return acc;
            }, {});

            const total = receipts.reduce((sum, r) => sum + r.amount, 0);

            let html = '';
            Object.entries(grouped).forEach(([type, amount]) => {
                html += `<div class="receipt-line"><span>${type}:</span><span>${amount.toFixed(2)} EUR</span></div>`;
            });
            html += `<div class="receipt-line"><span>Celkem v√Ωdaje:</span><span>${total.toFixed(2)} EUR</span></div>`;

            breakdown.innerHTML = html;
        }

        function calculateDays(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('cs-CZ');
        }

        function formatDateRange(startDate, endDate) {
            return `${formatDate(startDate)} - ${formatDate(endDate)}`;
        }

        function calculateAndShowForm() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                alert('Pros√≠m vypl≈àte datum zaƒç√°tku a konce cesty.');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                alert('Datum zaƒç√°tku nem≈Ø≈æe b√Ωt pozdƒõji ne≈æ datum konce.');
                return;
            }

            const days = calculateDays(startDate, endDate);
            
            // V√Ωpoƒçet ƒç√°stek
            const stravne = 35.00;
            const kapesne = 14.00;
            const celkemDen = 49.00;
            const allowanceTotal = days * celkemDen;
            const receiptsTotal = receipts.reduce((sum, r) => sum + r.amount, 0);
            const grandTotal = allowanceTotal + receiptsTotal;

            // Vyplnƒõn√≠ z√°kladn√≠ch √∫daj≈Ø
            document.getElementById('printEmployeeName').textContent = document.getElementById('employeeName').value || 'Bc. Zdenƒõk ≈†i≈°ka';
            document.getElementById('printResidence').textContent = document.getElementById('residence').value || 'Sokolovsk√° 397, 33441 Dob≈ôany';
            document.getElementById('printEmployer').textContent = document.getElementById('employer').value || 'DMDsoft s.r.o.';
            document.getElementById('printDestination').textContent = document.getElementById('destination').value || '≈Ωilina, Pova≈æsk√° Bystrica - SK';
            document.getElementById('printDateRange').textContent = formatDateRange(startDate, endDate);
            document.getElementById('printMealDates').textContent = formatDateRange(startDate, endDate);

            // Vyplnƒõn√≠ tabulky denn√≠ch p≈ô√≠spƒõvk≈Ø
            const tableBody = document.getElementById('dailyAllowanceBody');
            tableBody.innerHTML = '';

            let currentDate = new Date(startDate);
            const endDateObj = new Date(endDate);

            while (currentDate <= endDateObj) {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>od ${formatDate(currentDate.toISOString().split('T')[0])} do</td>
                    <td></td>
                    <td>√°</td>
                    <td>${stravne.toFixed(2)} str/kap</td>
                    <td>${celkemDen.toFixed(2)}</td>
                `;
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Vyplnƒõn√≠ doklad≈Ø
            updateReceiptsInForm();

            // Vyplnƒõn√≠ z√°vƒõreƒçn√Ωch √∫daj≈Ø
            document.getElementById('returnDate').textContent = formatDate(endDate);
            document.getElementById('returnTime').textContent = document.getElementById('arrivalTime').value || '23:15';
            document.getElementById('totalAllowance').textContent = `${allowanceTotal.toFixed(2)}`;
            document.getElementById('totalEUR').textContent = `${grandTotal.toFixed(2)} EUR`;
            document.getElementById('finalClaim').textContent = `${grandTotal.toFixed(2)} EUR`;
            document.getElementById('finalPayment').textContent = `${grandTotal.toFixed(2)} EUR`;
            document.getElementById('signatureDate').textContent = formatDate(new Date().toISOString().split('T')[0]);

            // Zobrazen√≠ formul√°≈ôe a tlaƒç√≠tek
            document.getElementById('formDocument').classList.add('show');
            document.getElementById('printBtn').style.display = 'inline-block';
            document.getElementById('pdfBtn').style.display = 'inline-block';
            document.getElementById('saveBtn').style.display = 'inline-block';

            // P≈ôesun na formul√°≈ô
            document.getElementById('formDocument').scrollIntoView({ behavior: 'smooth' });
        }

        function updateReceiptsInForm() {
            const accommodationReceipts = receipts.filter(r => r.type === 'ubytov√°n√≠');
            const otherReceipts = receipts.filter(r => r.type !== 'ubytov√°n√≠');

            // Ubytov√°n√≠
            const accommodationElement = document.getElementById('accommodationReceipts');
            if (accommodationReceipts.length > 0) {
                const accommodationText = accommodationReceipts.map((r, index) => 
                    `doklad ƒç. ${index + 1} (${r.description} - ${r.amount.toFixed(2)} EUR)`
                ).join(', ');
                accommodationElement.textContent = accommodationText;
            } else {
                accommodationElement.textContent = 'doklad ƒç. .........................';
            }

            // Ostatn√≠ v√Ωdaje
            const otherElement = document.getElementById('otherReceipts');
            if (otherReceipts.length > 0) {
                const otherText = otherReceipts.map((r, index) => 
                    `doklad ƒç. ${accommodationReceipts.length + index + 1} (${r.description} - ${r.amount.toFixed(2)} EUR)`
                ).join(', ');
                otherElement.textContent = otherText;
            } else {
                otherElement.textContent = 'doklad ƒç. .........................';
            }

            // Zobrazen√≠ dodateƒçn√© ≈ô√°dky pokud je v√≠ce doklad≈Ø
            const additionalLine = document.getElementById('additionalReceiptsLine');
            const additionalElement = document.getElementById('additionalReceipts');
            
            if (receipts.length > 4) {
                const additionalReceipts = receipts.slice(4);
                const additionalText = additionalReceipts.map((r, index) => 
                    `doklad ƒç. ${5 + index} (${r.description} - ${r.amount.toFixed(2)} EUR)`
                ).join(', ');
                additionalElement.textContent = additionalText;
                additionalLine.style.display = 'block';
            } else {
                additionalLine.style.display = 'none';
            }
        }

        function printForm() {
            // Ujist√≠me se, ≈æe je formul√°≈ô viditeln√Ω pro tisk
            const formDocument = document.getElementById('formDocument');
            const calculator = document.getElementById('calculator');
            const savedTrips = document.getElementById('savedTrips');
            
            // Doƒçasnƒõ skryjeme ostatn√≠ sekce
            calculator.style.display = 'none';
            savedTrips.style.display = 'none';
            formDocument.style.display = 'block';
            
            // Tisk
            window.print();
            
            // Vr√°t√≠me p≈Øvodn√≠ zobrazen√≠
            setTimeout(() => {
                calculator.style.display = 'block';
                if (savedTrips.children.length > 1) {
                    savedTrips.style.display = 'block';
                }
            }, 100);
        }

        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            
            if (!jsPDF) {
                alert('PDF knihovna se nenaƒçetla. Zkuste to pros√≠m znovu.');
                return;
            }

            try {
                // Zobraz√≠me loading zpr√°vu
                const originalContent = document.getElementById('formDocument').innerHTML;
                document.getElementById('formDocument').innerHTML = '<div class="loading">üìÑ Generujƒô PDF...</div>';

                // Kr√°tk√© zpo≈ædƒõn√≠ pro zobrazen√≠ loading zpr√°vy
                await new Promise(resolve => setTimeout(resolve, 100));

                // Vr√°t√≠me p≈Øvodn√≠ obsah
                document.getElementById('formDocument').innerHTML = originalContent;

                // Aktualizujeme formul√°≈ô
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (startDate && endDate) {
                    // Znovu vypln√≠me formul√°≈ô s aktu√°ln√≠mi daty
                    updateFormForPDF();
                }

                // Vytvo≈ô√≠me canvas z formul√°≈ôe
                const formElement = document.getElementById('formDocument');
                const canvas = await html2canvas(formElement, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: formElement.scrollWidth,
                    height: formElement.scrollHeight
                });

                // Vytvo≈ô√≠me PDF
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const imgWidth = 210; // A4 ≈°√≠≈ôka v mm
                const pageHeight = 295; // A4 v√Ω≈°ka v mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                // P≈ôid√°me prvn√≠ str√°nku
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                // P≈ôid√°me dal≈°√≠ str√°nky pokud je pot≈ôeba
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                // Ulo≈æ√≠me PDF
                const employeeName = document.getElementById('employeeName').value || 'zamestnanec';
                const destination = document.getElementById('destination').value || 'cesta';
                const fileName = `vyuctovani_${employeeName.replace(/\s+/g, '_')}_${destination.replace(/\s+/g, '_')}_${formatDate(new Date().toISOString().split('T')[0]).replace(/\./g, '')}.pdf`;
                
                pdf.save(fileName);

            } catch (error) {
                console.error('Chyba p≈ôi generov√°n√≠ PDF:', error);
                alert('Nepoda≈ôilo se vytvo≈ôit PDF. Zkuste to pros√≠m znovu nebo pou≈æijte funkci tisku.');
            }
        }

        function updateFormForPDF() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) return;

            const days = calculateDays(startDate, endDate);
            const allowanceTotal = days * 49.00;
            const receiptsTotal = receipts.reduce((sum, r) => sum + r.amount, 0);
            const grandTotal = allowanceTotal + receiptsTotal;

            // Datum vystaven√≠ - 3 dny po p≈ô√≠jezdu
            const arrivalDate = new Date(endDate);
            const issueDate = new Date(arrivalDate);
            issueDate.setDate(issueDate.getDate() + 3);

            // Aktualizujeme v≈°echna pole
            document.getElementById('printEmployeeName').textContent = document.getElementById('employeeName').value || 'Bc. Zdenƒõk ≈†i≈°ka';
            document.getElementById('printResidence').textContent = document.getElementById('residence').value || 'Havl√≠ƒçkova 1383, 334 41 Dob≈ôany';
            document.getElementById('printEmployer').textContent = document.getElementById('employer').value || 'DMDsoft s.r.o., Havl√≠ƒçkova 1383, 334 41 Dob≈ôany';
            document.getElementById('printDestination').textContent = document.getElementById('destination').value || '≈Ωilina, Pova≈æsk√° Bystrica - SK';
            document.getElementById('printDateRange').textContent = formatDateRange(startDate, endDate);
            document.getElementById('returnDate').textContent = formatDate(endDate);
            document.getElementById('returnTime').textContent = document.getElementById('arrivalTime').value || '23:15';
            document.getElementById('totalAllowance').textContent = `${allowanceTotal.toFixed(2)}`;
            document.getElementById('totalEUR').textContent = `${grandTotal.toFixed(2)} EUR`;
            document.getElementById('finalClaim').textContent = `${grandTotal.toFixed(2)} EUR`;
            document.getElementById('finalPayment').textContent = `${grandTotal.toFixed(2)} EUR`;
            document.getElementById('signatureDate').textContent = formatDate(issueDate.toISOString().split('T')[0]);
            
            updateReceiptsInForm();
        }

        function saveTrip() {
            const tripData = {
                id: Date.now(),
                employeeName: document.getElementById('employeeName').value,
                residence: document.getElementById('residence').value,
                employer: document.getElementById('employer').value,
                employerIC: document.getElementById('employerIC').value,
                destination: document.getElementById('destination').value,
                purpose: document.getElementById('purpose').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                departureTime: document.getElementById('departureTime').value,
                arrivalTime: document.getElementById('arrivalTime').value,
                receipts: [...receipts],
                savedDate: new Date().toISOString()
            };

            savedTrips.push(tripData);
            localStorage.setItem('savedTrips', JSON.stringify(savedTrips));
            
            alert('Cesta byla √∫spƒõ≈°nƒõ ulo≈æena!');
            displaySavedTrips();
        }

        function displaySavedTrips() {
            if (savedTrips.length === 0) {
                document.getElementById('savedTrips').style.display = 'none';
                return;
            }

            document.getElementById('savedTrips').style.display = 'block';
            const listContainer = document.getElementById('savedTripsList');
            listContainer.innerHTML = '';

            savedTrips.forEach((trip, index) => {
                const tripElement = document.createElement('div');
                tripElement.className = 'saved-trip';
                tripElement.onclick = () => loadTrip(trip);
                
                const days = calculateDays(trip.startDate, trip.endDate);
                const allowanceTotal = days * 49.00;
                const receiptsTotal = (trip.receipts || []).reduce((sum, r) => sum + r.amount, 0);
                const totalAmount = allowanceTotal + receiptsTotal;
                
                tripElement.innerHTML = `
                    <div class="trip-info">
                        <div>
                            <strong>${trip.employeeName || 'Bez jm√©na'}</strong> - ${trip.destination || 'Nespecifikov√°no'}
                        </div>
                        <div>
                            <strong>${totalAmount.toFixed(2)} EUR</strong>
                            <button class="btn btn-small btn-danger" onclick="event.stopPropagation(); deleteTrip(${index})" style="margin-left: 10px;">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="trip-details">
                        ${formatDateRange(trip.startDate, trip.endDate)} (${days} dn≈Ø) | 
                        Stravn√©: ${allowanceTotal.toFixed(2)} EUR, V√Ωdaje: ${receiptsTotal.toFixed(2)} EUR | 
                        Ulo≈æeno: ${formatDate(trip.savedDate.split('T')[0])}
                    </div>
                `;
                
                listContainer.appendChild(tripElement);
            });
        }

        function loadTrip(trip) {
            document.getElementById('employeeName').value = trip.employeeName || '';
            document.getElementById('residence').value = trip.residence || '';
            document.getElementById('employer').value = trip.employer || '';
            document.getElementById('employerIC').value = trip.employerIC || '';
            document.getElementById('destination').value = trip.destination || '';
            document.getElementById('purpose').value = trip.purpose || '';
            document.getElementById('startDate').value = trip.startDate || '';
            document.getElementById('endDate').value = trip.endDate || '';
            document.getElementById('departureTime').value = trip.departureTime || '04:00';
            document.getElementById('arrivalTime').value = trip.arrivalTime || '23:15';
            
            // Naƒçten√≠ doklad≈Ø
            receipts = trip.receipts || [];
            updateReceiptsList();
            updateReceiptsSummary();
            
            // P≈ôesun zpƒõt na kalkulaƒçku
            document.getElementById('calculator').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteTrip(index) {
            if (confirm('Opravdu chcete smazat tuto ulo≈æenou cestu?')) {
                savedTrips.splice(index, 1);
                localStorage.setItem('savedTrips', JSON.stringify(savedTrips));
                displaySavedTrips();
            }
        }

        function clearForm() {
            document.getElementById('travelForm').reset();
            receipts = [];
            updateReceiptsList();
            updateReceiptsSummary();
            document.getElementById('formDocument').classList.remove('show');
            document.getElementById('printBtn').style.display = 'none';
            document.getElementById('pdfBtn').style.display = 'none';
            document.getElementById('saveBtn').style.display = 'none';
        }

        // Inicializace p≈ôi naƒçten√≠ str√°nky
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            displaySavedTrips();

            // Kontrola dostupnosti PDF knihoven
            if (!window.jspdf || !window.html2canvas) {
                console.warn('PDF knihovny nejsou k dispozici');
            }
        });

        // P≈ôid√°n√≠ event listeneru pro Enter kl√°vesy v dokladech
        document.getElementById('receiptAmount').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addReceipt();
            }
        });

        document.getElementById('receiptDescription').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addReceipt();
            }
        });
    </script>
</body>
</html>
