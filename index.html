<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vy√∫ƒçtov√°n√≠ pracovn√≠ cesty v zahraniƒç√≠</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" onerror="console.error('Chyba p≈ôi naƒç√≠t√°n√≠ jsPDF')"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" onerror="console.error('Chyba p≈ôi naƒç√≠t√°n√≠ html2canvas')"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" onerror="console.error('Chyba p≈ôi naƒç√≠t√°n√≠ PDF.js')"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            font-size: 12px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* Kalkulaƒçka - pro vstup dat */
        .calculator {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            padding: 30px;
        }

        .calculator h1 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group textarea {
            height: 60px;
            resize: vertical;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-print {
            background: #e74c3c;
        }

        .btn-print:hover {
            background: #c0392b;
        }

        .btn-save {
            background: #f39c12;
        }

        .btn-save:hover {
            background: #e67e22;
        }

        .btn-pdf {
            background: #9b59b6;
        }

        .btn-pdf:hover {
            background: #8e44ad;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .button-row {
            text-align: center;
            margin-top: 20px;
        }

        /* Sekce doklad≈Ø */
        .receipts-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .receipts-section h3 {
            margin-bottom: 15px;
            color: white;
        }

        .receipt-item {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .receipt-info {
            flex-grow: 1;
        }

        .receipt-amount {
            font-weight: bold;
            color: #27ae60;
            margin-left: 15px;
        }

        .add-receipt-form {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .add-receipt-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 100px;
            gap: 10px;
            align-items: end;
            margin-bottom: 10px;
        }

        /* Formul√°≈ô - pro tisk */
        .form-document {
            padding: 20px;
            display: none;
            background: white;
        }

        .form-document.show {
            display: block;
        }

        .form-header {
            background: #4CAF50;
            color: white;
            text-align: center;
            padding: 15px;
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .form-section {
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .form-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 5px 0;
            border-bottom: 1px dotted #ddd;
        }

        .form-line:last-child {
            border-bottom: none;
        }

        .form-line strong {
            margin-right: 10px;
        }

        .underline {
            border-bottom: 1px solid #000;
            min-width: 200px;
            display: inline-block;
            text-align: center;
            padding: 2px 5px;
        }

        .checkbox {
            margin: 0 10px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .table th, .table td {
            border: 1px solid #000;
            padding: 8px;
            text-align: center;
            font-size: 11px;
        }

        .table th {
            background: #f0f0f0;
            font-weight: bold;
        }

        .signature-section {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
            font-size: 10px;
        }

        .signature-box {
            text-align: center;
            border-top: 1px solid #000;
            padding-top: 5px;
            margin-top: 40px;
        }

        .receipt-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .receipt-summary h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .receipt-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            padding: 5px 0;
            border-bottom: 1px dotted #ddd;
        }

        .receipt-line:last-child {
            border-bottom: none;
            font-weight: bold;
            border-top: 1px solid #ddd;
            margin-top: 5px;
            padding-top: 10px;
        }

        /* Tiskov√© styly - optimalizovan√© pro jednu str√°nku */
        @media print {
            body {
                background: white !important;
                padding: 0 !important;
                font-size: 9px !important;
                margin: 0 !important;
            }
            
            /* Page break pro sekci nepou≈æit√Ωch letenek */
            .page-break-section {
                page-break-before: always;
                break-before: page;
            }

            .calculator {
                display: none !important;
            }

            .saved-trips {
                display: none !important;
            }

            .form-document {
                display: block !important;
                padding: 5px !important;
                margin: 0 !important;
            }

            .container {
                box-shadow: none !important;
                border-radius: 0 !important;
                max-width: none !important;
                margin: 0 !important;
            }

            .btn {
                display: none !important;
            }

            .form-header {
                font-size: 12px !important;
                padding: 8px !important;
                margin-bottom: 10px !important;
            }

            .form-section {
                padding: 8px !important;
                margin-bottom: 8px !important;
                break-inside: avoid;
                page-break-inside: avoid;
            }

            .form-line {
                margin-bottom: 3px !important;
                padding: 2px 0 !important;
                font-size: 9px !important;
            }

            .table {
                font-size: 8px !important;
                margin: 5px 0 !important;
            }

            .table th, .table td {
                padding: 3px !important;
                font-size: 8px !important;
            }

            .signature-section {
                margin-top: 15px !important;
                font-size: 8px !important;
                break-inside: avoid;
                page-break-inside: avoid;
            }

            .signature-box {
                margin-top: 20px !important;
            }

            .underline {
                min-width: 120px !important;
            }

            /* Kompaktn√≠ re≈æim pro tisk */
            .compact-mode .form-section {
                padding: 5px !important;
                margin-bottom: 5px !important;
            }

            .compact-mode .form-line {
                margin-bottom: 2px !important;
                padding: 1px 0 !important;
            }

            .compact-mode .table {
                margin: 3px 0 !important;
            }

            .compact-mode .signature-section {
                margin-top: 10px !important;
            }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .signature-section {
                grid-template-columns: 1fr;
            }

            .add-receipt-row {
                grid-template-columns: 1fr;
            }
        }

        .saved-trips {
            background: #f8f9fa;
            padding: 20px;
            border-top: 2px solid #2ecc71;
        }

        .saved-trip {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
            cursor: pointer;
            transition: background 0.3s;
        }

        .saved-trip:hover {
            background: #e8f5e8;
        }

        .trip-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .trip-details {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        /* Celkov√Ω souƒçet */
        .total-summary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .total-summary h3 {
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.2rem;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-item.total-item {
            background: rgba(255, 255, 255, 0.2);
            font-weight: bold;
            font-size: 1.1rem;
        }

        .stat-label {
            display: block;
            font-size: 12px;
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .stat-value {
            display: block;
            font-size: 18px;
            font-weight: bold;
        }

        .summary-actions {
            text-align: center;
        }

        .btn-export {
            background: #e74c3c;
            margin: 5px;
        }

        .btn-export:hover {
            background: #c0392b;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        /* Email modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        .modal-header h3 {
            margin: 0;
            color: #2c3e50;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #000;
        }

        .email-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .email-form label {
            font-weight: bold;
            color: #2c3e50;
        }

        .email-form input,
        .email-form textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .email-form textarea {
            height: 80px;
            resize: vertical;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .modal-buttons .btn {
            margin: 0;
        }

        /* Mobiln√≠ optimalizace pro modal */
        .mobile-mode .modal-content {
            margin: 2% auto;
            width: 95%;
            padding: 15px;
        }

        .mobile-mode .modal-header h3 {
            font-size: 1.2rem;
        }

        .mobile-mode .email-form input,
        .mobile-mode .email-form textarea {
            font-size: 16px;
            padding: 12px;
        }

        .mobile-mode .modal-buttons {
            flex-direction: column;
        }

        .mobile-mode .modal-buttons .btn {
            width: 100%;
        }

        /* Mobiln√≠ optimalizace pro podpisy */
        .mobile-mode .signatures-section {
            padding: 15px !important;
        }

        /* Mobiln√≠ optimalizace pro podpisovou sekci */
        .mobile-mode .signature-section {
            grid-template-columns: 1fr 1fr !important;
            gap: 15px !important;
        }

        .mobile-mode .signature-section > div {
            margin-bottom: 15px !important;
        }

        .mobile-mode .signature-section img {
            max-height: 200px !important;
        }

        /* Kompaktn√≠ re≈æim pro formul√°≈ô */
        .compact-mode .form-section {
            padding: 8px;
            margin-bottom: 8px;
        }

        .compact-mode .form-line {
            margin-bottom: 4px;
            padding: 2px 0;
            font-size: 11px;
        }

        .compact-mode .table {
            margin: 8px 0;
            font-size: 10px;
        }

        .compact-mode .table th, .compact-mode .table td {
            padding: 4px;
            font-size: 10px;
        }

        .compact-mode .signature-section {
            margin-top: 15px;
            font-size: 9px;
        }

        .compact-mode .signature-box {
            margin-top: 25px;
        }

        .compact-mode .form-header {
            padding: 10px;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .compact-mode .signature-section {
            margin-top: 20px !important;
            gap: 15px !important;
        }

        .compact-mode .signature-section > div {
            font-size: 9px !important;
        }

        .compact-mode .signature-section img {
            max-height: 200px !important;
        }

        /* Page break pro kompaktn√≠ re≈æim */
        .compact-mode .page-break-section {
            page-break-before: always;
            break-before: page;
        }

        /* Mobiln√≠ re≈æim */
        .mobile-mode {
            font-size: 14px !important;
        }

        .mobile-mode .container {
            max-width: 100% !important;
            margin: 0 !important;
            border-radius: 0 !important;
            box-shadow: none !important;
        }

        .mobile-mode .calculator {
            padding: 15px !important;
        }

        .mobile-mode .calculator h1 {
            font-size: 1.4rem !important;
            margin-bottom: 15px !important;
        }

        .mobile-mode .form-row {
            grid-template-columns: 1fr !important;
            gap: 10px !important;
        }

        .mobile-mode .form-group {
            margin-bottom: 10px !important;
        }

        .mobile-mode .form-group input,
        .mobile-mode .form-group select,
        .mobile-mode .form-group textarea {
            padding: 12px !important;
            font-size: 16px !important; /* Zabr√°n√≠ zoomu na iOS */
            border-radius: 6px !important;
        }

        .mobile-mode .btn {
            padding: 15px 20px !important;
            font-size: 16px !important;
            margin: 8px 4px !important;
            border-radius: 8px !important;
            min-height: 48px !important; /* Doporuƒçen√° velikost pro dotyk */
        }

        .mobile-mode .button-row {
            display: flex !important;
            flex-wrap: wrap !important;
            justify-content: center !important;
            gap: 8px !important;
        }

        .mobile-mode .receipts-section {
            padding: 15px !important;
            margin-bottom: 15px !important;
        }

        .mobile-mode .receipt-item {
            padding: 12px !important;
            flex-direction: column !important;
            align-items: flex-start !important;
        }

        .mobile-mode .receipt-info {
            margin-bottom: 8px !important;
        }

        .mobile-mode .receipt-amount {
            margin-left: 0 !important;
            font-size: 16px !important;
        }

        .mobile-mode .add-receipt-row {
            grid-template-columns: 1fr !important;
            gap: 8px !important;
        }

        .mobile-mode .saved-trips {
            padding: 15px !important;
        }

        .mobile-mode .saved-trip {
            padding: 12px !important;
        }

        .mobile-mode .trip-info {
            flex-direction: column !important;
            align-items: flex-start !important;
        }

        .mobile-mode .trip-info > div:last-child {
            margin-top: 8px !important;
            display: flex !important;
            gap: 8px !important;
        }

        .mobile-mode .form-document {
            padding: 10px !important;
        }

        .mobile-mode .form-section {
            padding: 10px !important;
            margin-bottom: 10px !important;
        }

        .mobile-mode .form-line {
            font-size: 12px !important;
            margin-bottom: 5px !important;
        }

        .mobile-mode .table {
            font-size: 10px !important;
        }

        .mobile-mode .table th,
        .mobile-mode .table td {
            padding: 4px !important;
            font-size: 10px !important;
        }

        .mobile-mode .signature-section {
            grid-template-columns: 1fr !important;
            gap: 15px !important;
            margin-top: 20px !important;
        }

        /* Skryt√≠ nƒõkter√Ωch element≈Ø v mobiln√≠m re≈æimu */
        .mobile-mode .btn-small {
            padding: 8px 12px !important;
            font-size: 14px !important;
        }

        /* Optimalizace pro velmi mal√© obrazovky */
        @media (max-width: 480px) {
            .mobile-mode .calculator h1 {
                font-size: 1.2rem !important;
            }
            
            .mobile-mode .btn {
                padding: 12px 16px !important;
                font-size: 14px !important;
            }
            
            .mobile-mode .button-row {
                flex-direction: column !important;
            }
            
            .mobile-mode .button-row .btn {
                width: 100% !important;
                margin: 4px 0 !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Kalkulaƒçka pro vstup dat -->
        <div class="calculator" id="calculator">
            <h1>üßÆ Kalkulaƒçka cestovn√≠ho formul√°≈ôe</h1>
            
            <form id="travelForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Jm√©no zamƒõstnance:</label>
                        <input type="text" id="employeeName" placeholder="Bc. Zdenƒõk ≈†i≈°ka">
                    </div>
                    <div class="form-group">
                        <label>Bydli≈°tƒõ:</label>
                        <input type="text" id="residence" placeholder="Havl√≠ƒçkova 1383, 334 41 Dob≈ôany">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Zamƒõstnavatel:</label>
                        <input type="text" id="employer" placeholder="DMDsoft s.r.o.">
                    </div>
                    <div class="form-group">
                        <label>Iƒå zamƒõstnavatele:</label>
                        <input type="text" id="employerIC" placeholder="03393356">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Cesta do:</label>
                        <input type="text" id="destination" placeholder="≈Ωilina, Pova≈æsk√° Bystrica - SK">
                    </div>
                    <div class="form-group">
                        <label>√öƒçel cesty:</label>
                        <input type="text" id="purpose" placeholder="Pracovn√≠ jedn√°n√≠">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Datum zaƒç√°tku cesty:</label>
                        <input type="date" id="startDate" required>
                    </div>
                    <div class="form-group">
                        <label>Datum konce cesty:</label>
                        <input type="date" id="endDate" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ƒåas odjezdu:</label>
                        <input type="time" id="departureTime" value="04:00">
                    </div>
                    <div class="form-group">
                        <label>ƒåas p≈ô√≠jezdu:</label>
                        <input type="time" id="arrivalTime" value="23:15">
                    </div>
                </div>

                <!-- Sekce doklad≈Ø -->
                <div class="receipts-section">
                    <h3>üìÑ Doklady o v√Ωdaj√≠ch</h3>
                    
                    <div class="add-receipt-form">
                        <div class="add-receipt-row">
                            <div>
                                <label>Popis v√Ωdaje:</label>
                                <input type="text" id="receiptDescription" placeholder="nap≈ô. Ubytov√°n√≠ Hotel Zlat√Ω B√Ωk">
                            </div>
                            <div>
                                <label>ƒå√°stka (EUR):</label>
                                <input type="number" id="receiptAmount" step="0.01" placeholder="0.00">
                            </div>
                            <div>
                                <label>Typ:</label>
                                <select id="receiptType">
                                    <option value="ubytov√°n√≠">Ubytov√°n√≠</option>
                                    <option value="tankov√°n√≠">Tankov√°n√≠</option>
                                    <option value="parkovn√©">Parkovn√©</option>
                                    <option value="m√Ωto">M√Ωto</option>
                                    <option value="ostatn√≠">Ostatn√≠ v√Ωdaje</option>
                                </select>
                            </div>
                            <div>
                                <button type="button" class="btn btn-small" onclick="addReceipt()">‚ûï P≈ôidat</button>
                            </div>
                        </div>
                    </div>

                    <div id="receiptsList"></div>

                    <div class="receipt-summary" id="receiptsSummary" style="display:none;">
                        <h4>üìä Shrnut√≠ v√Ωdaj≈Ø</h4>
                        <div id="receiptsBreakdown"></div>
                    </div>
                </div>

                <!-- Sekce pro nahr√°n√≠ podpis≈Ø -->
                <div class="signatures-section" style="background: rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: white;">‚úçÔ∏è Podpisy</h3>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <!-- Podpis zamƒõstnance -->
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Podpis zamƒõstnance:</label>
                            <input type="file" id="employeeSignatureFile" accept="image/*" onchange="loadSignature('employee', this)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <div style="display: flex; gap: 10px; margin-top: 5px;">
                                <button type="button" class="btn btn-small" onclick="clearSignature('employee')">üóëÔ∏è Smazat</button>
                                <input type="number" id="employeeSignatureSize" min="50" max="300" value="100" onchange="updateSignatureSize('employee')" style="width: 80px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;" title="Velikost v %">
                                <span style="color: rgba(255, 255, 255, 0.8); font-size: 12px; align-self: center;">%</span>
                            </div>
                        </div>
                        
                        <!-- Podpis odpovƒõdn√©ho pracovn√≠ka -->
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Podpis odpovƒõdn√©ho pracovn√≠ka:</label>
                            <input type="file" id="supervisorSignatureFile" accept="image/*" onchange="loadSignature('supervisor', this)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <div style="display: flex; gap: 10px; margin-top: 5px;">
                                <button type="button" class="btn btn-small" onclick="clearSignature('supervisor')">üóëÔ∏è Smazat</button>
                                <input type="number" id="supervisorSignatureSize" min="50" max="300" value="200" onchange="updateSignatureSize('supervisor')" style="width: 80px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;" title="Velikost v %">
                                <span style="color: rgba(255, 255, 255, 0.8); font-size: 12px; align-self: center;">%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sekce pro p≈ôipojen√≠ PDF dokladu -->
                <div class="pdf-attachment-section" style="background: rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: white;">üìé P≈ôipojit PDF doklad</h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Vybrat PDF soubor:</label>
                            <input type="file" id="pdfAttachmentFile" accept=".pdf" onchange="loadPDFAttachment(this)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <div style="display: flex; gap: 10px; margin-top: 5px;">
                                <button type="button" class="btn btn-small" onclick="clearPDFAttachment()">üóëÔ∏è Odstranit</button>
                                <span id="pdfAttachmentInfo" style="color: rgba(255, 255, 255, 0.8); font-size: 12px; align-self: center;"></span>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.8);">
                            üí° PDF doklad se p≈ôipoj√≠ na konec v√Ωsledn√©ho PDF jako dal≈°√≠ str√°nky<br>
                            üìå <strong>Pozn√°mka:</strong> PDF doklad bude oznaƒçen u konkr√©tn√≠ cesty v seznamu ulo≈æen√Ωch cest
                        </div>
                    </div>
                </div>

                <div class="button-row">
                    <button type="button" class="btn" onclick="calculateAndShowForm()">üìã Vytvo≈ôit formul√°≈ô</button>
                    <button type="button" class="btn btn-print" onclick="printForm()" id="printBtn" style="display:none">üñ®Ô∏è Vytisknout</button>
                    <button type="button" class="btn btn-pdf" onclick="exportToPDF()" id="pdfBtn" style="display:none">üìÑ Ulo≈æit PDF</button>
                    <button type="button" class="btn btn-pdf" onclick="emailPDF()" id="emailBtn" style="display:none">üìß Odeslat PDF</button>
                    <button type="button" class="btn btn-save" onclick="saveTrip()" id="saveBtn" style="display:none">üíæ Ulo≈æit cestu</button>
                    <button type="button" class="btn btn-save" onclick="saveAsNewTrip()" id="saveAsNewBtn" style="display:none">üìã Ulo≈æit jako novou cestu</button>
                    <button type="button" class="btn" onclick="toggleCompactMode()" id="compactBtn" style="display:none">üìè Kompaktn√≠ re≈æim</button>
                    <button type="button" class="btn" onclick="toggleMobileMode()" id="mobileBtn">üì± Mobiln√≠ re≈æim</button>
                    <button type="button" class="btn" onclick="resetDefaults()" title="Resetovat v√Ωchoz√≠ hodnoty na p≈Øvodn√≠">üîÑ Reset v√Ωchoz√≠ch</button>
                    <button type="button" class="btn" onclick="clearForm()">üóëÔ∏è Vymazat</button>
                </div>
            </form>
        </div>

        <!-- Ulo≈æen√© cesty -->
        <div class="saved-trips" id="savedTrips" style="display:none">
            <h3>üíæ Ulo≈æen√© cesty</h3>
            <div id="savedTripsList"></div>
            
            <!-- Celkov√Ω souƒçet -->
            <div class="total-summary" id="totalSummary" style="display:none">
                <h3>üìä Celkov√Ω souƒçet v≈°ech cest</h3>
                <div class="summary-stats">
                    <div class="stat-item">
                        <span class="stat-label">Poƒçet cest:</span>
                        <span class="stat-value" id="totalTrips">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Celkem dn≈Ø:</span>
                        <span class="stat-value" id="totalDays">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Celkem stravn√©:</span>
                        <span class="stat-value" id="totalAllowance">0.00 EUR</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Celkem v√Ωdaje:</span>
                        <span class="stat-value" id="totalReceipts">0.00 EUR</span>
                    </div>
                    <div class="stat-item total-item">
                        <span class="stat-label">CELKEM:</span>
                        <span class="stat-value" id="grandTotal">0.00 EUR</span>
                    </div>
                </div>
                <div class="summary-actions">
                    <button class="btn btn-export" onclick="exportSummary()">üìÑ Exportovat souƒçet</button>
                    <button class="btn btn-export" onclick="exportSummaryToPDF()">üìÑ Exportovat souƒçet do PDF</button>
                </div>
            </div>
        </div>

        <!-- Formul√°≈ô pro tisk -->
        <div class="form-document" id="formDocument">
            <div class="form-header">
                VY√öƒåTOV√ÅN√ç PRACOVN√ç CESTY V ZAHRANIƒå√ç
            </div>

            <div class="form-section">
                <div class="form-line">
                    <span><strong>Jm√©no zamƒõstnance:</strong> <span class="underline" id="printEmployeeName"></span></span>
                </div>
                <div class="form-line">
                    <span><strong>Bydli≈°tƒõ:</strong> <span class="underline" id="printResidence"></span></span>
                </div>
                <div class="form-line">
                    <span><strong>Zamƒõstnavatel:</strong> <span class="underline" id="printEmployer"></span></span>
                </div>
                <div class="form-line">
                    <span><strong>Cesta do:</strong> <span class="underline" id="printDestination"></span> <strong>vykon√°na ve dnech:</strong> <span class="underline" id="printDateRange"></span></span>
                </div>
                <div class="form-line">
                    <span><strong>Urƒçen√Ω dopravn√≠ prost≈ôedek:</strong> <span class="underline">AUS</span></span>
                </div>
            </div>

            <div class="form-section">
                <div class="form-line">
                    <span><strong>V√Ω≈°e p≈ôidƒõl≈Ø devizov√Ωch prost≈ôedk≈Ø podle p≈ôipojen√Ωch doklad≈Ø banky:</strong></span>
                </div>
                <div class="form-line">
                    <span>v ≈°ec√≠ch: .......... v hotovosti: <span class="underline">0,00</span></span>
                </div>
                <div class="form-line">
                    <span><strong>Celkem:</strong> .......... <strong>Kurs:</strong> ..........</span>
                </div>
                <div class="form-line">
                    <span><strong>V√Ω≈°e denn√≠ho stravn√©ho:</strong> <span class="underline">35,00 EUR</span> <strong>V√Ω≈°e kapesn√©ho:</strong> <span class="underline">14,00 EUR</span></span>
                </div>
                <div class="form-line">
                    <span><strong>Celodenn√≠ bezplatn√© stravov√°n√≠ poskytov√°no ve dnech:</strong> <span class="underline" id="printMealDates"></span></span>
                </div>
                <div class="form-line">
                    <span><strong>ƒå√°steƒçn√© bezplatn√© stravov√°n√≠ poskytov√°no:</strong> ano ‚òê ne ‚òí</span>
                </div>
            </div>

            <div class="form-section">
                <div class="form-line">
                    <strong>Devizov√Ω n√°rok:</strong>
                </div>
                
                <table class="table" id="dailyAllowanceTable">
                    <thead>
                        <tr>
                            <th>a) odlet/p≈ô√≠jezd ze zahraniƒç√≠</th>
                            <th>Hodina</th>
                            <th>tj.</th>
                            <th>% stravn√©/kapesn√©</th>
                            <th>n√°rok</th>
                        </tr>
                    </thead>
                    <tbody id="dailyAllowanceBody">
                    </tbody>
                </table>

                <div class="form-line">
                    <span><strong>Poƒç√°tek a ukonƒçen√≠ prac. v√Ωkonu:</strong></span>
                </div>
                <div class="form-line">
                    <span><strong>P≈ô√≠let (p≈ô√≠jezd ze zahraniƒç√≠):</strong></span>
                </div>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>Dne</th>
                            <th>Hodina</th>
                            <th>tj.</th>
                            <th>% stravn√©/kapesn√©</th>
                            <th>n√°rok</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td id="returnDate"></td>
                            <td id="returnTime"></td>
                            <td id="returnHours">40,0</td>
                            <td>% stravn√©/kapesn√©</td>
                            <td id="totalAllowance"></td>
                        </tr>
                    </tbody>
                </table>

                <div class="form-line">
                    <span><strong>b) v√Ωdaje na ubytov√°n√≠:</strong> <span id="accommodationReceipts">doklad ƒç. .........................</span></span>
                </div>
                <div class="form-line">
                    <span><strong>c) nutn√© vedlej≈°√≠ v√Ωdaje:</strong> <span id="otherReceipts">doklad ƒç. .........................</span></span>
                </div>
                <div class="form-line" id="additionalReceiptsLine" style="display:none;">
                    <span><strong>Dal≈°√≠ v√Ωdaje:</strong> <span id="additionalReceipts"></span></span>
                </div>
                <div class="form-line">
                    <span><strong>√∫hrnem n√°rok:</strong> <span class="underline" id="totalEUR"></span></span>
                </div>
            </div>

            <div class="form-section">
                <div class="form-line">
                    <strong>Zji≈°tƒõn√≠ rozd√≠lu mezi p≈ôidƒõlen√Ωmi a vynalo≈æenlmi prost≈ôedky:</strong>
                </div>
                <div class="form-line">
                    <span>P≈ô√≠jem: .........................</span>
                </div>
                <div class="form-line">
                    <span>N√°rok: <span class="underline" id="finalClaim"></span></span>
                </div>
                <div class="form-line">
                    <span>Vr√°ceno: .........................</span>
                </div>
                <div class="form-line">
                    <span>Doplatek: <span class="underline" id="finalPayment"></span></span>
                </div>
                <div class="form-line">
                    <span><strong>Rozd√≠l (dosa≈æen√° devizov√° √∫spora, p≈ô√≠p. p≈ôeƒçerp√°n√≠):</strong></span>
                </div>
                <div class="form-line">
                    <span>Vr√°ceno bance prost≈ôednictv√≠m zahraniƒçn√≠ banky: .........................</span>
                </div>
                <div class="form-line">
                    <span>Vr√°ceno bance prost≈ôednictv√≠m zamƒõstnavatele: .........................</span>
                </div>
                <div class="form-line">
                    <span>doklad ƒç. ......................... doklad ƒç. .........................</span>
                </div>
                <div class="form-line">
                    <span>vr√°ceno celkem: .........................</span>
                </div>
            </div>

            <div class="form-section page-break-section">
                <div class="form-line">
                    <span>Nepou≈æit√© letenky, j√≠zdenky, lodn√≠ l√≠stky a vouchery (p≈ô√≠p. nedoƒçerpan√© vouchery) byly vr√°ceny dne: .........................</span>
                </div>
                <div class="form-line">
                    <span>Prohla≈°uji, ≈æe moje √∫daje jsou spr√°vn√© a √∫pln√©. Pokud se v dokladech o ubytov√°n√≠ vyskytuj√≠ sazby vƒçetnƒõ stravov√°n√≠ (Full board, pln√° pense), je tato skuteƒçnost na dokladech uvedena.</span>
                </div>
            </div>

            <!-- Podpisov√° sekce v jedn√© ≈ôadƒõ -->
            <div class="signature-section" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 20px; margin-top: 30px; text-align: center;">
                <div>
                    <div style="font-size: 10px; margin-bottom: 5px;">Dne</div>
                    <div id="signatureDate" style="font-size: 10px; margin-top: 10px;"></div>
                </div>
                <div>
                    <div style="font-size: 10px; margin-bottom: 5px;">Podpis zamƒõstnance</div>
                    <div id="employeeSignature" style="margin-top: 10px;">
                        <span style="font-size: 10px;">Podpis</span>
                    </div>
                </div>
                <div>
                    <div style="font-size: 10px; margin-bottom: 5px;">Podpis zamƒõstnance, kter√Ω upravil vy√∫ƒçtov√°n√≠</div>
                    <div style="margin-top: 10px;">
                        <!-- Pr√°zdn√© m√≠sto pro podpis -->
                    </div>
                </div>
                <div>
                    <div style="font-size: 10px; margin-bottom: 5px;">Podpis odpovƒõdn√©ho pracovn√≠ka</div>
                    <div id="supervisorSignature" style="margin-top: 10px;">
                        <span style="font-size: 10px;">Podpis</span>
                    </div>
                </div>
            </div>

            <!-- PDF doklad sekce -->
            <div id="pdfAttachmentSection" style="margin-top: 30px; display: none;">
                <div class="form-section" style="border-top: 2px solid #333; padding-top: 15px;">
                    <div class="form-line" style="text-align: center;">
                        <span style="font-weight: bold; font-size: 12px;">üìé P≈òIPOJEN√ù PDF DOKLAD</span>
                    </div>
                    <div class="form-line" style="text-align: center; margin-top: 10px;">
                        <span id="pdfAttachmentDisplay" style="font-size: 11px; color: #27ae60; font-weight: bold;"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Modal -->
    <div id="emailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìß Odeslat PDF emailem</h3>
                <span class="close" onclick="closeEmailModal()">&times;</span>
            </div>
            <div style="background: #e8f4fd; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 12px; color: #2c3e50;">
                <strong>üí° Tip:</strong> Na mobiln√≠ch za≈ô√≠zen√≠ch pou≈æijte "üìß Odeslat" pro p≈ô√≠m√© sd√≠len√≠. Na poƒç√≠taƒçi pou≈æijte "üíæ Sta≈æen√≠ + Email" pro sta≈æen√≠ PDF a otev≈ôen√≠ email klienta.
            </div>
            <form class="email-form" id="emailForm">
                <div>
                    <label for="emailTo">P≈ô√≠jemce (email):</label>
                    <input type="email" id="emailTo" required placeholder="nap≈ô. zamestnanec@firma.cz">
                </div>
                <div>
                    <label for="emailSubject">P≈ôedmƒõt:</label>
                    <input type="text" id="emailSubject" placeholder="Vy√∫ƒçtov√°n√≠ pracovn√≠ cesty">
                </div>
                <div>
                    <label for="emailBody">Zpr√°va:</label>
                    <textarea id="emailBody" placeholder="Dobr√Ω den,

zas√≠l√°m vy√∫ƒçtov√°n√≠ pracovn√≠ cesty.

S pozdravem"></textarea>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn" onclick="closeEmailModal()">‚ùå Zru≈°it</button>
                    <button type="button" class="btn btn-pdf" onclick="sendEmail()">üìß Odeslat</button>
                    <button type="button" class="btn btn-save" onclick="downloadAndEmail()">üíæ Sta≈æen√≠ + Email</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const EUR_TO_CZK = 25.20;
        let savedTrips = JSON.parse(localStorage.getItem('savedTrips') || '[]');
        let receipts = [];
        let currentEditingTripId = null;
        
        // V√Ωchoz√≠ hodnoty - naƒçtou se z localStorage nebo pou≈æij√≠ defaultn√≠
        let defaultValues = {
            employeeName: 'Bc. Zdenƒõk ≈†i≈°ka',
            residence: 'Havl√≠ƒçkova 1383, 334 41 Dob≈ôany',
            destination: '≈Ωilina, Pova≈æsk√° Bystrica - SK'
        };

        // Ulo≈æen√© podpisy
        let signatures = {
            employee: null,
            supervisor: null
        };

        // Objekt pro ukl√°d√°n√≠ velikost√≠ podpis≈Ø
        let signatureSizes = {
            employee: 100,
            supervisor: 200
        };

        // PDF p≈ô√≠loha
        let pdfAttachment = null;

        // Naƒçten√≠ v√Ωchoz√≠ch hodnot z localStorage
        function loadDefaultValues() {
            const savedDefaults = localStorage.getItem('defaultValues');
            if (savedDefaults) {
                defaultValues = { ...defaultValues, ...JSON.parse(savedDefaults) };
            }
        }

        // Ulo≈æen√≠ v√Ωchoz√≠ch hodnot do localStorage
        function saveDefaultValues() {
            localStorage.setItem('defaultValues', JSON.stringify(defaultValues));
        }

        // Aktualizace v√Ωchoz√≠ch hodnot na z√°kladƒõ aktu√°ln√≠ch hodnot v formul√°≈ôi
        function updateDefaultValues() {
            const employeeName = document.getElementById('employeeName').value.trim();
            const residence = document.getElementById('residence').value.trim();
            const destination = document.getElementById('destination').value.trim();

            if (employeeName) {
                defaultValues.employeeName = employeeName;
            }
            if (residence) {
                defaultValues.residence = residence;
            }
            if (destination) {
                defaultValues.destination = destination;
            }

            saveDefaultValues();
        }

        // V√Ωpoƒçet data vystaven√≠ (3 dny po konci cesty)
        function calculateIssueDate() {
            const endDate = document.getElementById('endDate').value;
            if (!endDate) return null;
            
            const endDateObj = new Date(endDate);
            const issueDate = new Date(endDateObj);
            issueDate.setDate(endDateObj.getDate() + 3);
            
            return issueDate.toISOString().split('T')[0];
        }

        // Aktualizace data vystaven√≠ v formul√°≈ôi
        function updateIssueDate() {
            const issueDate = calculateIssueDate();
            if (issueDate) {
                const signatureDateElement = document.getElementById('signatureDate');
                if (signatureDateElement) {
                    signatureDateElement.textContent = formatDate(issueDate);
                }
            }
        }

        // Naƒçten√≠ podpisu z souboru
        function loadSignature(type, input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                signatures[type] = e.target.result;
                updateSignatureInForm(type);
                saveSignatures();
            };
            reader.readAsDataURL(file);
        }

        // Smaz√°n√≠ podpisu
        function clearSignature(type) {
            signatures[type] = null;
            updateSignatureInForm(type);
            saveSignatures();
            
            // Vyma≈æeme input
            const input = document.getElementById(type + 'SignatureFile');
            if (input) {
                input.value = '';
            }
        }

        // Aktualizace podpisu v formul√°≈ôi
        function updateSignatureInForm(type) {
            const signatureElement = document.getElementById(type + 'Signature');
            if (!signatureElement) return;

            if (signatures[type]) {
                const size = signatureSizes[type] || 100;
                const maxHeight = Math.round(60 * (size / 100)); // Base height 60px
                signatureElement.innerHTML = `<img src="${signatures[type]}" style="max-width: 100%; max-height: ${maxHeight}px; object-fit: contain;" alt="Podpis">`;
            } else {
                signatureElement.innerHTML = '<span style="font-size: 10px;">Podpis</span>';
            }
        }

        // Aktualizace velikosti podpisu
        function updateSignatureSize(type) {
            const sizeInput = document.getElementById(type + 'SignatureSize');
            if (sizeInput) {
                signatureSizes[type] = parseInt(sizeInput.value) || 100;
                updateSignatureInForm(type);
                saveSignatureSizes();
            }
        }

        // Ulo≈æen√≠ podpis≈Ø do localStorage
        function saveSignatures() {
            localStorage.setItem('signatures', JSON.stringify(signatures));
        }

        // Ulo≈æen√≠ velikost√≠ podpis≈Ø do localStorage
        function saveSignatureSizes() {
            localStorage.setItem('signatureSizes', JSON.stringify(signatureSizes));
        }

        // Naƒçten√≠ podpis≈Ø z localStorage
        function loadSignatures() {
            const savedSignatures = localStorage.getItem('signatures');
            if (savedSignatures) {
                signatures = { ...signatures, ...JSON.parse(savedSignatures) };
            }
            
            // Naƒçteme velikosti podpis≈Ø
            const savedSizes = localStorage.getItem('signatureSizes');
            if (savedSizes) {
                signatureSizes = { ...signatureSizes, ...JSON.parse(savedSizes) };
            }
            
            // Aktualizujeme inputy pro velikost
            if (signatureSizes.employee) {
                const employeeSizeInput = document.getElementById('employeeSignatureSize');
                if (employeeSizeInput) employeeSizeInput.value = signatureSizes.employee;
            }
            if (signatureSizes.supervisor) {
                const supervisorSizeInput = document.getElementById('supervisorSignatureSize');
                if (supervisorSizeInput) supervisorSizeInput.value = signatureSizes.supervisor;
            }
            
            // V≈ædy aktualizujeme oba podpisy
            updateSignatureInForm('employee');
            updateSignatureInForm('supervisor');
        }

        // Naƒçten√≠ PDF p≈ô√≠lohy
        function loadPDFAttachment(input) {
            const file = input.files[0];
            if (!file) return;

            if (file.type !== 'application/pdf') {
                alert('Pros√≠m vyberte pouze PDF soubory.');
                input.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                pdfAttachment = {
                    name: file.name,
                    data: e.target.result,
                    size: file.size
                };
                updatePDFAttachmentInfo();
                savePDFAttachment();
            };
            reader.readAsDataURL(file);
        }

        // Smaz√°n√≠ PDF p≈ô√≠lohy
        function clearPDFAttachment() {
            pdfAttachment = null;
            updatePDFAttachmentInfo();
            savePDFAttachment();
            
            // Vyma≈æeme input
            const input = document.getElementById('pdfAttachmentFile');
            if (input) {
                input.value = '';
            }
        }

        // Aktualizace informac√≠ o PDF p≈ô√≠loze
        function updatePDFAttachmentInfo() {
            const infoElement = document.getElementById('pdfAttachmentInfo');
            const displayElement = document.getElementById('pdfAttachmentDisplay');
            const sectionElement = document.getElementById('pdfAttachmentSection');

            if (pdfAttachment) {
                const sizeKB = Math.round(pdfAttachment.size / 1024);
                const infoText = `P≈ôipojeno: ${pdfAttachment.name} (${sizeKB} KB)`;
                
                // Aktualizujeme informace v kalkulaƒçce
                if (infoElement) {
                    infoElement.textContent = infoText;
                    infoElement.style.color = 'rgba(46, 204, 113, 0.9)'; // Zelen√° barva
                }
                
                // Aktualizujeme zobrazen√≠ v formul√°≈ôi
                if (displayElement) {
                    displayElement.textContent = infoText;
                }
                
                // Zobraz√≠me sekci v formul√°≈ôi
                if (sectionElement) {
                    sectionElement.style.display = 'block';
                }
            } else {
                // Skryjeme informace
                if (infoElement) {
                    infoElement.textContent = '';
                }
                
                if (displayElement) {
                    displayElement.textContent = '';
                }
                
                if (sectionElement) {
                    sectionElement.style.display = 'none';
                }
            }
        }

        // Ulo≈æen√≠ PDF p≈ô√≠lohy do localStorage
        function savePDFAttachment() {
            if (pdfAttachment) {
                localStorage.setItem('pdfAttachment', JSON.stringify(pdfAttachment));
            } else {
                localStorage.removeItem('pdfAttachment');
            }
        }

        // Naƒçten√≠ PDF p≈ô√≠lohy z localStorage
        function loadPDFAttachmentFromStorage() {
            const savedAttachment = localStorage.getItem('pdfAttachment');
            if (savedAttachment) {
                pdfAttachment = JSON.parse(savedAttachment);
                updatePDFAttachmentInfo();
            }
        }

        // Naƒçten√≠ PDF z data URL pomoc√≠ PDF.js
        async function loadPDFFromDataURL(dataURL) {
            if (!window.pdfjsLib) {
                throw new Error('PDF.js knihovna nen√≠ k dispozici');
            }
            
            try {
                // Konvertujeme data URL na Uint8Array
                const base64 = dataURL.split(',')[1];
                const binaryString = atob(base64);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                // Naƒçteme PDF
                const pdf = await pdfjsLib.getDocument({ data: bytes }).promise;
                return pdf;
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ PDF:', error);
                throw new Error(`Nepoda≈ôilo se naƒç√≠st PDF: ${error.message}`);
            }
        }

        // Alternativn√≠ metoda pro p≈ôipojen√≠ PDF (pokud PDF.js nefunguje)
        async function addPDFAttachmentAlternative(pdf) {
            if (!pdfAttachment) return;
            
            try {
                // Vytvo≈ô√≠me iframe pro zobrazen√≠ PDF
                const iframe = document.createElement('iframe');
                iframe.src = pdfAttachment.data;
                iframe.style.width = '100%';
                iframe.style.height = '800px';
                iframe.style.border = 'none';
                
                // P≈ôid√°me str√°nku s informac√≠ o p≈ô√≠loze
                pdf.addPage();
                pdf.setFontSize(12);
                pdf.text('P≈òIPOJEN√ù PDF DOKLAD', 105, 20, { align: 'center' });
                pdf.text(`N√°zev: ${pdfAttachment.name}`, 20, 40);
                pdf.text(`Velikost: ${Math.round(pdfAttachment.size / 1024)} KB`, 20, 50);
                pdf.text('Pozn√°mka: PDF doklad je p≈ôipojen jako samostatn√Ω soubor', 20, 70);
                pdf.text('a bude odesl√°n spolu s t√≠mto dokumentem.', 20, 80);
                
                console.log('Alternativn√≠ p≈ôipojen√≠ PDF dokladu dokonƒçeno');
            } catch (error) {
                console.error('Chyba p≈ôi alternativn√≠m p≈ôipojov√°n√≠ PDF:', error);
            }
        }

        function addReceipt() {
            const description = document.getElementById('receiptDescription').value;
            const amount = parseFloat(document.getElementById('receiptAmount').value);
            const type = document.getElementById('receiptType').value;

            if (!description || !amount || amount <= 0) {
                alert('Pros√≠m vypl≈àte popis a platnou ƒç√°stku.');
                return;
            }

            const receipt = {
                id: Date.now(),
                description: description,
                amount: amount,
                type: type
            };

            receipts.push(receipt);
            updateReceiptsList();
            updateReceiptsSummary();

            // Vymaz√°n√≠ formul√°≈ôe
            document.getElementById('receiptDescription').value = '';
            document.getElementById('receiptAmount').value = '';
        }

        function removeReceipt(receiptId) {
            receipts = receipts.filter(r => r.id !== receiptId);
            updateReceiptsList();
            updateReceiptsSummary();
        }

        function updateReceiptsList() {
            const container = document.getElementById('receiptsList');
            container.innerHTML = '';

            receipts.forEach(receipt => {
                const item = document.createElement('div');
                item.className = 'receipt-item';
                item.innerHTML = `
                    <div class="receipt-info">
                        <strong>${receipt.description}</strong><br>
                        <small>Typ: ${receipt.type}</small>
                    </div>
                    <div class="receipt-amount">${receipt.amount.toFixed(2)} EUR</div>
                    <button class="btn btn-small btn-danger" onclick="removeReceipt(${receipt.id})">üóëÔ∏è</button>
                `;
                container.appendChild(item);
            });
        }

        function updateReceiptsSummary() {
            const summary = document.getElementById('receiptsSummary');
            const breakdown = document.getElementById('receiptsBreakdown');

            if (receipts.length === 0) {
                summary.style.display = 'none';
                return;
            }

            summary.style.display = 'block';

            // Seskupen√≠ podle typu
            const grouped = receipts.reduce((acc, receipt) => {
                if (!acc[receipt.type]) acc[receipt.type] = 0;
                acc[receipt.type] += receipt.amount;
                return acc;
            }, {});

            const total = receipts.reduce((sum, r) => sum + r.amount, 0);

            let html = '';
            Object.entries(grouped).forEach(([type, amount]) => {
                html += `<div class="receipt-line"><span>${type}:</span><span>${amount.toFixed(2)} EUR</span></div>`;
            });
            html += `<div class="receipt-line"><span>Celkem v√Ωdaje:</span><span>${total.toFixed(2)} EUR</span></div>`;

            breakdown.innerHTML = html;
        }

        function calculateDays(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('cs-CZ');
        }

        function formatDateRange(startDate, endDate) {
            return `${formatDate(startDate)} - ${formatDate(endDate)}`;
        }

        function calculateAndShowForm() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                alert('Pros√≠m vypl≈àte datum zaƒç√°tku a konce cesty.');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                alert('Datum zaƒç√°tku nem≈Ø≈æe b√Ωt pozdƒõji ne≈æ datum konce.');
                return;
            }

            const days = calculateDays(startDate, endDate);
            
            // V√Ωpoƒçet ƒç√°stek
            const stravne = 35.00;
            const kapesne = 14.00;
            const celkemDen = 49.00;
            const allowanceTotal = days * celkemDen;
            const receiptsTotal = receipts.reduce((sum, r) => sum + r.amount, 0);
            const grandTotal = allowanceTotal + receiptsTotal;

            // Vyplnƒõn√≠ z√°kladn√≠ch √∫daj≈Ø
            document.getElementById('printEmployeeName').textContent = document.getElementById('employeeName').value || defaultValues.employeeName;
            document.getElementById('printResidence').textContent = document.getElementById('residence').value || defaultValues.residence;
            document.getElementById('printEmployer').textContent = document.getElementById('employer').value || 'DMDsoft s.r.o.';
            document.getElementById('printDestination').textContent = document.getElementById('destination').value || defaultValues.destination;
            document.getElementById('printDateRange').textContent = formatDateRange(startDate, endDate);
            document.getElementById('printMealDates').textContent = formatDateRange(startDate, endDate);

            // Vyplnƒõn√≠ tabulky denn√≠ch p≈ô√≠spƒõvk≈Ø
            const tableBody = document.getElementById('dailyAllowanceBody');
            tableBody.innerHTML = '';

            let currentDate = new Date(startDate);
            const endDateObj = new Date(endDate);

            while (currentDate <= endDateObj) {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>od ${formatDate(currentDate.toISOString().split('T')[0])} do</td>
                    <td></td>
                    <td>√°</td>
                    <td>${stravne.toFixed(2)} str/kap</td>
                    <td>${celkemDen.toFixed(2)}</td>
                `;
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Vyplnƒõn√≠ doklad≈Ø
            updateReceiptsInForm();

            // Vyplnƒõn√≠ z√°vƒõreƒçn√Ωch √∫daj≈Ø
            document.getElementById('returnDate').textContent = formatDate(endDate);
            document.getElementById('returnTime').textContent = document.getElementById('arrivalTime').value || '23:15';
            document.getElementById('totalAllowance').textContent = `${allowanceTotal.toFixed(2)}`;
            document.getElementById('totalEUR').textContent = `${grandTotal.toFixed(2)} EUR`;
            document.getElementById('finalClaim').textContent = `${grandTotal.toFixed(2)} EUR`;
            document.getElementById('finalPayment').textContent = `${grandTotal.toFixed(2)} EUR`;
            
            // Nastav√≠me datum vystaven√≠ (3 dny po konci cesty)
            updateIssueDate();

            // Aktualizujeme zobrazen√≠ PDF dokladu
            updatePDFAttachmentInfo();

            // Zobrazen√≠ formul√°≈ôe a tlaƒç√≠tek
            document.getElementById('formDocument').classList.add('show');
            document.getElementById('printBtn').style.display = 'inline-block';
            document.getElementById('pdfBtn').style.display = 'inline-block';
            document.getElementById('emailBtn').style.display = 'inline-block';
            document.getElementById('saveBtn').style.display = 'inline-block';
            document.getElementById('compactBtn').style.display = 'inline-block';
            
            // Aktualizujeme text tlaƒç√≠tka podle toho, zda editujeme nebo vytv√°≈ô√≠me novou cestu
            updateSaveButtonText();

            // P≈ôesun na formul√°≈ô
            document.getElementById('formDocument').scrollIntoView({ behavior: 'smooth' });
        }

        function updateReceiptsInForm() {
            const accommodationReceipts = receipts.filter(r => r.type === 'ubytov√°n√≠');
            const otherReceipts = receipts.filter(r => r.type !== 'ubytov√°n√≠');

            // Ubytov√°n√≠
            const accommodationElement = document.getElementById('accommodationReceipts');
            if (accommodationReceipts.length > 0) {
                const accommodationText = accommodationReceipts.map((r, index) => 
                    `doklad ƒç. ${index + 1} (${r.description} - ${r.amount.toFixed(2)} EUR)`
                ).join(', ');
                accommodationElement.textContent = accommodationText;
            } else {
                accommodationElement.textContent = 'doklad ƒç. .........................';
            }

            // Ostatn√≠ v√Ωdaje
            const otherElement = document.getElementById('otherReceipts');
            if (otherReceipts.length > 0) {
                const otherText = otherReceipts.map((r, index) => 
                    `doklad ƒç. ${accommodationReceipts.length + index + 1} (${r.description} - ${r.amount.toFixed(2)} EUR)`
                ).join(', ');
                otherElement.textContent = otherText;
            } else {
                otherElement.textContent = 'doklad ƒç. .........................';
            }

            // Zobrazen√≠ dodateƒçn√© ≈ô√°dky pokud je v√≠ce doklad≈Ø
            const additionalLine = document.getElementById('additionalReceiptsLine');
            const additionalElement = document.getElementById('additionalReceipts');
            
            if (receipts.length > 4) {
                const additionalReceipts = receipts.slice(4);
                const additionalText = additionalReceipts.map((r, index) => 
                    `doklad ƒç. ${5 + index} (${r.description} - ${r.amount.toFixed(2)} EUR)`
                ).join(', ');
                additionalElement.textContent = additionalText;
                additionalLine.style.display = 'block';
            } else {
                additionalLine.style.display = 'none';
            }
        }

        function printForm() {
            // Ujist√≠me se, ≈æe je formul√°≈ô viditeln√Ω pro tisk
            const formDocument = document.getElementById('formDocument');
            const calculator = document.getElementById('calculator');
            const savedTrips = document.getElementById('savedTrips');
            
            // Doƒçasnƒõ skryjeme ostatn√≠ sekce
            calculator.style.display = 'none';
            savedTrips.style.display = 'none';
            formDocument.style.display = 'block';
            
            // Tisk
            window.print();
            
            // Vr√°t√≠me p≈Øvodn√≠ zobrazen√≠
            setTimeout(() => {
                calculator.style.display = 'block';
                if (savedTrips.children.length > 1) {
                    savedTrips.style.display = 'block';
                }
            }, 100);
        }

        // Funkce pro konverzi obr√°zk≈Ø na data URL
        async function convertImagesToDataURL(element) {
            const images = element.querySelectorAll('img');
            for (let img of images) {
                if (img.src && !img.src.startsWith('data:')) {
                    try {
                        // Pro lok√°ln√≠ soubory (podpis2.jpg) pou≈æijeme fetch s mode: 'no-cors'
                        const response = await fetch(img.src, { mode: 'no-cors' });
                        if (response.type === 'opaque') {
                            // Pokud je response opaque, pou≈æijeme FileReader
                            const fileResponse = await fetch(img.src);
                            const blob = await fileResponse.blob();
                            const reader = new FileReader();
                            img.src = await new Promise((resolve) => {
                                reader.onload = () => resolve(reader.result);
                                reader.readAsDataURL(blob);
                            });
                        } else {
                            const blob = await response.blob();
                            const reader = new FileReader();
                            img.src = await new Promise((resolve) => {
                                reader.onload = () => resolve(reader.result);
                                reader.readAsDataURL(blob);
                            });
                        }
                    } catch (error) {
                        console.warn('Nepoda≈ôilo se konvertovat obr√°zek:', img.src, error);
                        // Pokud se nepoda≈ô√≠ konvertovat, nech√°me obr√°zek b√Ωt
                        // Nepokou≈°√≠me se ho skr√Ωt
                    }
                }
            }
        }

        async function exportToPDF() {
            // Kontrola dostupnosti knihoven
            if (!window.jspdf) {
                alert('Chyba: PDF knihovna (jsPDF) se nenaƒçetla. Zkontrolujte internetov√© p≈ôipojen√≠.');
                return;
            }
            
            if (!window.html2canvas) {
                alert('Chyba: Canvas knihovna (html2canvas) se nenaƒçetla. Zkontrolujte internetov√© p≈ôipojen√≠.');
                return;
            }

            const { jsPDF } = window.jspdf;
            
            // Kontrola, zda je formul√°≈ô zobrazen
            const formDocument = document.getElementById('formDocument');
            if (!formDocument || !formDocument.classList.contains('show')) {
                alert('Chyba: Formul√°≈ô nen√≠ zobrazen. Nejd≈ô√≠ve vytvo≈ôte formul√°≈ô.');
                return;
            }

            // Zobraz√≠me loading zpr√°vu
            const originalContent = document.getElementById('formDocument').innerHTML;
            document.getElementById('formDocument').innerHTML = '<div class="loading">üìÑ Generuji PDF...</div>';

            try {

                // Kr√°tk√© zpo≈ædƒõn√≠ pro zobrazen√≠ loading zpr√°vy
                await new Promise(resolve => setTimeout(resolve, 100));

                // Vr√°t√≠me p≈Øvodn√≠ obsah
                document.getElementById('formDocument').innerHTML = originalContent;

                // Aktualizujeme formul√°≈ô
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (startDate && endDate) {
                    // Znovu vypln√≠me formul√°≈ô s aktu√°ln√≠mi daty
                    updateFormForPDF();
                }

                // P≈ôevedeme obr√°zky na data URL pro zabr√°nƒõn√≠ tainted canvas
                await convertImagesToDataURL(formDocument);

                // Zapneme kompaktn√≠ re≈æim pro PDF
                const wasCompact = formDocument.classList.contains('compact-mode');
                if (!wasCompact) {
                    formDocument.classList.add('compact-mode');
                }

                // Vytvo≈ô√≠me canvas z formul√°≈ôe s optimalizovan√Ωmi nastaven√≠mi
                let canvas;
                try {
                    canvas = await html2canvas(formDocument, {
                        scale: 1.2, // Sn√≠≈æen√© ≈°k√°lov√°n√≠ pro men≈°√≠ velikost
                        useCORS: false, // Vypneme CORS pro lok√°ln√≠ soubory
                        allowTaint: false, // Vypneme allowTaint - kl√≠ƒçov√© pro ≈ôe≈°en√≠ tainted canvas
                        backgroundColor: '#ffffff',
                        width: formDocument.scrollWidth,
                        height: formDocument.scrollHeight,
                        logging: false, // Vypneme logging pro rychlej≈°√≠ generov√°n√≠
                        removeContainer: false, // Vypneme removeContainer
                        foreignObjectRendering: false, // Vypneme foreignObjectRendering
                        ignoreElements: function(element) {
                            // Ignorujeme pouze obr√°zky, kter√© nejsou data URL
                            return element.tagName === 'IMG' && element.src && !element.src.startsWith('data:');
                        }
                    });
                } catch (canvasError) {
                    console.error('Chyba p≈ôi vytv√°≈ôen√≠ canvas:', canvasError);
                    // Zkus√≠me jednodu≈°≈°√≠ nastaven√≠ bez obr√°zk≈Ø
                    canvas = await html2canvas(formDocument, {
                        scale: 1,
                        backgroundColor: '#ffffff',
                        logging: false,
                        allowTaint: false,
                        useCORS: false,
                        ignoreElements: function(element) {
                            // Ignorujeme pouze obr√°zky, kter√© nejsou data URL
                            return element.tagName === 'IMG' && element.src && !element.src.startsWith('data:');
                        }
                    });
                }

                // Kontrola, zda se canvas vytvo≈ôil spr√°vnƒõ
                if (!canvas || canvas.width === 0 || canvas.height === 0) {
                    throw new Error('Canvas se nevytvo≈ôil spr√°vnƒõ - ≈°√≠≈ôka nebo v√Ω≈°ka je 0');
                }

                // Vytvo≈ô√≠me PDF s optimalizovan√Ωmi rozmƒõry
                const imgData = canvas.toDataURL('image/jpeg', 0.8); // JPEG s kompres√≠
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const imgWidth = 200; // Men≈°√≠ ≈°√≠≈ôka pro lep≈°√≠ fit
                const pageHeight = 285; // Men≈°√≠ v√Ω≈°ka pro okraje
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 5; // Okraj naho≈ôe

                // P≈ôid√°me prvn√≠ str√°nku
                pdf.addImage(imgData, 'JPEG', 5, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                // P≈ôid√°me dal≈°√≠ str√°nky pokud je pot≈ôeba
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight + 5;
                    pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', 5, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                // Vr√°t√≠me p≈Øvodn√≠ re≈æim pokud nebyl kompaktn√≠
                if (!wasCompact) {
                    formDocument.classList.remove('compact-mode');
                }

                // P≈ôipoj√≠me PDF p≈ô√≠lohu pokud existuje
                if (pdfAttachment) {
                    try {
                        console.log('P≈ôipojuji PDF p≈ô√≠lohu:', pdfAttachment.name);
                        
                        // Kontrola dostupnosti PDF.js
                        if (!window.pdfjsLib) {
                            throw new Error('PDF.js knihovna nen√≠ k dispozici');
                        }
                        
                        // Naƒçteme PDF p≈ô√≠lohu
                        const attachmentPDF = await loadPDFFromDataURL(pdfAttachment.data);
                        console.log('PDF p≈ô√≠loha naƒçtena, poƒçet str√°nek:', attachmentPDF.getNumberOfPages());
                        
                        // P≈ôid√°me v≈°echny str√°nky z p≈ô√≠lohy
                        const totalPages = attachmentPDF.getNumberOfPages();
                        for (let i = 1; i <= totalPages; i++) {
                            console.log(`P≈ôid√°v√°m str√°nku ${i} z ${totalPages}`);
                            pdf.addPage();
                            const page = await attachmentPDF.getPage(i);
                            const viewport = page.getViewport({ scale: 1.5 }); // Zvƒõt≈°√≠me ≈°k√°lov√°n√≠ pro lep≈°√≠ kvalitu
                            
                            // P≈ôid√°me str√°nku jako obr√°zek
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.width = viewport.width;
                            canvas.height = viewport.height;
                            
                            const renderContext = {
                                canvasContext: context,
                                viewport: viewport
                            };
                            
                            await page.render(renderContext).promise;
                            const imgData = canvas.toDataURL('image/jpeg', 0.9); // Vy≈°≈°√≠ kvalita
                            
                            // P≈ôid√°me obr√°zek do PDF s lep≈°√≠m um√≠stƒõn√≠m
                            const imgWidth = 200;
                            const imgHeight = (canvas.height * imgWidth) / canvas.width;
                            pdf.addImage(imgData, 'JPEG', 5, 5, imgWidth, imgHeight);
                            console.log(`Str√°nka ${i} p≈ôid√°na do PDF`);
                        }
                        console.log('PDF p≈ô√≠loha √∫spƒõ≈°nƒõ p≈ôipojena');
                    } catch (error) {
                        console.error('Chyba p≈ôi p≈ôipojov√°n√≠ PDF p≈ô√≠lohy:', error);
                        console.log('Zkou≈°√≠m alternativn√≠ metodu...');
                        
                        // Zkus√≠me alternativn√≠ metodu
                        try {
                            await addPDFAttachmentAlternative(pdf);
                        } catch (altError) {
                            console.error('Alternativn√≠ metoda tak√© selhala:', altError);
                            alert(`Nepoda≈ôilo se p≈ôipojit PDF p≈ô√≠lohu: ${error.message}`);
                        }
                    }
                }

                // Ulo≈æ√≠me PDF
                const employeeName = document.getElementById('employeeName').value || 'zamestnanec';
                const destination = document.getElementById('destination').value || 'cesta';
                const fileName = `vyuctovani_${employeeName.replace(/\s+/g, '_')}_${destination.replace(/\s+/g, '_')}_${formatDate(new Date().toISOString().split('T')[0]).replace(/\./g, '')}.pdf`;
                
                pdf.save(fileName);

            } catch (error) {
                console.error('Chyba p≈ôi generov√°n√≠ PDF:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                
                // Vr√°t√≠me p≈Øvodn√≠ obsah pokud do≈°lo k chybƒõ
                if (originalContent) {
                    formDocument.innerHTML = originalContent;
                }
                
                // Vr√°t√≠me p≈Øvodn√≠ re≈æim
                if (formDocument.classList.contains('compact-mode')) {
                    formDocument.classList.remove('compact-mode');
                }
                
                // Zobraz√≠me detailn√≠ chybovou zpr√°vu
                let errorMessage = `Nepoda≈ôilo se vytvo≈ôit PDF.\n\nChyba: ${error.message}\n\n`;
                
                if (error.message.includes('html2canvas')) {
                    errorMessage += 'Probl√©m s konverz√≠ na obr√°zek. ';
                } else if (error.message.includes('jsPDF')) {
                    errorMessage += 'Probl√©m s vytvo≈ôen√≠m PDF. ';
                } else if (error.message.includes('canvas')) {
                    errorMessage += 'Probl√©m s canvas elementem. ';
                } else if (error.message.includes('Tainted')) {
                    errorMessage += 'Probl√©m s tainted canvas - obr√°zky z jin√©ho zdroje. ';
                } else if (error.message.includes('CORS')) {
                    errorMessage += 'Probl√©m s CORS politikou. ';
                } else if (error.message.includes('SecurityError')) {
                    errorMessage += 'Bezpeƒçnostn√≠ chyba prohl√≠≈æeƒçe. ';
                } else if (error.message.includes('toDataURL')) {
                    errorMessage += 'Probl√©m s exportem canvas dat. ';
                }
                
                errorMessage += '\nZkuste to pros√≠m znovu nebo pou≈æijte funkci tisku.';
                alert(errorMessage);
            }
        }

        function updateFormForPDF() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) return;

            const days = calculateDays(startDate, endDate);
            const allowanceTotal = days * 49.00;
            const receiptsTotal = receipts.reduce((sum, r) => sum + r.amount, 0);
            const grandTotal = allowanceTotal + receiptsTotal;

            // Aktualizujeme v≈°echna pole
            document.getElementById('printEmployeeName').textContent = document.getElementById('employeeName').value || defaultValues.employeeName;
            document.getElementById('printResidence').textContent = document.getElementById('residence').value || defaultValues.residence;
            document.getElementById('printEmployer').textContent = document.getElementById('employer').value || 'DMDsoft s.r.o.';
            document.getElementById('printDestination').textContent = document.getElementById('destination').value || defaultValues.destination;
            document.getElementById('printDateRange').textContent = formatDateRange(startDate, endDate);
            document.getElementById('returnDate').textContent = formatDate(endDate);
            document.getElementById('returnTime').textContent = document.getElementById('arrivalTime').value || '23:15';
            document.getElementById('totalAllowance').textContent = `${allowanceTotal.toFixed(2)}`;
            document.getElementById('totalEUR').textContent = `${grandTotal.toFixed(2)} EUR`;
            document.getElementById('finalClaim').textContent = `${grandTotal.toFixed(2)} EUR`;
            document.getElementById('finalPayment').textContent = `${grandTotal.toFixed(2)} EUR`;
            
            // Aktualizujeme datum vystaven√≠
            updateIssueDate();
            
            updateReceiptsInForm();
        }

        function saveTrip() {
            // Aktualizujeme v√Ωchoz√≠ hodnoty p≈ôed ulo≈æen√≠m
            updateDefaultValues();
            
            if (currentEditingTripId) {
                // Aktualizujeme existuj√≠c√≠ cestu
                updateTrip(currentEditingTripId);
                currentEditingTripId = null; // Resetujeme ID
            } else {
                // Ukl√°d√°me novou cestu
                const tripData = {
                    id: Date.now(),
                    employeeName: document.getElementById('employeeName').value,
                    residence: document.getElementById('residence').value,
                    employer: document.getElementById('employer').value,
                    employerIC: document.getElementById('employerIC').value,
                    destination: document.getElementById('destination').value,
                    purpose: document.getElementById('purpose').value,
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value,
                    departureTime: document.getElementById('departureTime').value,
                    arrivalTime: document.getElementById('arrivalTime').value,
                    receipts: [...receipts],
                    savedDate: new Date().toISOString(),
                    hasPDFAttachment: !!pdfAttachment
                };

                savedTrips.push(tripData);
                localStorage.setItem('savedTrips', JSON.stringify(savedTrips));
                
                alert('Cesta byla √∫spƒõ≈°nƒõ ulo≈æena!');
                displaySavedTrips();
            }
        }

        function updateTrip(tripId) {
            const tripIndex = savedTrips.findIndex(trip => trip.id === tripId);
            if (tripIndex === -1) return;

            const tripData = {
                id: tripId,
                employeeName: document.getElementById('employeeName').value,
                residence: document.getElementById('residence').value,
                employer: document.getElementById('employer').value,
                employerIC: document.getElementById('employerIC').value,
                destination: document.getElementById('destination').value,
                purpose: document.getElementById('purpose').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                departureTime: document.getElementById('departureTime').value,
                arrivalTime: document.getElementById('arrivalTime').value,
                receipts: [...receipts],
                savedDate: savedTrips[tripIndex].savedDate, // Zachov√°me p≈Øvodn√≠ datum ulo≈æen√≠
                updatedDate: new Date().toISOString(),
                hasPDFAttachment: !!pdfAttachment
            };

            savedTrips[tripIndex] = tripData;
            localStorage.setItem('savedTrips', JSON.stringify(savedTrips));
            
            alert('Cesta byla √∫spƒõ≈°nƒõ aktualizov√°na!');
            displaySavedTrips();
        }

        function displaySavedTrips() {
            if (savedTrips.length === 0) {
                document.getElementById('savedTrips').style.display = 'none';
                return;
            }

            document.getElementById('savedTrips').style.display = 'block';
            const listContainer = document.getElementById('savedTripsList');
            listContainer.innerHTML = '';

            savedTrips.forEach((trip, index) => {
                const tripElement = document.createElement('div');
                tripElement.className = 'saved-trip';
                tripElement.onclick = () => loadTrip(trip);
                
                const days = calculateDays(trip.startDate, trip.endDate);
                const allowanceTotal = days * 49.00;
                const receiptsTotal = (trip.receipts || []).reduce((sum, r) => sum + r.amount, 0);
                const totalAmount = allowanceTotal + receiptsTotal;
                
                tripElement.innerHTML = `
                    <div class="trip-info">
                        <div>
                            <strong>${trip.employeeName || 'Bez jm√©na'}</strong> - ${trip.destination || 'Nespecifikov√°no'}
                            ${trip.hasPDFAttachment ? '<br><span style="color: #27ae60; font-weight: bold; font-size: 12px;">üìé PDF doklad p≈ôipojen</span>' : ''}
                        </div>
                        <div>
                            <strong>${totalAmount.toFixed(2)} EUR</strong>
                            <button class="btn btn-small" onclick="event.stopPropagation(); loadTrip(${JSON.stringify(trip).replace(/"/g, '&quot;')})" style="margin-left: 5px;">‚úèÔ∏è Upravit</button>
                            <button class="btn btn-small btn-danger" onclick="event.stopPropagation(); deleteTrip(${index})" style="margin-left: 5px;">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="trip-details">
                        ${formatDateRange(trip.startDate, trip.endDate)} (${days} dn≈Ø) | 
                        Stravn√©: ${allowanceTotal.toFixed(2)} EUR, V√Ωdaje: ${receiptsTotal.toFixed(2)} EUR | 
                        Ulo≈æeno: ${formatDate(trip.savedDate.split('T')[0])}
                    </div>
                `;
                
                listContainer.appendChild(tripElement);
            });
            
            // Aktualizujeme celkov√Ω souƒçet
            updateTotalSummary();
        }

        function loadTrip(trip) {
            // Nastav√≠me ID editovan√© cesty
            currentEditingTripId = trip.id;
            
            document.getElementById('employeeName').value = trip.employeeName || '';
            document.getElementById('residence').value = trip.residence || '';
            document.getElementById('employer').value = trip.employer || '';
            document.getElementById('employerIC').value = trip.employerIC || '';
            document.getElementById('destination').value = trip.destination || '';
            document.getElementById('purpose').value = trip.purpose || '';
            document.getElementById('startDate').value = trip.startDate || '';
            document.getElementById('endDate').value = trip.endDate || '';
            document.getElementById('departureTime').value = trip.departureTime || '04:00';
            document.getElementById('arrivalTime').value = trip.arrivalTime || '23:15';
            
            // Naƒçten√≠ doklad≈Ø
            receipts = trip.receipts || [];
            updateReceiptsList();
            updateReceiptsSummary();
            
            // Automaticky vytvo≈ô√≠me formul√°≈ô s naƒçten√Ωmi daty
            calculateAndShowForm();
            
            // P≈ôesun zpƒõt na kalkulaƒçku
            document.getElementById('calculator').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteTrip(index) {
            if (confirm('Opravdu chcete smazat tuto ulo≈æenou cestu?')) {
                savedTrips.splice(index, 1);
                localStorage.setItem('savedTrips', JSON.stringify(savedTrips));
                displaySavedTrips(); // Toto u≈æ vol√° updateTotalSummary()
            }
        }

        // Aktualizace celkov√©ho souƒçtu v≈°ech cest
        function updateTotalSummary() {
            if (savedTrips.length === 0) {
                document.getElementById('totalSummary').style.display = 'none';
                return;
            }

            document.getElementById('totalSummary').style.display = 'block';
            
            let totalTrips = savedTrips.length;
            let totalDays = 0;
            let totalAllowance = 0;
            let totalReceipts = 0;

            savedTrips.forEach(trip => {
                const days = calculateDays(trip.startDate, trip.endDate);
                const allowanceTotal = days * 49.00;
                const receiptsTotal = (trip.receipts || []).reduce((sum, r) => sum + r.amount, 0);
                
                totalDays += days;
                totalAllowance += allowanceTotal;
                totalReceipts += receiptsTotal;
            });

            const grandTotal = totalAllowance + totalReceipts;

            document.getElementById('totalTrips').textContent = totalTrips;
            document.getElementById('totalDays').textContent = totalDays;
            document.getElementById('totalAllowance').textContent = `${totalAllowance.toFixed(2)} EUR`;
            document.getElementById('totalReceipts').textContent = `${totalReceipts.toFixed(2)} EUR`;
            document.getElementById('grandTotal').textContent = `${grandTotal.toFixed(2)} EUR`;
        }

        // Export souƒçtu do CSV
        function exportSummary() {
            if (savedTrips.length === 0) {
                alert('≈Ω√°dn√© cesty k exportu!');
                return;
            }

            let csvContent = 'Souƒçet v≈°ech cest\n\n';
            csvContent += 'Poƒçet cest,Dny,Stravn√© (EUR),V√Ωdaje (EUR),Celkem (EUR)\n';
            
            let totalDays = 0;
            let totalAllowance = 0;
            let totalReceipts = 0;

            savedTrips.forEach(trip => {
                const days = calculateDays(trip.startDate, trip.endDate);
                const allowanceTotal = days * 49.00;
                const receiptsTotal = (trip.receipts || []).reduce((sum, r) => sum + r.amount, 0);
                
                totalDays += days;
                totalAllowance += allowanceTotal;
                totalReceipts += receiptsTotal;
            });

            const grandTotal = totalAllowance + totalReceipts;
            
            csvContent += `${savedTrips.length},${totalDays},${totalAllowance.toFixed(2)},${totalReceipts.toFixed(2)},${grandTotal.toFixed(2)}\n\n`;
            
            csvContent += 'Detailn√≠ p≈ôehled cest:\n';
            csvContent += 'Jm√©no,C√≠l,Od,Do,Dny,Stravn√©,V√Ωdaje,Celkem,Datum ulo≈æen√≠\n';
            
            savedTrips.forEach(trip => {
                const days = calculateDays(trip.startDate, trip.endDate);
                const allowanceTotal = days * 49.00;
                const receiptsTotal = (trip.receipts || []).reduce((sum, r) => sum + r.amount, 0);
                const totalAmount = allowanceTotal + receiptsTotal;
                
                csvContent += `"${trip.employeeName || ''}","${trip.destination || ''}","${trip.startDate}","${trip.endDate}",${days},${allowanceTotal.toFixed(2)},${receiptsTotal.toFixed(2)},${totalAmount.toFixed(2)},"${formatDate(trip.savedDate.split('T')[0])}"\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `souƒçet_cest_${formatDate(new Date().toISOString().split('T')[0]).replace(/\./g, '')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Funkce pro odstranƒõn√≠ diakritiky
        function removeDiacritics(str) {
            return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        }

        // Export souƒçtu do PDF
        async function exportSummaryToPDF() {
            if (savedTrips.length === 0) {
                alert('Zadne cesty k exportu!');
                return;
            }

            try {
                if (!window.jspdf) {
                    throw new Error('jsPDF knihovna neni k dispozici');
                }

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();

                // Nadpis bez diakritiky
                pdf.setFontSize(16);
                pdf.text('SOUCET VSECH CEST', 105, 20, { align: 'center' });
                
                pdf.setFontSize(12);
                pdf.text(`Vygenerovano: ${formatDate(new Date().toISOString().split('T')[0])}`, 105, 30, { align: 'center' });

                // Celkov√© statistiky
                let totalDays = 0;
                let totalAllowance = 0;
                let totalReceipts = 0;

                savedTrips.forEach(trip => {
                    const days = calculateDays(trip.startDate, trip.endDate);
                    const allowanceTotal = days * 49.00;
                    const receiptsTotal = (trip.receipts || []).reduce((sum, r) => sum + r.amount, 0);
                    
                    totalDays += days;
                    totalAllowance += allowanceTotal;
                    totalReceipts += receiptsTotal;
                });

                const grandTotal = totalAllowance + totalReceipts;

                // Celkov√© statistiky v tabulce
                pdf.setFontSize(14);
                pdf.text('CELKOVE STATISTIKY', 20, 50);
                
                // Tabulka celkov√Ωch statistik
                const summaryData = [
                    ['Pocet cest', savedTrips.length.toString()],
                    ['Celkem dnu', totalDays.toString()],
                    ['Celkem stravne', `${totalAllowance.toFixed(2)} EUR`],
                    ['Celkem vydaje', `${totalReceipts.toFixed(2)} EUR`],
                    ['CELKEM', `${grandTotal.toFixed(2)} EUR`]
                ];

                pdf.setFontSize(10);
                let yPos = 65;
                summaryData.forEach(([label, value]) => {
                    pdf.text(label, 20, yPos);
                    pdf.text(value, 120, yPos);
                    yPos += 8;
                });

                // Detailn√≠ p≈ôehled v tabulce
                pdf.setFontSize(14);
                pdf.text('DETAILNI PREHLED CEST', 20, 110);

                // Hlaviƒçka tabulky
                pdf.setFontSize(9);
                pdf.text('Cislo', 20, 125);
                pdf.text('Jmeno', 35, 125);
                pdf.text('Cil', 80, 125);
                pdf.text('Od', 120, 125);
                pdf.text('Do', 140, 125);
                pdf.text('Dny', 160, 125);
                pdf.text('Stravne', 175, 125);
                pdf.text('Vydaje', 195, 125);
                pdf.text('Celkem', 210, 125);

                // ƒå√°ra pod hlaviƒçkou
                pdf.line(20, 127, 280, 127);

                let yPosition = 135;
                pdf.setFontSize(8);

                savedTrips.forEach((trip, index) => {
                    if (yPosition > 270) {
                        pdf.addPage();
                        // Opakujeme hlaviƒçku na nov√© str√°nce
                        pdf.setFontSize(9);
                        pdf.text('Cislo', 20, 20);
                        pdf.text('Jmeno', 35, 20);
                        pdf.text('Cil', 80, 20);
                        pdf.text('Od', 120, 20);
                        pdf.text('Do', 140, 20);
                        pdf.text('Dny', 160, 20);
                        pdf.text('Stravne', 175, 20);
                        pdf.text('Vydaje', 195, 20);
                        pdf.text('Celkem', 210, 20);
                        pdf.line(20, 22, 280, 22);
                        yPosition = 30;
                    }

                    const days = calculateDays(trip.startDate, trip.endDate);
                    const allowanceTotal = days * 49.00;
                    const receiptsTotal = (trip.receipts || []).reduce((sum, r) => sum + r.amount, 0);
                    const totalAmount = allowanceTotal + receiptsTotal;

                    // Data bez diakritiky
                    const employeeName = removeDiacritics(trip.employeeName || 'Bez jmena');
                    const destination = removeDiacritics(trip.destination || 'Nespecifikovano');
                    const startDate = trip.startDate;
                    const endDate = trip.endDate;

                    // ≈ò√°dek tabulky
                    pdf.text((index + 1).toString(), 20, yPosition);
                    pdf.text(employeeName.length > 15 ? employeeName.substring(0, 15) + '...' : employeeName, 35, yPosition);
                    pdf.text(destination.length > 20 ? destination.substring(0, 20) + '...' : destination, 80, yPosition);
                    pdf.text(startDate, 120, yPosition);
                    pdf.text(endDate, 140, yPosition);
                    pdf.text(days.toString(), 160, yPosition);
                    pdf.text(`${allowanceTotal.toFixed(2)}`, 175, yPosition);
                    pdf.text(`${receiptsTotal.toFixed(2)}`, 195, yPosition);
                    pdf.text(`${totalAmount.toFixed(2)}`, 210, yPosition);

                    yPosition += 6;
                });

                // Ulo≈æen√≠ PDF
                const fileName = `soucet_cest_${formatDate(new Date().toISOString().split('T')[0]).replace(/\./g, '')}.pdf`;
                pdf.save(fileName);

            } catch (error) {
                console.error('Chyba pri exportu do PDF:', error);
                alert(`Nepodarilo se exportovat do PDF: ${error.message}`);
            }
        }

        function clearForm() {
            document.getElementById('travelForm').reset();
            receipts = [];
            currentEditingTripId = null; // Resetujeme ID editovan√© cesty
            updateReceiptsList();
            updateReceiptsSummary();
            document.getElementById('formDocument').classList.remove('show');
            document.getElementById('printBtn').style.display = 'none';
            document.getElementById('pdfBtn').style.display = 'none';
            document.getElementById('emailBtn').style.display = 'none';
            document.getElementById('saveBtn').style.display = 'none';
            document.getElementById('saveAsNewBtn').style.display = 'none';
            document.getElementById('compactBtn').style.display = 'none';
        }

        function toggleCompactMode() {
            const formDocument = document.getElementById('formDocument');
            const compactBtn = document.getElementById('compactBtn');
            
            if (formDocument.classList.contains('compact-mode')) {
                formDocument.classList.remove('compact-mode');
                compactBtn.textContent = 'üìè Kompaktn√≠ re≈æim';
            } else {
                formDocument.classList.add('compact-mode');
                compactBtn.textContent = 'üìÑ Norm√°ln√≠ re≈æim';
            }
        }

        function updateSaveButtonText() {
            const saveBtn = document.getElementById('saveBtn');
            const saveAsNewBtn = document.getElementById('saveAsNewBtn');
            
            if (currentEditingTripId) {
                saveBtn.textContent = 'üíæ Aktualizovat cestu';
                saveAsNewBtn.style.display = 'inline-block';
            } else {
                saveBtn.textContent = 'üíæ Ulo≈æit cestu';
                saveAsNewBtn.style.display = 'none';
            }
        }

        function resetDefaults() {
            if (confirm('Opravdu chcete resetovat v√Ωchoz√≠ hodnoty na p≈Øvodn√≠?')) {
                // Resetujeme na p≈Øvodn√≠ hodnoty
                defaultValues = {
                    employeeName: 'Bc. Zdenƒõk ≈†i≈°ka',
                    residence: 'Havl√≠ƒçkova 1383, 334 41 Dob≈ôany',
                    destination: '≈Ωilina, Pova≈æsk√° Bystrica - SK'
                };
                
                // Ulo≈æ√≠me do localStorage
                saveDefaultValues();
                
                // Aktualizujeme placeholdery
                document.getElementById('employeeName').placeholder = defaultValues.employeeName;
                document.getElementById('residence').placeholder = defaultValues.residence;
                document.getElementById('destination').placeholder = defaultValues.destination;
                
                alert('V√Ωchoz√≠ hodnoty byly resetov√°ny na p≈Øvodn√≠!');
            }
        }

        function toggleMobileMode() {
            const body = document.body;
            const mobileBtn = document.getElementById('mobileBtn');
            
            if (body.classList.contains('mobile-mode')) {
                body.classList.remove('mobile-mode');
                mobileBtn.textContent = 'üì± Mobiln√≠ re≈æim';
                mobileBtn.style.background = '#3498db';
            } else {
                body.classList.add('mobile-mode');
                mobileBtn.textContent = 'üíª Desktop re≈æim';
                mobileBtn.style.background = '#e67e22';
            }
        }

        function emailPDF() {
            // Zobraz√≠me modal
            document.getElementById('emailModal').style.display = 'block';
            
            // P≈ôedvypln√≠me p≈ôedmƒõt a zpr√°vu
            const employeeName = document.getElementById('employeeName').value || defaultValues.employeeName;
            const destination = document.getElementById('destination').value || defaultValues.destination;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (startDate && endDate) {
                const dateRange = formatDateRange(startDate, endDate);
                document.getElementById('emailSubject').value = `Vy√∫ƒçtov√°n√≠ pracovn√≠ cesty - ${destination} (${dateRange})`;
                
                const emailBody = `Dobr√Ω den,

zas√≠l√°m vy√∫ƒçtov√°n√≠ pracovn√≠ cesty do ${destination} konan√© ve dnech ${dateRange}.

Vy√∫ƒçtov√°n√≠ je p≈ôipojeno jako PDF p≈ô√≠loha.

S pozdravem
${employeeName}`;
                
                document.getElementById('emailBody').value = emailBody;
            }
        }

        function closeEmailModal() {
            document.getElementById('emailModal').style.display = 'none';
        }

        async function sendEmail() {
            const emailTo = document.getElementById('emailTo').value.trim();
            const emailSubject = document.getElementById('emailSubject').value.trim();
            const emailBody = document.getElementById('emailBody').value.trim();

            if (!emailTo || !emailSubject || !emailBody) {
                alert('Pros√≠m vypl≈àte v≈°echny pole.');
                return;
            }

            try {
                // Zobraz√≠me loading
                const sendBtn = document.querySelector('#emailModal .btn-pdf');
                const originalText = sendBtn.textContent;
                sendBtn.textContent = '‚è≥ Generuji PDF...';
                sendBtn.disabled = true;

                // Generujeme PDF
                const pdfBlob = await generatePDFBlob();
                
                // Zkus√≠me pou≈æ√≠t Web Share API (modern√≠ prohl√≠≈æeƒçe)
                if (navigator.share && navigator.canShare) {
                    const fileName = generateFileName();
                    
                    const file = new File([pdfBlob], fileName, { type: 'application/pdf' });
                    
                    if (navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            title: emailSubject,
                            text: emailBody,
                            files: [file]
                        });
                        
                        alert('PDF bylo √∫spƒõ≈°nƒõ sd√≠leno!');
                        closeEmailModal();
                        return;
                    }
                }
                
                // Fallback: Sta≈æen√≠ PDF a otev≈ôen√≠ email klienta
                const fileName = generateFileName();
                const url = URL.createObjectURL(pdfBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                // Otev≈ôeme email klienta s informac√≠ o sta≈æen√©m PDF
                const mailtoLink = createMailtoLink(emailTo, emailSubject, emailBody + '\n\nPozn√°mka: PDF p≈ô√≠loha byla sta≈æena do va≈°eho poƒç√≠taƒçe.');
                window.location.href = mailtoLink;
                
                // Resetujeme tlaƒç√≠tko
                sendBtn.textContent = originalText;
                sendBtn.disabled = false;
                
                // Zav≈ôeme modal
                closeEmailModal();
                
                alert('PDF bylo sta≈æeno a email klient byl otev≈ôen. PDF p≈ô√≠lohu najdete ve slo≈æce Sta≈æen√© soubory.');
                
            } catch (error) {
                console.error('Chyba p≈ôi generov√°n√≠ PDF pro email:', error);
                alert('Nepoda≈ôilo se vygenerovat PDF pro email. Zkuste to pros√≠m znovu.');
                
                // Resetujeme tlaƒç√≠tko
                const sendBtn = document.querySelector('#emailModal .btn-pdf');
                sendBtn.textContent = 'üìß Odeslat';
                sendBtn.disabled = false;
            }
        }

        async function generatePDFBlob() {
            const { jsPDF } = window.jspdf;
            
            if (!jsPDF) {
                throw new Error('PDF knihovna nen√≠ k dispozici');
            }

            // Zapneme kompaktn√≠ re≈æim pro PDF
            const formDocument = document.getElementById('formDocument');
            const wasCompact = formDocument.classList.contains('compact-mode');
            if (!wasCompact) {
                formDocument.classList.add('compact-mode');
            }

            // P≈ôevedeme obr√°zky na data URL pro zabr√°nƒõn√≠ tainted canvas
            await convertImagesToDataURL(formDocument);

            // Vytvo≈ô√≠me canvas z formul√°≈ôe
            const canvas = await html2canvas(formDocument, {
                scale: 1.2,
                useCORS: false,
                allowTaint: false, // Kl√≠ƒçov√© pro ≈ôe≈°en√≠ tainted canvas
                backgroundColor: '#ffffff',
                width: formDocument.scrollWidth,
                height: formDocument.scrollHeight,
                logging: false,
                removeContainer: false,
                ignoreElements: function(element) {
                    // Ignorujeme pouze obr√°zky, kter√© nejsou data URL
                    return element.tagName === 'IMG' && element.src && !element.src.startsWith('data:');
                }
            });

            // Vytvo≈ô√≠me PDF
            const imgData = canvas.toDataURL('image/jpeg', 0.8);
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            const imgWidth = 200;
            const pageHeight = 285;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            let heightLeft = imgHeight;
            let position = 5;

            pdf.addImage(imgData, 'JPEG', 5, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;

            while (heightLeft >= 0) {
                position = heightLeft - imgHeight + 5;
                pdf.addPage();
                pdf.addImage(imgData, 'JPEG', 5, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }

            // Vr√°t√≠me p≈Øvodn√≠ re≈æim
            if (!wasCompact) {
                formDocument.classList.remove('compact-mode');
            }

            // P≈ôipoj√≠me PDF p≈ô√≠lohu pokud existuje
            if (pdfAttachment) {
                try {
                    console.log('P≈ôipojuji PDF p≈ô√≠lohu pro email:', pdfAttachment.name);
                    
                    // Kontrola dostupnosti PDF.js
                    if (!window.pdfjsLib) {
                        throw new Error('PDF.js knihovna nen√≠ k dispozici');
                    }
                    
                    // Naƒçteme PDF p≈ô√≠lohu
                    const attachmentPDF = await loadPDFFromDataURL(pdfAttachment.data);
                    console.log('PDF p≈ô√≠loha naƒçtena pro email, poƒçet str√°nek:', attachmentPDF.getNumberOfPages());
                    
                    // P≈ôid√°me v≈°echny str√°nky z p≈ô√≠lohy
                    const totalPages = attachmentPDF.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        console.log(`P≈ôid√°v√°m str√°nku ${i} z ${totalPages} pro email`);
                        pdf.addPage();
                        const page = await attachmentPDF.getPage(i);
                        const viewport = page.getViewport({ scale: 1.5 }); // Zvƒõt≈°√≠me ≈°k√°lov√°n√≠ pro lep≈°√≠ kvalitu
                        
                        // P≈ôid√°me str√°nku jako obr√°zek
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        
                        const renderContext = {
                            canvasContext: context,
                            viewport: viewport
                        };
                        
                        await page.render(renderContext).promise;
                        const imgData = canvas.toDataURL('image/jpeg', 0.9); // Vy≈°≈°√≠ kvalita
                        
                        // P≈ôid√°me obr√°zek do PDF s lep≈°√≠m um√≠stƒõn√≠m
                        const imgWidth = 200;
                        const imgHeight = (canvas.height * imgWidth) / canvas.width;
                        pdf.addImage(imgData, 'JPEG', 5, 5, imgWidth, imgHeight);
                        console.log(`Str√°nka ${i} p≈ôid√°na do PDF pro email`);
                    }
                    console.log('PDF p≈ô√≠loha √∫spƒõ≈°nƒõ p≈ôipojena pro email');
                } catch (error) {
                    console.error('Chyba p≈ôi p≈ôipojov√°n√≠ PDF p≈ô√≠lohy pro email:', error);
                    alert(`Nepoda≈ôilo se p≈ôipojit PDF p≈ô√≠lohu pro email: ${error.message}`);
                }
            }

            // Vytvo≈ô√≠me blob z PDF
            const pdfBlob = pdf.output('blob');
            return pdfBlob;
        }

        function createMailtoLink(to, subject, body) {
            const encodedSubject = encodeURIComponent(subject);
            const encodedBody = encodeURIComponent(body);
            
            return `mailto:${to}?subject=${encodedSubject}&body=${encodedBody}`;
        }

        function generateFileName() {
            const employeeName = document.getElementById('employeeName').value || defaultValues.employeeName;
            const destination = document.getElementById('destination').value || defaultValues.destination;
            const startDate = document.getElementById('startDate').value;
            
            const namePart = employeeName.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
            const destPart = destination.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
            const datePart = startDate ? startDate.replace(/-/g, '') : formatDate(new Date().toISOString().split('T')[0]).replace(/\./g, '');
            
            return `vyuctovani_${namePart}_${destPart}_${datePart}.pdf`;
        }

        async function downloadAndEmail() {
            const emailTo = document.getElementById('emailTo').value.trim();
            const emailSubject = document.getElementById('emailSubject').value.trim();
            const emailBody = document.getElementById('emailBody').value.trim();

            if (!emailTo || !emailSubject || !emailBody) {
                alert('Pros√≠m vypl≈àte v≈°echny pole.');
                return;
            }

            try {
                // Zobraz√≠me loading
                const downloadBtn = document.querySelector('#emailModal .btn-save');
                const originalText = downloadBtn.textContent;
                downloadBtn.textContent = '‚è≥ Generuji PDF...';
                downloadBtn.disabled = true;

                // Generujeme PDF
                const pdfBlob = await generatePDFBlob();
                const fileName = generateFileName();
                
                // Sta≈æen√≠ PDF
                const url = URL.createObjectURL(pdfBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                // Otev≈ôeme email klienta s informac√≠ o sta≈æen√©m PDF
                const mailtoLink = createMailtoLink(emailTo, emailSubject, emailBody + '\n\nPozn√°mka: PDF p≈ô√≠loha byla sta≈æena do va≈°eho poƒç√≠taƒçe. Pros√≠m p≈ôipojte ji k emailu.');
                window.location.href = mailtoLink;
                
                // Resetujeme tlaƒç√≠tko
                downloadBtn.textContent = originalText;
                downloadBtn.disabled = false;
                
                // Zav≈ôeme modal
                closeEmailModal();
                
                alert('PDF bylo sta≈æeno a email klient byl otev≈ôen. Pros√≠m p≈ôipojte sta≈æen√© PDF k emailu.');
                
            } catch (error) {
                console.error('Chyba p≈ôi generov√°n√≠ PDF:', error);
                alert('Nepoda≈ôilo se vygenerovat PDF. Zkuste to pros√≠m znovu.');
                
                // Resetujeme tlaƒç√≠tko
                const downloadBtn = document.querySelector('#emailModal .btn-save');
                downloadBtn.textContent = 'üíæ Sta≈æen√≠ + Email';
                downloadBtn.disabled = false;
            }
        }

        // Zav≈ôen√≠ modalu p≈ôi kliknut√≠ mimo nƒõj
        window.onclick = function(event) {
            const modal = document.getElementById('emailModal');
            if (event.target === modal) {
                closeEmailModal();
            }
        }

        function saveAsNewTrip() {
            // Aktualizujeme v√Ωchoz√≠ hodnoty p≈ôed ulo≈æen√≠m
            updateDefaultValues();
            
            // Doƒçasnƒõ resetujeme ID editovan√© cesty
            const originalEditingId = currentEditingTripId;
            currentEditingTripId = null;
            
            // Ulo≈æ√≠me jako novou cestu
            const tripData = {
                id: Date.now(),
                employeeName: document.getElementById('employeeName').value,
                residence: document.getElementById('residence').value,
                employer: document.getElementById('employer').value,
                employerIC: document.getElementById('employerIC').value,
                destination: document.getElementById('destination').value,
                purpose: document.getElementById('purpose').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                departureTime: document.getElementById('departureTime').value,
                arrivalTime: document.getElementById('arrivalTime').value,
                receipts: [...receipts],
                savedDate: new Date().toISOString(),
                hasPDFAttachment: !!pdfAttachment
            };

            savedTrips.push(tripData);
            localStorage.setItem('savedTrips', JSON.stringify(savedTrips));
            
            // Vr√°t√≠me p≈Øvodn√≠ ID pro p≈ô√≠padn√© dal≈°√≠ √∫pravy
            currentEditingTripId = originalEditingId;
            
            alert('Cesta byla √∫spƒõ≈°nƒõ ulo≈æena jako nov√° cesta!');
            displaySavedTrips();
            updateSaveButtonText();
        }

        // Detekce mobiln√≠ho za≈ô√≠zen√≠
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   window.innerWidth <= 768;
        }

        // Inicializace p≈ôi naƒçten√≠ str√°nky
        document.addEventListener('DOMContentLoaded', function() {
            // Naƒçteme v√Ωchoz√≠ hodnoty
            loadDefaultValues();
            
            // Naƒçteme podpisy
            loadSignatures();
            
            // Naƒçteme PDF p≈ô√≠lohu
            loadPDFAttachmentFromStorage();
            
            // Nastav√≠me v√Ωchoz√≠ hodnoty do formul√°≈ôe
            document.getElementById('employeeName').placeholder = defaultValues.employeeName;
            document.getElementById('residence').placeholder = defaultValues.residence;
            document.getElementById('destination').placeholder = defaultValues.destination;
            
            // Automatick√° detekce mobiln√≠ho za≈ô√≠zen√≠
            if (isMobileDevice()) {
                document.body.classList.add('mobile-mode');
                const mobileBtn = document.getElementById('mobileBtn');
                mobileBtn.textContent = 'üíª Desktop re≈æim';
                mobileBtn.style.background = '#e67e22';
            }
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            displaySavedTrips();

        // Kontrola dostupnosti PDF knihoven
        setTimeout(() => {
            if (!window.jspdf) {
                console.error('jsPDF knihovna se nenaƒçetla');
                alert('Upozornƒõn√≠: PDF knihovna se nenaƒçetla. PDF funkce nemus√≠ fungovat. Zkontrolujte internetov√© p≈ôipojen√≠.');
            }
            if (!window.html2canvas) {
                console.error('html2canvas knihovna se nenaƒçetla');
                alert('Upozornƒõn√≠: Canvas knihovna se nenaƒçetla. PDF funkce nemus√≠ fungovat. Zkontrolujte internetov√© p≈ôipojen√≠.');
            }
            if (!window.pdfjsLib) {
                console.error('PDF.js knihovna se nenaƒçetla');
                alert('Upozornƒõn√≠: PDF.js knihovna se nenaƒçetla. PDF p≈ô√≠lohy nemus√≠ fungovat. Zkontrolujte internetov√© p≈ôipojen√≠.');
            }
            
            // Test dostupnosti funkc√≠
            console.log('PDF knihovny test:', {
                jsPDF: !!window.jspdf,
                html2canvas: !!window.html2canvas,
                pdfjsLib: !!window.pdfjsLib,
                navigator: !!navigator,
                userAgent: navigator.userAgent
            });
        }, 2000);
        });

        // P≈ôid√°n√≠ event listeneru pro Enter kl√°vesy v dokladech
        document.getElementById('receiptAmount').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addReceipt();
            }
        });

        document.getElementById('receiptDescription').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addReceipt();
            }
        });

        // Event listenery pro automatickou aktualizaci data vystaven√≠
        document.getElementById('endDate').addEventListener('change', function() {
            // Aktualizujeme datum vystaven√≠ pouze pokud je formul√°≈ô ji≈æ zobrazen
            if (document.getElementById('formDocument').classList.contains('show')) {
                updateIssueDate();
            }
        });

        document.getElementById('endDate').addEventListener('input', function() {
            // Aktualizujeme datum vystaven√≠ pouze pokud je formul√°≈ô ji≈æ zobrazen
            if (document.getElementById('formDocument').classList.contains('show')) {
                updateIssueDate();
            }
        });
    </script>
</body>
</html>
