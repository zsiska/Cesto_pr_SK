<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vyúčtování pracovní cesty v zahraničí</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" onerror="console.error('Chyba při načítání jsPDF')"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" onerror="console.error('Chyba při načítání html2canvas')"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" onerror="console.error('Chyba při načítání PDF.js')"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            font-size: 12px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* Kalkulačka - pro vstup dat */
        .calculator {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            padding: 30px;
        }

        .calculator h1 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group textarea {
            height: 60px;
            resize: vertical;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-print {
            background: #e74c3c;
        }

        .btn-print:hover {
            background: #c0392b;
        }

        .btn-save {
            background: #f39c12;
        }

        .btn-save:hover {
            background: #e67e22;
        }

        .btn-pdf {
            background: #9b59b6;
        }

        .btn-pdf:hover {
            background: #8e44ad;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .button-row {
            text-align: center;
            margin-top: 20px;
        }

        /* Sekce dokladů */
        .receipts-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .receipts-section h3 {
            margin-bottom: 15px;
            color: white;
        }

        .receipt-item {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .receipt-info {
            flex-grow: 1;
        }

        .receipt-amount {
            font-weight: bold;
            color: #27ae60;
            margin-left: 15px;
        }

        .add-receipt-form {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .add-receipt-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 100px;
            gap: 10px;
            align-items: end;
            margin-bottom: 10px;
        }

        /* Formulář - pro tisk */
        .form-document {
            padding: 20px;
            display: none;
            background: white;
        }

        .form-document.show {
            display: block;
        }

        .form-header {
            background: #4CAF50;
            color: white;
            text-align: center;
            padding: 15px;
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .form-section {
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .form-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 5px 0;
            border-bottom: 1px dotted #ddd;
        }

        .form-line:last-child {
            border-bottom: none;
        }

        .form-line strong {
            margin-right: 10px;
        }

        .underline {
            border-bottom: 1px solid #000;
            min-width: 200px;
            display: inline-block;
            text-align: center;
            padding: 2px 5px;
        }

        .checkbox {
            margin: 0 10px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .table th, .table td {
            border: 1px solid #000;
            padding: 8px;
            text-align: center;
            font-size: 11px;
        }

        .table th {
            background: #f0f0f0;
            font-weight: bold;
        }

        .signature-section {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
            font-size: 10px;
        }

        .signature-box {
            text-align: center;
            border-top: 1px solid #000;
            padding-top: 5px;
            margin-top: 40px;
        }

        .receipt-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .receipt-summary h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .receipt-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            padding: 5px 0;
            border-bottom: 1px dotted #ddd;
        }

        .receipt-line:last-child {
            border-bottom: none;
            font-weight: bold;
            border-top: 1px solid #ddd;
            margin-top: 5px;
            padding-top: 10px;
        }

        /* Tiskové styly - optimalizované pro jednu stránku */
        @media print {
            body {
                background: white !important;
                padding: 0 !important;
                font-size: 9px !important;
                margin: 0 !important;
            }
            
            /* Page break pro sekci nepoužitých letenek */
            .page-break-section {
                page-break-before: always;
                break-before: page;
            }

            .calculator {
                display: none !important;
            }

            .saved-trips {
                display: none !important;
            }

            .form-document {
                display: block !important;
                padding: 5px !important;
                margin: 0 !important;
            }

            .container {
                box-shadow: none !important;
                border-radius: 0 !important;
                max-width: none !important;
                margin: 0 !important;
            }

            .btn {
                display: none !important;
            }

            .form-header {
                font-size: 12px !important;
                padding: 8px !important;
                margin-bottom: 10px !important;
            }

            .form-section {
                padding: 8px !important;
                margin-bottom: 8px !important;
                break-inside: avoid;
                page-break-inside: avoid;
            }

            .form-line {
                margin-bottom: 3px !important;
                padding: 2px 0 !important;
                font-size: 9px !important;
            }

            .table {
                font-size: 8px !important;
                margin: 5px 0 !important;
            }

            .table th, .table td {
                padding: 3px !important;
                font-size: 8px !important;
            }

            .signature-section {
                margin-top: 15px !important;
                font-size: 8px !important;
                break-inside: avoid;
                page-break-inside: avoid;
            }

            .signature-box {
                margin-top: 20px !important;
            }

            .underline {
                min-width: 120px !important;
            }

            /* Kompaktní režim pro tisk */
            .compact-mode .form-section {
                padding: 5px !important;
                margin-bottom: 5px !important;
            }

            .compact-mode .form-line {
                margin-bottom: 2px !important;
                padding: 1px 0 !important;
            }

            .compact-mode .table {
                margin: 3px 0 !important;
            }

            .compact-mode .signature-section {
                margin-top: 10px !important;
            }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .signature-section {
                grid-template-columns: 1fr;
            }

            .add-receipt-row {
                grid-template-columns: 1fr;
            }
        }

        .saved-trips {
            background: #f8f9fa;
            padding: 20px;
            border-top: 2px solid #2ecc71;
        }

        .saved-trip {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
            cursor: pointer;
            transition: background 0.3s;
        }

        .saved-trip:hover {
            background: #e8f5e8;
        }

        .trip-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .trip-details {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        /* Celkový součet */
        .total-summary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .total-summary h3 {
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.2rem;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-item.total-item {
            background: rgba(255, 255, 255, 0.2);
            font-weight: bold;
            font-size: 1.1rem;
        }

        .stat-label {
            display: block;
            font-size: 12px;
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .stat-value {
            display: block;
            font-size: 18px;
            font-weight: bold;
        }

        .summary-actions {
            text-align: center;
        }

        .btn-export {
            background: #e74c3c;
            margin: 5px;
        }

        .btn-export:hover {
            background: #c0392b;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        /* Email modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        .modal-header h3 {
            margin: 0;
            color: #2c3e50;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #000;
        }

        .email-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .email-form label {
            font-weight: bold;
            color: #2c3e50;
        }

        .email-form input,
        .email-form textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .email-form textarea {
            height: 80px;
            resize: vertical;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .modal-buttons .btn {
            margin: 0;
        }

        /* Mobilní optimalizace pro modal */
        .mobile-mode .modal-content {
            margin: 2% auto;
            width: 95%;
            padding: 15px;
        }

        .mobile-mode .modal-header h3 {
            font-size: 1.2rem;
        }

        .mobile-mode .email-form input,
        .mobile-mode .email-form textarea {
            font-size: 16px;
            padding: 12px;
        }

        .mobile-mode .modal-buttons {
            flex-direction: column;
        }

        .mobile-mode .modal-buttons .btn {
            width: 100%;
        }

        /* Mobilní optimalizace pro podpisy */
        .mobile-mode .signatures-section {
            padding: 15px !important;
        }

        /* Mobilní optimalizace pro podpisovou sekci */
        .mobile-mode .signature-section {
            grid-template-columns: 1fr 1fr !important;
            gap: 15px !important;
        }

        .mobile-mode .signature-section > div {
            margin-bottom: 15px !important;
        }

        .mobile-mode .signature-section img {
            max-height: 200px !important;
        }

        /* Kompaktní režim pro formulář */
        .compact-mode .form-section {
            padding: 8px;
            margin-bottom: 8px;
        }

        .compact-mode .form-line {
            margin-bottom: 4px;
            padding: 2px 0;
            font-size: 11px;
        }

        .compact-mode .table {
            margin: 8px 0;
            font-size: 10px;
        }

        .compact-mode .table th, .compact-mode .table td {
            padding: 4px;
            font-size: 10px;
        }

        .compact-mode .signature-section {
            margin-top: 15px;
            font-size: 9px;
        }

        .compact-mode .signature-box {
            margin-top: 25px;
        }

        .compact-mode .form-header {
            padding: 10px;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .compact-mode .signature-section {
            margin-top: 20px !important;
            gap: 15px !important;
        }

        .compact-mode .signature-section > div {
            font-size: 9px !important;
        }

        .compact-mode .signature-section img {
            max-height: 200px !important;
        }

        /* Page break pro kompaktní režim */
        .compact-mode .page-break-section {
            page-break-before: always;
            break-before: page;
        }

        /* Mobilní režim */
        .mobile-mode {
            font-size: 14px !important;
        }

        .mobile-mode .container {
            max-width: 100% !important;
            margin: 0 !important;
            border-radius: 0 !important;
            box-shadow: none !important;
        }

        .mobile-mode .calculator {
            padding: 15px !important;
        }

        .mobile-mode .calculator h1 {
            font-size: 1.4rem !important;
            margin-bottom: 15px !important;
        }

        .mobile-mode .form-row {
            grid-template-columns: 1fr !important;
            gap: 10px !important;
        }

        .mobile-mode .form-group {
            margin-bottom: 10px !important;
        }

        .mobile-mode .form-group input,
        .mobile-mode .form-group select,
        .mobile-mode .form-group textarea {
            padding: 12px !important;
            font-size: 16px !important; /* Zabrání zoomu na iOS */
            border-radius: 6px !important;
        }

        .mobile-mode .btn {
            padding: 15px 20px !important;
            font-size: 16px !important;
            margin: 8px 4px !important;
            border-radius: 8px !important;
            min-height: 48px !important; /* Doporučená velikost pro dotyk */
        }

        .mobile-mode .button-row {
            display: flex !important;
            flex-wrap: wrap !important;
            justify-content: center !important;
            gap: 8px !important;
        }

        .mobile-mode .receipts-section {
            padding: 15px !important;
            margin-bottom: 15px !important;
        }

        .mobile-mode .receipt-item {
            padding: 12px !important;
            flex-direction: column !important;
            align-items: flex-start !important;
        }

        .mobile-mode .receipt-info {
            margin-bottom: 8px !important;
        }

        .mobile-mode .receipt-amount {
            margin-left: 0 !important;
            font-size: 16px !important;
        }

        .mobile-mode .add-receipt-row {
            grid-template-columns: 1fr !important;
            gap: 8px !important;
        }

        .mobile-mode .saved-trips {
            padding: 15px !important;
        }

        .mobile-mode .saved-trip {
            padding: 12px !important;
        }

        .mobile-mode .trip-info {
            flex-direction: column !important;
            align-items: flex-start !important;
        }

        .mobile-mode .trip-info > div:last-child {
            margin-top: 8px !important;
            display: flex !important;
            gap: 8px !important;
        }

        .mobile-mode .form-document {
            padding: 10px !important;
        }

        .mobile-mode .form-section {
            padding: 10px !important;
            margin-bottom: 10px !important;
        }

        .mobile-mode .form-line {
            font-size: 12px !important;
            margin-bottom: 5px !important;
        }

        .mobile-mode .table {
            font-size: 10px !important;
        }

        .mobile-mode .table th,
        .mobile-mode .table td {
            padding: 4px !important;
            font-size: 10px !important;
        }

        .mobile-mode .signature-section {
            grid-template-columns: 1fr !important;
            gap: 15px !important;
            margin-top: 20px !important;
        }

        /* Skrytí některých elementů v mobilním režimu */
        .mobile-mode .btn-small {
            padding: 8px 12px !important;
            font-size: 14px !important;
        }

        /* Optimalizace pro velmi malé obrazovky */
        @media (max-width: 480px) {
            .mobile-mode .calculator h1 {
                font-size: 1.2rem !important;
            }
            
            .mobile-mode .btn {
                padding: 12px 16px !important;
                font-size: 14px !important;
            }
            
            .mobile-mode .button-row {
                flex-direction: column !important;
            }
            
            .mobile-mode .button-row .btn {
                width: 100% !important;
                margin: 4px 0 !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Kalkulačka pro vstup dat -->
        <div class="calculator" id="calculator">
            <h1>🧮 Kalkulačka cestovního formuláře</h1>
            
            <form id="travelForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Jméno zaměstnance:</label>
                        <input type="text" id="employeeName" placeholder="Bc. Zdeněk Šiška">
                    </div>
                    <div class="form-group">
                        <label>Bydliště:</label>
                        <input type="text" id="residence" placeholder="Havlíčkova 1383, 334 41 Dobřany">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Zaměstnavatel:</label>
                        <input type="text" id="employer" placeholder="DMDsoft s.r.o.">
                    </div>
                    <div class="form-group">
                        <label>IČ zaměstnavatele:</label>
                        <input type="text" id="employerIC" placeholder="03393356">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Cesta do:</label>
                        <input type="text" id="destination" placeholder="Žilina, Považská Bystrica - SK">
                    </div>
                    <div class="form-group">
                        <label>Účel cesty:</label>
                        <input type="text" id="purpose" placeholder="Pracovní jednání">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Datum začátku cesty:</label>
                        <input type="date" id="startDate" required>
                    </div>
                    <div class="form-group">
                        <label>Datum konce cesty:</label>
                        <input type="date" id="endDate" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Čas odjezdu:</label>
                        <input type="time" id="departureTime" value="04:00">
                    </div>
                    <div class="form-group">
                        <label>Čas příjezdu:</label>
                        <input type="time" id="arrivalTime" value="23:15">
                    </div>
                </div>

                <!-- Sekce dokladů -->
                <div class="receipts-section">
                    <h3>📄 Doklady o výdajích</h3>
                    
                    <div class="add-receipt-form">
                        <div class="add-receipt-row">
                            <div>
                                <label>Popis výdaje:</label>
                                <input type="text" id="receiptDescription" placeholder="např. Ubytování Hotel Zlatý Býk">
                            </div>
                            <div>
                                <label>Částka (EUR):</label>
                                <input type="number" id="receiptAmount" step="0.01" placeholder="0.00">
                            </div>
                            <div>
                                <label>Typ:</label>
                                <select id="receiptType">
                                    <option value="ubytování">Ubytování</option>
                                    <option value="tankování">Tankování</option>
                                    <option value="parkovné">Parkovné</option>
                                    <option value="mýto">Mýto</option>
                                    <option value="ostatní">Ostatní výdaje</option>
                                </select>
                            </div>
                            <div>
                                <button type="button" class="btn btn-small" onclick="addReceipt()">➕ Přidat</button>
                            </div>
                        </div>
                    </div>

                    <div id="receiptsList"></div>

                    <div class="receipt-summary" id="receiptsSummary" style="display:none;">
                        <h4>📊 Shrnutí výdajů</h4>
                        <div id="receiptsBreakdown"></div>
                    </div>
                </div>

                <!-- Sekce pro nahrání podpisů -->
                <div class="signatures-section" style="background: rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: white;">✍️ Podpisy</h3>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <!-- Podpis zaměstnance -->
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Podpis zaměstnance:</label>
                            <input type="file" id="employeeSignatureFile" accept="image/*" onchange="loadSignature('employee', this)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <div style="display: flex; gap: 10px; margin-top: 5px;">
                                <button type="button" class="btn btn-small" onclick="clearSignature('employee')">🗑️ Smazat</button>
                                <input type="number" id="employeeSignatureSize" min="50" max="300" value="100" onchange="updateSignatureSize('employee')" style="width: 80px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;" title="Velikost v %">
                                <span style="color: rgba(255, 255, 255, 0.8); font-size: 12px; align-self: center;">%</span>
                            </div>
                        </div>
                        
                        <!-- Podpis odpovědného pracovníka -->
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Podpis odpovědného pracovníka:</label>
                            <input type="file" id="supervisorSignatureFile" accept="image/*" onchange="loadSignature('supervisor', this)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <div style="display: flex; gap: 10px; margin-top: 5px;">
                                <button type="button" class="btn btn-small" onclick="clearSignature('supervisor')">🗑️ Smazat</button>
                                <input type="number" id="supervisorSignatureSize" min="50" max="300" value="200" onchange="updateSignatureSize('supervisor')" style="width: 80px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;" title="Velikost v %">
                                <span style="color: rgba(255, 255, 255, 0.8); font-size: 12px; align-self: center;">%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sekce pro připojení PDF dokladu -->
                <div class="pdf-attachment-section" style="background: rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: white;">📎 Připojit PDF doklad</h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Vybrat PDF soubor:</label>
                            <input type="file" id="pdfAttachmentFile" accept=".pdf" onchange="loadPDFAttachment(this)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <div style="display: flex; gap: 10px; margin-top: 5px;">
                                <button type="button" class="btn btn-small" onclick="clearPDFAttachment()">🗑️ Odstranit</button>
                                <span id="pdfAttachmentInfo" style="color: rgba(255, 255, 255, 0.8); font-size: 12px; align-self: center;"></span>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.8);">
                            💡 PDF doklad se připojí na konec výsledného PDF jako další stránky<br>
                            📌 <strong>Poznámka:</strong> PDF doklad bude označen u konkrétní cesty v seznamu uložených cest
                        </div>
                    </div>
                </div>

                <div class="button-row">
                    <button type="button" class="btn" onclick="calculateAndShowForm()">📋 Vytvořit formulář</button>
                    <button type="button" class="btn btn-print" onclick="printForm()" id="printBtn" style="display:none">🖨️ Vytisknout</button>
                    <button type="button" class="btn btn-pdf" onclick="exportToPDF()" id="pdfBtn" style="display:none">📄 Uložit PDF</button>
                    <button type="button" class="btn btn-pdf" onclick="emailPDF()" id="emailBtn" style="display:none">📧 Odeslat PDF</button>
                    <button type="button" class="btn btn-save" onclick="saveTrip()" id="saveBtn" style="display:none">💾 Uložit cestu</button>
                    <button type="button" class="btn btn-save" onclick="saveAsNewTrip()" id="saveAsNewBtn" style="display:none">📋 Uložit jako novou cestu</button>
                    <button type="button" class="btn" onclick="toggleCompactMode()" id="compactBtn" style="display:none">📏 Kompaktní režim</button>
                    <button type="button" class="btn" onclick="toggleMobileMode()" id="mobileBtn">📱 Mobilní režim</button>
                    <button type="button" class="btn" onclick="resetDefaults()" title="Resetovat výchozí hodnoty na původní">🔄 Reset výchozích</button>
                    <button type="button" class="btn" onclick="clearForm()">🗑️ Vymazat</button>
                </div>
            </form>
        </div>

        <!-- Uložené cesty -->
        <div class="saved-trips" id="savedTrips" style="display:none">
            <h3>💾 Uložené cesty</h3>
            <div id="savedTripsList"></div>
            
            <!-- Celkový součet -->
            <div class="total-summary" id="totalSummary" style="display:none">
                <h3>📊 Celkový součet všech cest</h3>
                <div class="summary-stats">
                    <div class="stat-item">
                        <span class="stat-label">Počet cest:</span>
                        <span class="stat-value" id="totalTrips">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Celkem dnů:</span>
                        <span class="stat-value" id="totalDays">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Celkem stravné:</span>
                        <span class="stat-value" id="totalAllowance">0.00 EUR</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Celkem výdaje:</span>
                        <span class="stat-value" id="totalReceipts">0.00 EUR</span>
                    </div>
                    <div class="stat-item total-item">
                        <span class="stat-label">CELKEM:</span>
                        <span class="stat-value" id="grandTotal">0.00 EUR</span>
                    </div>
                </div>
                <div class="summary-actions">
                    <button class="btn btn-export" onclick="exportSummary()">📄 Exportovat součet</button>
                    <button class="btn btn-export" onclick="exportSummaryToPDF()">📄 Exportovat součet do PDF</button>
                </div>
            </div>
        </div>

        <!-- Formulář pro tisk -->
        <div class="form-document" id="formDocument">
            <div class="form-header">
                VYÚČTOVÁNÍ PRACOVNÍ CESTY V ZAHRANIČÍ
            </div>

            <div class="form-section">
                <div class="form-line">
                    <span><strong>Jméno zaměstnance:</strong> <span class="underline" id="printEmployeeName"></span></span>
                </div>
                <div class="form-line">
                    <span><strong>Bydliště:</strong> <span class="underline" id="printResidence"></span></span>
                </div>
                <div class="form-line">
                    <span><strong>Zaměstnavatel:</strong> <span class="underline" id="printEmployer"></span></span>
                </div>
                <div class="form-line">
                    <span><strong>Cesta do:</strong> <span class="underline" id="printDestination"></span> <strong>vykonána ve dnech:</strong> <span class="underline" id="printDateRange"></span></span>
                </div>
                <div class="form-line">
                    <span><strong>Určený dopravní prostředek:</strong> <span class="underline">AUS</span></span>
                </div>
            </div>

            <div class="form-section">
                <div class="form-line">
                    <span><strong>Výše přidělů devizových prostředků podle připojených dokladů banky:</strong></span>
                </div>
                <div class="form-line">
                    <span>v šecích: .......... v hotovosti: <span class="underline">0,00</span></span>
                </div>
                <div class="form-line">
                    <span><strong>Celkem:</strong> .......... <strong>Kurs:</strong> ..........</span>
                </div>
                <div class="form-line">
                    <span><strong>Výše denního stravného:</strong> <span class="underline">35,00 EUR</span> <strong>Výše kapesného:</strong> <span class="underline">14,00 EUR</span></span>
                </div>
                <div class="form-line">
                    <span><strong>Celodenní bezplatné stravování poskytováno ve dnech:</strong> <span class="underline" id="printMealDates"></span></span>
                </div>
                <div class="form-line">
                    <span><strong>Částečné bezplatné stravování poskytováno:</strong> ano ☐ ne ☒</span>
                </div>
            </div>

            <div class="form-section">
                <div class="form-line">
                    <strong>Devizový nárok:</strong>
                </div>
                
                <table class="table" id="dailyAllowanceTable">
                    <thead>
                        <tr>
                            <th>a) odlet/příjezd ze zahraničí</th>
                            <th>Hodina</th>
                            <th>tj.</th>
                            <th>% stravné/kapesné</th>
                            <th>nárok</th>
                        </tr>
                    </thead>
                    <tbody id="dailyAllowanceBody">
                    </tbody>
                </table>

                <div class="form-line">
                    <span><strong>Počátek a ukončení prac. výkonu:</strong></span>
                </div>
                <div class="form-line">
                    <span><strong>Přílet (příjezd ze zahraničí):</strong></span>
                </div>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>Dne</th>
                            <th>Hodina</th>
                            <th>tj.</th>
                            <th>% stravné/kapesné</th>
                            <th>nárok</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td id="returnDate"></td>
                            <td id="returnTime"></td>
                            <td id="returnHours">40,0</td>
                            <td>% stravné/kapesné</td>
                            <td id="totalAllowance"></td>
                        </tr>
                    </tbody>
                </table>

                <div class="form-line">
                    <span><strong>b) výdaje na ubytování:</strong> <span id="accommodationReceipts">doklad č. .........................</span></span>
                </div>
                <div class="form-line">
                    <span><strong>c) nutné vedlejší výdaje:</strong> <span id="otherReceipts">doklad č. .........................</span></span>
                </div>
                <div class="form-line" id="additionalReceiptsLine" style="display:none;">
                    <span><strong>Další výdaje:</strong> <span id="additionalReceipts"></span></span>
                </div>
                <div class="form-line">
                    <span><strong>úhrnem nárok:</strong> <span class="underline" id="totalEUR"></span></span>
                </div>
            </div>

            <div class="form-section">
                <div class="form-line">
                    <strong>Zjištění rozdílu mezi přidělenými a vynaloženlmi prostředky:</strong>
                </div>
                <div class="form-line">
                    <span>Příjem: .........................</span>
                </div>
                <div class="form-line">
                    <span>Nárok: <span class="underline" id="finalClaim"></span></span>
                </div>
                <div class="form-line">
                    <span>Vráceno: .........................</span>
                </div>
                <div class="form-line">
                    <span>Doplatek: <span class="underline" id="finalPayment"></span></span>
                </div>
                <div class="form-line">
                    <span><strong>Rozdíl (dosažená devizová úspora, příp. přečerpání):</strong></span>
                </div>
                <div class="form-line">
                    <span>Vráceno bance prostřednictvím zahraniční banky: .........................</span>
                </div>
                <div class="form-line">
                    <span>Vráceno bance prostřednictvím zaměstnavatele: .........................</span>
                </div>
                <div class="form-line">
                    <span>doklad č. ......................... doklad č. .........................</span>
                </div>
                <div class="form-line">
                    <span>vráceno celkem: .........................</span>
                </div>
            </div>

            <div class="form-section page-break-section">
                <div class="form-line">
                    <span>Nepoužité letenky, jízdenky, lodní lístky a vouchery (příp. nedočerpané vouchery) byly vráceny dne: .........................</span>
                </div>
                <div class="form-line">
                    <span>Prohlašuji, že moje údaje jsou správné a úplné. Pokud se v dokladech o ubytování vyskytují sazby včetně stravování (Full board, plná pense), je tato skutečnost na dokladech uvedena.</span>
                </div>
            </div>

            <!-- Podpisová sekce v jedné řadě -->
            <div class="signature-section" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 20px; margin-top: 30px; text-align: center;">
                <div>
                    <div style="font-size: 10px; margin-bottom: 5px;">Dne</div>
                    <div id="signatureDate" style="font-size: 10px; margin-top: 10px;"></div>
                </div>
                <div>
                    <div style="font-size: 10px; margin-bottom: 5px;">Podpis zaměstnance</div>
                    <div id="employeeSignature" style="margin-top: 10px;">
                        <span style="font-size: 10px;">Podpis</span>
                    </div>
                </div>
                <div>
                    <div style="font-size: 10px; margin-bottom: 5px;">Podpis zaměstnance, který upravil vyúčtování</div>
                    <div style="margin-top: 10px;">
                        <!-- Prázdné místo pro podpis -->
                    </div>
                </div>
                <div>
                    <div style="font-size: 10px; margin-bottom: 5px;">Podpis odpovědného pracovníka</div>
                    <div id="supervisorSignature" style="margin-top: 10px;">
                        <span style="font-size: 10px;">Podpis</span>
                    </div>
                </div>
            </div>

            <!-- PDF doklad sekce -->
            <div id="pdfAttachmentSection" style="margin-top: 30px; display: none;">
                <div class="form-section" style="border-top: 2px solid #333; padding-top: 15px;">
                    <div class="form-line" style="text-align: center;">
                        <span style="font-weight: bold; font-size: 12px;">📎 PŘIPOJENÝ PDF DOKLAD</span>
                    </div>
                    <div class="form-line" style="text-align: center; margin-top: 10px;">
                        <span id="pdfAttachmentDisplay" style="font-size: 11px; color: #27ae60; font-weight: bold;"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Modal -->
    <div id="emailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>📧 Odeslat PDF emailem</h3>
                <span class="close" onclick="closeEmailModal()">&times;</span>
            </div>
            <div style="background: #e8f4fd; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 12px; color: #2c3e50;">
                <strong>💡 Tip:</strong> Na mobilních zařízeních použijte "📧 Odeslat" pro přímé sdílení. Na počítači použijte "💾 Stažení + Email" pro stažení PDF a otevření email klienta.
            </div>
            <form class="email-form" id="emailForm">
                <div>
                    <label for="emailTo">Příjemce (email):</label>
                    <input type="email" id="emailTo" required placeholder="např. zamestnanec@firma.cz">
                </div>
                <div>
                    <label for="emailSubject">Předmět:</label>
                    <input type="text" id="emailSubject" placeholder="Vyúčtování pracovní cesty">
                </div>
                <div>
                    <label for="emailBody">Zpráva:</label>
                    <textarea id="emailBody" placeholder="Dobrý den,

zasílám vyúčtování pracovní cesty.

S pozdravem"></textarea>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn" onclick="closeEmailModal()">❌ Zrušit</button>
                    <button type="button" class="btn btn-pdf" onclick="sendEmail()">📧 Odeslat</button>
                    <button type="button" class="btn btn-save" onclick="downloadAndEmail()">💾 Stažení + Email</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const EUR_TO_CZK = 25.20;
        let savedTrips = JSON.parse(localStorage.getItem('savedTrips') || '[]');
        let receipts = [];
        let currentEditingTripId = null;
        
        // Výchozí hodnoty - načtou se z localStorage nebo použijí defaultní
        let defaultValues = {
            employeeName: 'Bc. Zdeněk Šiška',
            residence: 'Havlíčkova 1383, 334 41 Dobřany',
            destination: 'Žilina, Považská Bystrica - SK'
        };

        // Uložené podpisy
        let signatures = {
            employee: null,
            supervisor: null
        };

        // Objekt pro ukládání velikostí podpisů
        let signatureSizes = {
            employee: 100,
            supervisor: 200
        };

        // PDF příloha
        let pdfAttachment = null;

        // Načtení výchozích hodnot z localStorage
        function loadDefaultValues() {
            const savedDefaults = localStorage.getItem('defaultValues');
            if (savedDefaults) {
                defaultValues = { ...defaultValues, ...JSON.parse(savedDefaults) };
            }
        }

        // Uložení výchozích hodnot do localStorage
        function saveDefaultValues() {
            localStorage.setItem('defaultValues', JSON.stringify(defaultValues));
        }

        // Aktualizace výchozích hodnot na základě aktuálních hodnot v formuláři
        function updateDefaultValues() {
            const employeeName = document.getElementById('employeeName').value.trim();
            const residence = document.getElementById('residence').value.trim();
            const destination = document.getElementById('destination').value.trim();

            if (employeeName) {
                defaultValues.employeeName = employeeName;
            }
            if (residence) {
                defaultValues.residence = residence;
            }
            if (destination) {
                defaultValues.destination = destination;
            }

            saveDefaultValues();
        }

        // Výpočet data vystavení (3 dny po konci cesty)
        function calculateIssueDate() {
            const endDate = document.getElementById('endDate').value;
            if (!endDate) return null;
            
            const endDateObj = new Date(endDate);
            const issueDate = new Date(endDateObj);
            issueDate.setDate(endDateObj.getDate() + 3);
            
            return issueDate.toISOString().split('T')[0];
        }

        // Aktualizace data vystavení v formuláři
        function updateIssueDate() {
            const issueDate = calculateIssueDate();
            if (issueDate) {
                const signatureDateElement = document.getElementById('signatureDate');
                if (signatureDateElement) {
                    signatureDateElement.textContent = formatDate(issueDate);
                }
            }
        }

        // Načtení podpisu z souboru
        function loadSignature(type, input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                signatures[type] = e.target.result;
                updateSignatureInForm(type);
                saveSignatures();
            };
            reader.readAsDataURL(file);
        }

        // Smazání podpisu
        function clearSignature(type) {
            signatures[type] = null;
            updateSignatureInForm(type);
            saveSignatures();
            
            // Vymažeme input
            const input = document.getElementById(type + 'SignatureFile');
            if (input) {
                input.value = '';
            }
        }

        // Aktualizace podpisu v formuláři
        function updateSignatureInForm(type) {
            const signatureElement = document.getElementById(type + 'Signature');
            if (!signatureElement) return;

            if (signatures[type]) {
                const size = signatureSizes[type] || 100;
                const maxHeight = Math.round(60 * (size / 100)); // Base height 60px
                signatureElement.innerHTML = `<img src="${signatures[type]}" style="max-width: 100%; max-height: ${maxHeight}px; object-fit: contain;" alt="Podpis">`;
            } else {
                signatureElement.innerHTML = '<span style="font-size: 10px;">Podpis</span>';
            }
        }

        // Aktualizace velikosti podpisu
        function updateSignatureSize(type) {
            const sizeInput = document.getElementById(type + 'SignatureSize');
            if (sizeInput) {
                signatureSizes[type] = parseInt(sizeInput.value) || 100;
                updateSignatureInForm(type);
                saveSignatureSizes();
            }
        }

        // Uložení podpisů do localStorage
        function saveSignatures() {
            localStorage.setItem('signatures', JSON.stringify(signatures));
        }

        // Uložení velikostí podpisů do localStorage
        function saveSignatureSizes() {
            localStorage.setItem('signatureSizes', JSON.stringify(signatureSizes));
        }

        // Načtení podpisů z localStorage
        function loadSignatures() {
            const savedSignatures = localStorage.getItem('signatures');
            if (savedSignatures) {
                signatures = { ...signatures, ...JSON.parse(savedSignatures) };
            }
            
            // Načteme velikosti podpisů
            const savedSizes = localStorage.getItem('signatureSizes');
            if (savedSizes) {
                signatureSizes = { ...signatureSizes, ...JSON.parse(savedSizes) };
            }
            
            // Aktualizujeme inputy pro velikost
            if (signatureSizes.employee) {
                const employeeSizeInput = document.getElementById('employeeSignatureSize');
                if (employeeSizeInput) employeeSizeInput.value = signatureSizes.employee;
            }
            if (signatureSizes.supervisor) {
                const supervisorSizeInput = document.getElementById('supervisorSignatureSize');
                if (supervisorSizeInput) supervisorSizeInput.value = signatureSizes.supervisor;
            }
            
            // Vždy aktualizujeme oba podpisy
            updateSignatureInForm('employee');
            updateSignatureInForm('supervisor');
        }

        // Načtení PDF přílohy
        function loadPDFAttachment(input) {
            const file = input.files[0];
            if (!file) return;

            if (file.type !== 'application/pdf') {
                alert('Prosím vyberte pouze PDF soubory.');
                input.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                pdfAttachment = {
                    name: file.name,
                    data: e.target.result,
                    size: file.size
                };
                updatePDFAttachmentInfo();
                savePDFAttachment();
            };
            reader.readAsDataURL(file);
        }

        // Smazání PDF přílohy
        function clearPDFAttachment() {
            pdfAttachment = null;
            updatePDFAttachmentInfo();
            savePDFAttachment();
            
            // Vymažeme input
            const input = document.getElementById('pdfAttachmentFile');
            if (input) {
                input.value = '';
            }
        }

        // Aktualizace informací o PDF příloze
        function updatePDFAttachmentInfo() {
            const infoElement = document.getElementById('pdfAttachmentInfo');
            const displayElement = document.getElementById('pdfAttachmentDisplay');
            const sectionElement = document.getElementById('pdfAttachmentSection');

            if (pdfAttachment) {
                const sizeKB = Math.round(pdfAttachment.size / 1024);
                const infoText = `Připojeno: ${pdfAttachment.name} (${sizeKB} KB)`;
                
                // Aktualizujeme informace v kalkulačce
                if (infoElement) {
                    infoElement.textContent = infoText;
                    infoElement.style.color = 'rgba(46, 204, 113, 0.9)'; // Zelená barva
                }
                
                // Aktualizujeme zobrazení v formuláři
                if (displayElement) {
                    displayElement.textContent = infoText;
                }
                
                // Zobrazíme sekci v formuláři
                if (sectionElement) {
                    sectionElement.style.display = 'block';
                }
            } else {
                // Skryjeme informace
                if (infoElement) {
                    infoElement.textContent = '';
                }
                
                if (displayElement) {
                    displayElement.textContent = '';
                }
                
                if (sectionElement) {
                    sectionElement.style.display = 'none';
                }
            }
        }

        // Uložení PDF přílohy do localStorage
        function savePDFAttachment() {
            if (pdfAttachment) {
                localStorage.setItem('pdfAttachment', JSON.stringify(pdfAttachment));
            } else {
                localStorage.removeItem('pdfAttachment');
            }
        }

        // Načtení PDF přílohy z localStorage
        function loadPDFAttachmentFromStorage() {
            const savedAttachment = localStorage.getItem('pdfAttachment');
            if (savedAttachment) {
                pdfAttachment = JSON.parse(savedAttachment);
                updatePDFAttachmentInfo();
            }
        }

        // Načtení PDF z data URL pomocí PDF.js
        async function loadPDFFromDataURL(dataURL) {
            if (!window.pdfjsLib) {
                throw new Error('PDF.js knihovna není k dispozici');
            }
            
            try {
                // Konvertujeme data URL na Uint8Array
                const base64 = dataURL.split(',')[1];
                const binaryString = atob(base64);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                // Načteme PDF
                const pdf = await pdfjsLib.getDocument({ data: bytes }).promise;
                return pdf;
            } catch (error) {
                console.error('Chyba při načítání PDF:', error);
                throw new Error(`Nepodařilo se načíst PDF: ${error.message}`);
            }
        }

        // Alternativní metoda pro připojení PDF (pokud PDF.js nefunguje)
        async function addPDFAttachmentAlternative(pdf) {
            if (!pdfAttachment) return;
            
            try {
                // Vytvoříme iframe pro zobrazení PDF
                const iframe = document.createElement('iframe');
                iframe.src = pdfAttachment.data;
                iframe.style.width = '100%';
                iframe.style.height = '800px';
                iframe.style.border = 'none';
                
                // Přidáme stránku s informací o příloze
                pdf.addPage();
                pdf.setFontSize(12);
                pdf.text('PŘIPOJENÝ PDF DOKLAD', 105, 20, { align: 'center' });
                pdf.text(`Název: ${pdfAttachment.name}`, 20, 40);
                pdf.text(`Velikost: ${Math.round(pdfAttachment.size / 1024)} KB`, 20, 50);
                pdf.text('Poznámka: PDF doklad je připojen jako samostatný soubor', 20, 70);
                pdf.text('a bude odeslán spolu s tímto dokumentem.', 20, 80);
                
                console.log('Alternativní připojení PDF dokladu dokončeno');
            } catch (error) {
                console.error('Chyba při alternativním připojování PDF:', error);
            }
        }

        function addReceipt() {
            const description = document.getElementById('receiptDescription').value;
            const amount = parseFloat(document.getElementById('receiptAmount').value);
            const type = document.getElementById('receiptType').value;

            if (!description || !amount || amount <= 0) {
                alert('Prosím vyplňte popis a platnou částku.');
                return;
            }

            const receipt = {
                id: Date.now(),
                description: description,
                amount: amount,
                type: type
            };

            receipts.push(receipt);
            updateReceiptsList();
            updateReceiptsSummary();

            // Vymazání formuláře
            document.getElementById('receiptDescription').value = '';
            document.getElementById('receiptAmount').value = '';
        }

        function removeReceipt(receiptId) {
            receipts = receipts.filter(r => r.id !== receiptId);
            updateReceiptsList();
            updateReceiptsSummary();
        }

        function updateReceiptsList() {
            const container = document.getElementById('receiptsList');
            container.innerHTML = '';

            receipts.forEach(receipt => {
                const item = document.createElement('div');
                item.className = 'receipt-item';
                item.innerHTML = `
                    <div class="receipt-info">
                        <strong>${receipt.description}</strong><br>
                        <small>Typ: ${receipt.type}</small>
                    </div>
                    <div class="receipt-amount">${receipt.amount.toFixed(2)} EUR</div>
                    <button class="btn btn-small btn-danger" onclick="removeReceipt(${receipt.id})">🗑️</button>
                `;
                container.appendChild(item);
            });
        }

        function updateReceiptsSummary() {
            const summary = document.getElementById('receiptsSummary');
            const breakdown = document.getElementById('receiptsBreakdown');

            if (receipts.length === 0) {
                summary.style.display = 'none';
                return;
            }

            summary.style.display = 'block';

            // Seskupení podle typu
            const grouped = receipts.reduce((acc, receipt) => {
                if (!acc[receipt.type]) acc[receipt.type] = 0;
                acc[receipt.type] += receipt.amount;
                return acc;
            }, {});

            const total = receipts.reduce((sum, r) => sum + r.amount, 0);

            let html = '';
            Object.entries(grouped).forEach(([type, amount]) => {
                html += `<div class="receipt-line"><span>${type}:</span><span>${amount.toFixed(2)} EUR</span></div>`;
            });
            html += `<div class="receipt-line"><span>Celkem výdaje:</span><span>${total.toFixed(2)} EUR</span></div>`;

            breakdown.innerHTML = html;
        }

        function calculateDays(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('cs-CZ');
        }

        function formatDateRange(startDate, endDate) {
            return `${formatDate(startDate)} - ${formatDate(endDate)}`;
        }

        function calculateAndShowForm() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                alert('Prosím vyplňte datum začátku a konce cesty.');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                alert('Datum začátku nemůže být později než datum konce.');
                return;
            }

            const days = calculateDays(startDate, endDate);
            
            // Výpočet částek
            const stravne = 35.00;
            const kapesne = 14.00;
            const celkemDen = 49.00;
            const allowanceTotal = days * celkemDen;
            const receiptsTotal = receipts.reduce((sum, r) => sum + r.amount, 0);
            const grandTotal = allowanceTotal + receiptsTotal;

            // Vyplnění základních údajů
            document.getElementById('printEmployeeName').textContent = document.getElementById('employeeName').value || defaultValues.employeeName;
            document.getElementById('printResidence').textContent = document.getElementById('residence').value || defaultValues.residence;
            document.getElementById('printEmployer').textContent = document.getElementById('employer').value || 'DMDsoft s.r.o.';
            document.getElementById('printDestination').textContent = document.getElementById('destination').value || defaultValues.destination;
            document.getElementById('printDateRange').textContent = formatDateRange(startDate, endDate);
            document.getElementById('printMealDates').textContent = formatDateRange(startDate, endDate);

            // Vyplnění tabulky denních příspěvků
            const tableBody = document.getElementById('dailyAllowanceBody');
            tableBody.innerHTML = '';

            let currentDate = new Date(startDate);
            const endDateObj = new Date(endDate);

            while (currentDate <= endDateObj) {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>od ${formatDate(currentDate.toISOString().split('T')[0])} do</td>
                    <td></td>
                    <td>á</td>
                    <td>${stravne.toFixed(2)} str/kap</td>
                    <td>${celkemDen.toFixed(2)}</td>
                `;
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Vyplnění dokladů
            updateReceiptsInForm();

            // Vyplnění závěrečných údajů
            document.getElementById('returnDate').textContent = formatDate(endDate);
            document.getElementById('returnTime').textContent = document.getElementById('arrivalTime').value || '23:15';
            document.getElementById('totalAllowance').textContent = `${allowanceTotal.toFixed(2)}`;
            document.getElementById('totalEUR').textContent = `${grandTotal.toFixed(2)} EUR`;
            document.getElementById('finalClaim').textContent = `${grandTotal.toFixed(2)} EUR`;
            document.getElementById('finalPayment').textContent = `${grandTotal.toFixed(2)} EUR`;
            
            // Nastavíme datum vystavení (3 dny po konci cesty)
            updateIssueDate();

            // Aktualizujeme zobrazení PDF dokladu
            updatePDFAttachmentInfo();

            // Zobrazení formuláře a tlačítek
            document.getElementById('formDocument').classList.add('show');
            document.getElementById('printBtn').style.display = 'inline-block';
            document.getElementById('pdfBtn').style.display = 'inline-block';
            document.getElementById('emailBtn').style.display = 'inline-block';
            document.getElementById('saveBtn').style.display = 'inline-block';
            document.getElementById('compactBtn').style.display = 'inline-block';
            
            // Aktualizujeme text tlačítka podle toho, zda editujeme nebo vytváříme novou cestu
            updateSaveButtonText();

            // Přesun na formulář
            document.getElementById('formDocument').scrollIntoView({ behavior: 'smooth' });
        }

        function updateReceiptsInForm() {
            const accommodationReceipts = receipts.filter(r => r.type === 'ubytování');
            const otherReceipts = receipts.filter(r => r.type !== 'ubytování');

            // Ubytování
            const accommodationElement = document.getElementById('accommodationReceipts');
            if (accommodationReceipts.length > 0) {
                const accommodationText = accommodationReceipts.map((r, index) => 
                    `doklad č. ${index + 1} (${r.description} - ${r.amount.toFixed(2)} EUR)`
                ).join(', ');
                accommodationElement.textContent = accommodationText;
            } else {
                accommodationElement.textContent = 'doklad č. .........................';
            }

            // Ostatní výdaje
            const otherElement = document.getElementById('otherReceipts');
            if (otherReceipts.length > 0) {
                const otherText = otherReceipts.map((r, index) => 
                    `doklad č. ${accommodationReceipts.length + index + 1} (${r.description} - ${r.amount.toFixed(2)} EUR)`
                ).join(', ');
                otherElement.textContent = otherText;
            } else {
                otherElement.textContent = 'doklad č. .........................';
            }

            // Zobrazení dodatečné řádky pokud je více dokladů
            const additionalLine = document.getElementById('additionalReceiptsLine');
            const additionalElement = document.getElementById('additionalReceipts');
            
            if (receipts.length > 4) {
                const additionalReceipts = receipts.slice(4);
                const additionalText = additionalReceipts.map((r, index) => 
                    `doklad č. ${5 + index} (${r.description} - ${r.amount.toFixed(2)} EUR)`
                ).join(', ');
                additionalElement.textContent = additionalText;
                additionalLine.style.display = 'block';
            } else {
                additionalLine.style.display = 'none';
            }
        }

        function printForm() {
            // Ujistíme se, že je formulář viditelný pro tisk
            const formDocument = document.getElementById('formDocument');
            const calculator = document.getElementById('calculator');
            const savedTrips = document.getElementById('savedTrips');
            
            // Dočasně skryjeme ostatní sekce
            calculator.style.display = 'none';
            savedTrips.style.display = 'none';
            formDocument.style.display = 'block';
            
            // Tisk
            window.print();
            
            // Vrátíme původní zobrazení
            setTimeout(() => {
                calculator.style.display = 'block';
                if (savedTrips.children.length > 1) {
                    savedTrips.style.display = 'block';
                }
            }, 100);
        }

        // Funkce pro konverzi obrázků na data URL
        async function convertImagesToDataURL(element) {
            const images = element.querySelectorAll('img');
            for (let img of images) {
                if (img.src && !img.src.startsWith('data:')) {
                    try {
                        // Pro lokální soubory (podpis2.jpg) použijeme fetch s mode: 'no-cors'
                        const response = await fetch(img.src, { mode: 'no-cors' });
                        if (response.type === 'opaque') {
                            // Pokud je response opaque, použijeme FileReader
                            const fileResponse = await fetch(img.src);
                            const blob = await fileResponse.blob();
                            const reader = new FileReader();
                            img.src = await new Promise((resolve) => {
                                reader.onload = () => resolve(reader.result);
                                reader.readAsDataURL(blob);
                            });
                        } else {
                            const blob = await response.blob();
                            const reader = new FileReader();
                            img.src = await new Promise((resolve) => {
                                reader.onload = () => resolve(reader.result);
                                reader.readAsDataURL(blob);
                            });
                        }
                    } catch (error) {
                        console.warn('Nepodařilo se konvertovat obrázek:', img.src, error);
                        // Pokud se nepodaří konvertovat, necháme obrázek být
                        // Nepokoušíme se ho skrýt
                    }
                }
            }
        }

        async function exportToPDF() {
            // Kontrola dostupnosti knihoven
            if (!window.jspdf) {
                alert('Chyba: PDF knihovna (jsPDF) se nenačetla. Zkontrolujte internetové připojení.');
                return;
            }
            
            if (!window.html2canvas) {
                alert('Chyba: Canvas knihovna (html2canvas) se nenačetla. Zkontrolujte internetové připojení.');
                return;
            }

            const { jsPDF } = window.jspdf;
            
            // Kontrola, zda je formulář zobrazen
            const formDocument = document.getElementById('formDocument');
            if (!formDocument || !formDocument.classList.contains('show')) {
                alert('Chyba: Formulář není zobrazen. Nejdříve vytvořte formulář.');
                return;
            }

            // Zobrazíme loading zprávu
            const originalContent = document.getElementById('formDocument').innerHTML;
            document.getElementById('formDocument').innerHTML = '<div class="loading">📄 Generuji PDF...</div>';

            try {

                // Krátké zpoždění pro zobrazení loading zprávy
                await new Promise(resolve => setTimeout(resolve, 100));

                // Vrátíme původní obsah
                document.getElementById('formDocument').innerHTML = originalContent;

                // Aktualizujeme formulář
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (startDate && endDate) {
                    // Znovu vyplníme formulář s aktuálními daty
                    updateFormForPDF();
                }

                // Převedeme obrázky na data URL pro zabránění tainted canvas
                await convertImagesToDataURL(formDocument);

                // Zapneme kompaktní režim pro PDF
                const wasCompact = formDocument.classList.contains('compact-mode');
                if (!wasCompact) {
                    formDocument.classList.add('compact-mode');
                }

                // Vytvoříme canvas z formuláře s optimalizovanými nastaveními
                let canvas;
                try {
                    canvas = await html2canvas(formDocument, {
                        scale: 1.2, // Snížené škálování pro menší velikost
                        useCORS: false, // Vypneme CORS pro lokální soubory
                        allowTaint: false, // Vypneme allowTaint - klíčové pro řešení tainted canvas
                        backgroundColor: '#ffffff',
                        width: formDocument.scrollWidth,
                        height: formDocument.scrollHeight,
                        logging: false, // Vypneme logging pro rychlejší generování
                        removeContainer: false, // Vypneme removeContainer
                        foreignObjectRendering: false, // Vypneme foreignObjectRendering
                        ignoreElements: function(element) {
                            // Ignorujeme pouze obrázky, které nejsou data URL
                            return element.tagName === 'IMG' && element.src && !element.src.startsWith('data:');
                        }
                    });
                } catch (canvasError) {
                    console.error('Chyba při vytváření canvas:', canvasError);
                    // Zkusíme jednodušší nastavení bez obrázků
                    canvas = await html2canvas(formDocument, {
                        scale: 1,
                        backgroundColor: '#ffffff',
                        logging: false,
                        allowTaint: false,
                        useCORS: false,
                        ignoreElements: function(element) {
                            // Ignorujeme pouze obrázky, které nejsou data URL
                            return element.tagName === 'IMG' && element.src && !element.src.startsWith('data:');
                        }
                    });
                }

                // Kontrola, zda se canvas vytvořil správně
                if (!canvas || canvas.width === 0 || canvas.height === 0) {
                    throw new Error('Canvas se nevytvořil správně - šířka nebo výška je 0');
                }

                // Vytvoříme PDF s optimalizovanými rozměry
                const imgData = canvas.toDataURL('image/jpeg', 0.8); // JPEG s kompresí
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const imgWidth = 200; // Menší šířka pro lepší fit
                const pageHeight = 285; // Menší výška pro okraje
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 5; // Okraj nahoře

                // Přidáme první stránku
                pdf.addImage(imgData, 'JPEG', 5, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                // Přidáme další stránky pokud je potřeba
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight + 5;
                    pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', 5, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                // Vrátíme původní režim pokud nebyl kompaktní
                if (!wasCompact) {
                    formDocument.classList.remove('compact-mode');
                }

                // Připojíme PDF přílohu pokud existuje
                if (pdfAttachment) {
                    try {
                        console.log('Připojuji PDF přílohu:', pdfAttachment.name);
                        
                        // Kontrola dostupnosti PDF.js
                        if (!window.pdfjsLib) {
                            throw new Error('PDF.js knihovna není k dispozici');
                        }
                        
                        // Načteme PDF přílohu
                        const attachmentPDF = await loadPDFFromDataURL(pdfAttachment.data);
                        console.log('PDF příloha načtena, počet stránek:', attachmentPDF.getNumberOfPages());
                        
                        // Přidáme všechny stránky z přílohy
                        const totalPages = attachmentPDF.getNumberOfPages();
                        for (let i = 1; i <= totalPages; i++) {
                            console.log(`Přidávám stránku ${i} z ${totalPages}`);
                            pdf.addPage();
                            const page = await attachmentPDF.getPage(i);
                            const viewport = page.getViewport({ scale: 1.5 }); // Zvětšíme škálování pro lepší kvalitu
                            
                            // Přidáme stránku jako obrázek
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.width = viewport.width;
                            canvas.height = viewport.height;
                            
                            const renderContext = {
                                canvasContext: context,
                                viewport: viewport
                            };
                            
                            await page.render(renderContext).promise;
                            const imgData = canvas.toDataURL('image/jpeg', 0.9); // Vyšší kvalita
                            
                            // Přidáme obrázek do PDF s lepším umístěním
                            const imgWidth = 200;
                            const imgHeight = (canvas.height * imgWidth) / canvas.width;
                            pdf.addImage(imgData, 'JPEG', 5, 5, imgWidth, imgHeight);
                            console.log(`Stránka ${i} přidána do PDF`);
                        }
                        console.log('PDF příloha úspěšně připojena');
                    } catch (error) {
                        console.error('Chyba při připojování PDF přílohy:', error);
                        console.log('Zkouším alternativní metodu...');
                        
                        // Zkusíme alternativní metodu
                        try {
                            await addPDFAttachmentAlternative(pdf);
                        } catch (altError) {
                            console.error('Alternativní metoda také selhala:', altError);
                            alert(`Nepodařilo se připojit PDF přílohu: ${error.message}`);
                        }
                    }
                }

                // Uložíme PDF
                const employeeName = document.getElementById('employeeName').value || 'zamestnanec';
                const destination = document.getElementById('destination').value || 'cesta';
                const fileName = `vyuctovani_${employeeName.replace(/\s+/g, '_')}_${destination.replace(/\s+/g, '_')}_${formatDate(new Date().toISOString().split('T')[0]).replace(/\./g, '')}.pdf`;
                
                pdf.save(fileName);

            } catch (error) {
                console.error('Chyba při generování PDF:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                
                // Vrátíme původní obsah pokud došlo k chybě
                if (originalContent) {
                    formDocument.innerHTML = originalContent;
                }
                
                // Vrátíme původní režim
                if (formDocument.classList.contains('compact-mode')) {
                    formDocument.classList.remove('compact-mode');
                }
                
                // Zobrazíme detailní chybovou zprávu
                let errorMessage = `Nepodařilo se vytvořit PDF.\n\nChyba: ${error.message}\n\n`;
                
                if (error.message.includes('html2canvas')) {
                    errorMessage += 'Problém s konverzí na obrázek. ';
                } else if (error.message.includes('jsPDF')) {
                    errorMessage += 'Problém s vytvořením PDF. ';
                } else if (error.message.includes('canvas')) {
                    errorMessage += 'Problém s canvas elementem. ';
                } else if (error.message.includes('Tainted')) {
                    errorMessage += 'Problém s tainted canvas - obrázky z jiného zdroje. ';
                } else if (error.message.includes('CORS')) {
                    errorMessage += 'Problém s CORS politikou. ';
                } else if (error.message.includes('SecurityError')) {
                    errorMessage += 'Bezpečnostní chyba prohlížeče. ';
                } else if (error.message.includes('toDataURL')) {
                    errorMessage += 'Problém s exportem canvas dat. ';
                }
                
                errorMessage += '\nZkuste to prosím znovu nebo použijte funkci tisku.';
                alert(errorMessage);
            }
        }

        function updateFormForPDF() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) return;

            const days = calculateDays(startDate, endDate);
            const allowanceTotal = days * 49.00;
            const receiptsTotal = receipts.reduce((sum, r) => sum + r.amount, 0);
            const grandTotal = allowanceTotal + receiptsTotal;

            // Aktualizujeme všechna pole
            document.getElementById('printEmployeeName').textContent = document.getElementById('employeeName').value || defaultValues.employeeName;
            document.getElementById('printResidence').textContent = document.getElementById('residence').value || defaultValues.residence;
            document.getElementById('printEmployer').textContent = document.getElementById('employer').value || 'DMDsoft s.r.o.';
            document.getElementById('printDestination').textContent = document.getElementById('destination').value || defaultValues.destination;
            document.getElementById('printDateRange').textContent = formatDateRange(startDate, endDate);
            document.getElementById('returnDate').textContent = formatDate(endDate);
            document.getElementById('returnTime').textContent = document.getElementById('arrivalTime').value || '23:15';
            document.getElementById('totalAllowance').textContent = `${allowanceTotal.toFixed(2)}`;
            document.getElementById('totalEUR').textContent = `${grandTotal.toFixed(2)} EUR`;
            document.getElementById('finalClaim').textContent = `${grandTotal.toFixed(2)} EUR`;
            document.getElementById('finalPayment').textContent = `${grandTotal.toFixed(2)} EUR`;
            
            // Aktualizujeme datum vystavení
            updateIssueDate();
            
            updateReceiptsInForm();
        }

        function saveTrip() {
            // Aktualizujeme výchozí hodnoty před uložením
            updateDefaultValues();
            
            if (currentEditingTripId) {
                // Aktualizujeme existující cestu
                updateTrip(currentEditingTripId);
                currentEditingTripId = null; // Resetujeme ID
            } else {
                // Ukládáme novou cestu
                const tripData = {
                    id: Date.now(),
                    employeeName: document.getElementById('employeeName').value,
                    residence: document.getElementById('residence').value,
                    employer: document.getElementById('employer').value,
                    employerIC: document.getElementById('employerIC').value,
                    destination: document.getElementById('destination').value,
                    purpose: document.getElementById('purpose').value,
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value,
                    departureTime: document.getElementById('departureTime').value,
                    arrivalTime: document.getElementById('arrivalTime').value,
                    receipts: [...receipts],
                    savedDate: new Date().toISOString(),
                    hasPDFAttachment: !!pdfAttachment
                };

                savedTrips.push(tripData);
                localStorage.setItem('savedTrips', JSON.stringify(savedTrips));
                
                alert('Cesta byla úspěšně uložena!');
                displaySavedTrips();
            }
        }

        function updateTrip(tripId) {
            const tripIndex = savedTrips.findIndex(trip => trip.id === tripId);
            if (tripIndex === -1) return;

            const tripData = {
                id: tripId,
                employeeName: document.getElementById('employeeName').value,
                residence: document.getElementById('residence').value,
                employer: document.getElementById('employer').value,
                employerIC: document.getElementById('employerIC').value,
                destination: document.getElementById('destination').value,
                purpose: document.getElementById('purpose').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                departureTime: document.getElementById('departureTime').value,
                arrivalTime: document.getElementById('arrivalTime').value,
                receipts: [...receipts],
                savedDate: savedTrips[tripIndex].savedDate, // Zachováme původní datum uložení
                updatedDate: new Date().toISOString(),
                hasPDFAttachment: !!pdfAttachment
            };

            savedTrips[tripIndex] = tripData;
            localStorage.setItem('savedTrips', JSON.stringify(savedTrips));
            
            alert('Cesta byla úspěšně aktualizována!');
            displaySavedTrips();
        }

        function displaySavedTrips() {
            if (savedTrips.length === 0) {
                document.getElementById('savedTrips').style.display = 'none';
                return;
            }

            document.getElementById('savedTrips').style.display = 'block';
            const listContainer = document.getElementById('savedTripsList');
            listContainer.innerHTML = '';

            savedTrips.forEach((trip, index) => {
                const tripElement = document.createElement('div');
                tripElement.className = 'saved-trip';
                tripElement.onclick = () => loadTrip(trip);
                
                const days = calculateDays(trip.startDate, trip.endDate);
                const allowanceTotal = days * 49.00;
                const receiptsTotal = (trip.receipts || []).reduce((sum, r) => sum + r.amount, 0);
                const totalAmount = allowanceTotal + receiptsTotal;
                
                tripElement.innerHTML = `
                    <div class="trip-info">
                        <div>
                            <strong>${trip.employeeName || 'Bez jména'}</strong> - ${trip.destination || 'Nespecifikováno'}
                            ${trip.hasPDFAttachment ? '<br><span style="color: #27ae60; font-weight: bold; font-size: 12px;">📎 PDF doklad připojen</span>' : ''}
                        </div>
                        <div>
                            <strong>${totalAmount.toFixed(2)} EUR</strong>
                            <button class="btn btn-small" onclick="event.stopPropagation(); loadTrip(${JSON.stringify(trip).replace(/"/g, '&quot;')})" style="margin-left: 5px;">✏️ Upravit</button>
                            <button class="btn btn-small btn-danger" onclick="event.stopPropagation(); deleteTrip(${index})" style="margin-left: 5px;">🗑️</button>
                        </div>
                    </div>
                    <div class="trip-details">
                        ${formatDateRange(trip.startDate, trip.endDate)} (${days} dnů) | 
                        Stravné: ${allowanceTotal.toFixed(2)} EUR, Výdaje: ${receiptsTotal.toFixed(2)} EUR | 
                        Uloženo: ${formatDate(trip.savedDate.split('T')[0])}
                    </div>
                `;
                
                listContainer.appendChild(tripElement);
            });
            
            // Aktualizujeme celkový součet
            updateTotalSummary();
        }

        function loadTrip(trip) {
            // Nastavíme ID editované cesty
            currentEditingTripId = trip.id;
            
            document.getElementById('employeeName').value = trip.employeeName || '';
            document.getElementById('residence').value = trip.residence || '';
            document.getElementById('employer').value = trip.employer || '';
            document.getElementById('employerIC').value = trip.employerIC || '';
            document.getElementById('destination').value = trip.destination || '';
            document.getElementById('purpose').value = trip.purpose || '';
            document.getElementById('startDate').value = trip.startDate || '';
            document.getElementById('endDate').value = trip.endDate || '';
            document.getElementById('departureTime').value = trip.departureTime || '04:00';
            document.getElementById('arrivalTime').value = trip.arrivalTime || '23:15';
            
            // Načtení dokladů
            receipts = trip.receipts || [];
            updateReceiptsList();
            updateReceiptsSummary();
            
            // Automaticky vytvoříme formulář s načtenými daty
            calculateAndShowForm();
            
            // Přesun zpět na kalkulačku
            document.getElementById('calculator').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteTrip(index) {
            if (confirm('Opravdu chcete smazat tuto uloženou cestu?')) {
                savedTrips.splice(index, 1);
                localStorage.setItem('savedTrips', JSON.stringify(savedTrips));
                displaySavedTrips(); // Toto už volá updateTotalSummary()
            }
        }

        // Aktualizace celkového součtu všech cest
        function updateTotalSummary() {
            if (savedTrips.length === 0) {
                document.getElementById('totalSummary').style.display = 'none';
                return;
            }

            document.getElementById('totalSummary').style.display = 'block';
            
            let totalTrips = savedTrips.length;
            let totalDays = 0;
            let totalAllowance = 0;
            let totalReceipts = 0;

            savedTrips.forEach(trip => {
                const days = calculateDays(trip.startDate, trip.endDate);
                const allowanceTotal = days * 49.00;
                const receiptsTotal = (trip.receipts || []).reduce((sum, r) => sum + r.amount, 0);
                
                totalDays += days;
                totalAllowance += allowanceTotal;
                totalReceipts += receiptsTotal;
            });

            const grandTotal = totalAllowance + totalReceipts;

            document.getElementById('totalTrips').textContent = totalTrips;
            document.getElementById('totalDays').textContent = totalDays;
            document.getElementById('totalAllowance').textContent = `${totalAllowance.toFixed(2)} EUR`;
            document.getElementById('totalReceipts').textContent = `${totalReceipts.toFixed(2)} EUR`;
            document.getElementById('grandTotal').textContent = `${grandTotal.toFixed(2)} EUR`;
        }

        // Export součtu do CSV
        function exportSummary() {
            if (savedTrips.length === 0) {
                alert('Žádné cesty k exportu!');
                return;
            }

            let csvContent = 'Součet všech cest\n\n';
            csvContent += 'Počet cest,Dny,Stravné (EUR),Výdaje (EUR),Celkem (EUR)\n';
            
            let totalDays = 0;
            let totalAllowance = 0;
            let totalReceipts = 0;

            savedTrips.forEach(trip => {
                const days = calculateDays(trip.startDate, trip.endDate);
                const allowanceTotal = days * 49.00;
                const receiptsTotal = (trip.receipts || []).reduce((sum, r) => sum + r.amount, 0);
                
                totalDays += days;
                totalAllowance += allowanceTotal;
                totalReceipts += receiptsTotal;
            });

            const grandTotal = totalAllowance + totalReceipts;
            
            csvContent += `${savedTrips.length},${totalDays},${totalAllowance.toFixed(2)},${totalReceipts.toFixed(2)},${grandTotal.toFixed(2)}\n\n`;
            
            csvContent += 'Detailní přehled cest:\n';
            csvContent += 'Jméno,Cíl,Od,Do,Dny,Stravné,Výdaje,Celkem,Datum uložení\n';
            
            savedTrips.forEach(trip => {
                const days = calculateDays(trip.startDate, trip.endDate);
                const allowanceTotal = days * 49.00;
                const receiptsTotal = (trip.receipts || []).reduce((sum, r) => sum + r.amount, 0);
                const totalAmount = allowanceTotal + receiptsTotal;
                
                csvContent += `"${trip.employeeName || ''}","${trip.destination || ''}","${trip.startDate}","${trip.endDate}",${days},${allowanceTotal.toFixed(2)},${receiptsTotal.toFixed(2)},${totalAmount.toFixed(2)},"${formatDate(trip.savedDate.split('T')[0])}"\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `součet_cest_${formatDate(new Date().toISOString().split('T')[0]).replace(/\./g, '')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Funkce pro odstranění diakritiky
        function removeDiacritics(str) {
            return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        }

        // Export součtu do PDF
        async function exportSummaryToPDF() {
            if (savedTrips.length === 0) {
                alert('Zadne cesty k exportu!');
                return;
            }

            try {
                if (!window.jspdf) {
                    throw new Error('jsPDF knihovna neni k dispozici');
                }

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();

                // Nadpis bez diakritiky
                pdf.setFontSize(16);
                pdf.text('SOUCET VSECH CEST', 105, 20, { align: 'center' });
                
                pdf.setFontSize(12);
                pdf.text(`Vygenerovano: ${formatDate(new Date().toISOString().split('T')[0])}`, 105, 30, { align: 'center' });

                // Celkové statistiky
                let totalDays = 0;
                let totalAllowance = 0;
                let totalReceipts = 0;

                savedTrips.forEach(trip => {
                    const days = calculateDays(trip.startDate, trip.endDate);
                    const allowanceTotal = days * 49.00;
                    const receiptsTotal = (trip.receipts || []).reduce((sum, r) => sum + r.amount, 0);
                    
                    totalDays += days;
                    totalAllowance += allowanceTotal;
                    totalReceipts += receiptsTotal;
                });

                const grandTotal = totalAllowance + totalReceipts;

                // Celkové statistiky v tabulce
                pdf.setFontSize(14);
                pdf.text('CELKOVE STATISTIKY', 20, 50);
                
                // Tabulka celkových statistik
                const summaryData = [
                    ['Pocet cest', savedTrips.length.toString()],
                    ['Celkem dnu', totalDays.toString()],
                    ['Celkem stravne', `${totalAllowance.toFixed(2)} EUR`],
                    ['Celkem vydaje', `${totalReceipts.toFixed(2)} EUR`],
                    ['CELKEM', `${grandTotal.toFixed(2)} EUR`]
                ];

                pdf.setFontSize(10);
                let yPos = 65;
                summaryData.forEach(([label, value]) => {
                    pdf.text(label, 20, yPos);
                    pdf.text(value, 120, yPos);
                    yPos += 8;
                });

                // Detailní přehled v tabulce
                pdf.setFontSize(14);
                pdf.text('DETAILNI PREHLED CEST', 20, 110);

                // Hlavička tabulky
                pdf.setFontSize(9);
                pdf.text('Cislo', 20, 125);
                pdf.text('Jmeno', 35, 125);
                pdf.text('Cil', 80, 125);
                pdf.text('Od', 120, 125);
                pdf.text('Do', 140, 125);
                pdf.text('Dny', 160, 125);
                pdf.text('Stravne', 175, 125);
                pdf.text('Vydaje', 195, 125);
                pdf.text('Celkem', 210, 125);

                // Čára pod hlavičkou
                pdf.line(20, 127, 280, 127);

                let yPosition = 135;
                pdf.setFontSize(8);

                savedTrips.forEach((trip, index) => {
                    if (yPosition > 270) {
                        pdf.addPage();
                        // Opakujeme hlavičku na nové stránce
                        pdf.setFontSize(9);
                        pdf.text('Cislo', 20, 20);
                        pdf.text('Jmeno', 35, 20);
                        pdf.text('Cil', 80, 20);
                        pdf.text('Od', 120, 20);
                        pdf.text('Do', 140, 20);
                        pdf.text('Dny', 160, 20);
                        pdf.text('Stravne', 175, 20);
                        pdf.text('Vydaje', 195, 20);
                        pdf.text('Celkem', 210, 20);
                        pdf.line(20, 22, 280, 22);
                        yPosition = 30;
                    }

                    const days = calculateDays(trip.startDate, trip.endDate);
                    const allowanceTotal = days * 49.00;
                    const receiptsTotal = (trip.receipts || []).reduce((sum, r) => sum + r.amount, 0);
                    const totalAmount = allowanceTotal + receiptsTotal;

                    // Data bez diakritiky
                    const employeeName = removeDiacritics(trip.employeeName || 'Bez jmena');
                    const destination = removeDiacritics(trip.destination || 'Nespecifikovano');
                    const startDate = trip.startDate;
                    const endDate = trip.endDate;

                    // Řádek tabulky
                    pdf.text((index + 1).toString(), 20, yPosition);
                    pdf.text(employeeName.length > 15 ? employeeName.substring(0, 15) + '...' : employeeName, 35, yPosition);
                    pdf.text(destination.length > 20 ? destination.substring(0, 20) + '...' : destination, 80, yPosition);
                    pdf.text(startDate, 120, yPosition);
                    pdf.text(endDate, 140, yPosition);
                    pdf.text(days.toString(), 160, yPosition);
                    pdf.text(`${allowanceTotal.toFixed(2)}`, 175, yPosition);
                    pdf.text(`${receiptsTotal.toFixed(2)}`, 195, yPosition);
                    pdf.text(`${totalAmount.toFixed(2)}`, 210, yPosition);

                    yPosition += 6;
                });

                // Uložení PDF
                const fileName = `soucet_cest_${formatDate(new Date().toISOString().split('T')[0]).replace(/\./g, '')}.pdf`;
                pdf.save(fileName);

            } catch (error) {
                console.error('Chyba pri exportu do PDF:', error);
                alert(`Nepodarilo se exportovat do PDF: ${error.message}`);
            }
        }

        function clearForm() {
            document.getElementById('travelForm').reset();
            receipts = [];
            currentEditingTripId = null; // Resetujeme ID editované cesty
            updateReceiptsList();
            updateReceiptsSummary();
            document.getElementById('formDocument').classList.remove('show');
            document.getElementById('printBtn').style.display = 'none';
            document.getElementById('pdfBtn').style.display = 'none';
            document.getElementById('emailBtn').style.display = 'none';
            document.getElementById('saveBtn').style.display = 'none';
            document.getElementById('saveAsNewBtn').style.display = 'none';
            document.getElementById('compactBtn').style.display = 'none';
        }

        function toggleCompactMode() {
            const formDocument = document.getElementById('formDocument');
            const compactBtn = document.getElementById('compactBtn');
            
            if (formDocument.classList.contains('compact-mode')) {
                formDocument.classList.remove('compact-mode');
                compactBtn.textContent = '📏 Kompaktní režim';
            } else {
                formDocument.classList.add('compact-mode');
                compactBtn.textContent = '📄 Normální režim';
            }
        }

        function updateSaveButtonText() {
            const saveBtn = document.getElementById('saveBtn');
            const saveAsNewBtn = document.getElementById('saveAsNewBtn');
            
            if (currentEditingTripId) {
                saveBtn.textContent = '💾 Aktualizovat cestu';
                saveAsNewBtn.style.display = 'inline-block';
            } else {
                saveBtn.textContent = '💾 Uložit cestu';
                saveAsNewBtn.style.display = 'none';
            }
        }

        function resetDefaults() {
            if (confirm('Opravdu chcete resetovat výchozí hodnoty na původní?')) {
                // Resetujeme na původní hodnoty
                defaultValues = {
                    employeeName: 'Bc. Zdeněk Šiška',
                    residence: 'Havlíčkova 1383, 334 41 Dobřany',
                    destination: 'Žilina, Považská Bystrica - SK'
                };
                
                // Uložíme do localStorage
                saveDefaultValues();
                
                // Aktualizujeme placeholdery
                document.getElementById('employeeName').placeholder = defaultValues.employeeName;
                document.getElementById('residence').placeholder = defaultValues.residence;
                document.getElementById('destination').placeholder = defaultValues.destination;
                
                alert('Výchozí hodnoty byly resetovány na původní!');
            }
        }

        function toggleMobileMode() {
            const body = document.body;
            const mobileBtn = document.getElementById('mobileBtn');
            
            if (body.classList.contains('mobile-mode')) {
                body.classList.remove('mobile-mode');
                mobileBtn.textContent = '📱 Mobilní režim';
                mobileBtn.style.background = '#3498db';
            } else {
                body.classList.add('mobile-mode');
                mobileBtn.textContent = '💻 Desktop režim';
                mobileBtn.style.background = '#e67e22';
            }
        }

        function emailPDF() {
            // Zobrazíme modal
            document.getElementById('emailModal').style.display = 'block';
            
            // Předvyplníme předmět a zprávu
            const employeeName = document.getElementById('employeeName').value || defaultValues.employeeName;
            const destination = document.getElementById('destination').value || defaultValues.destination;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (startDate && endDate) {
                const dateRange = formatDateRange(startDate, endDate);
                document.getElementById('emailSubject').value = `Vyúčtování pracovní cesty - ${destination} (${dateRange})`;
                
                const emailBody = `Dobrý den,

zasílám vyúčtování pracovní cesty do ${destination} konané ve dnech ${dateRange}.

Vyúčtování je připojeno jako PDF příloha.

S pozdravem
${employeeName}`;
                
                document.getElementById('emailBody').value = emailBody;
            }
        }

        function closeEmailModal() {
            document.getElementById('emailModal').style.display = 'none';
        }

        async function sendEmail() {
            const emailTo = document.getElementById('emailTo').value.trim();
            const emailSubject = document.getElementById('emailSubject').value.trim();
            const emailBody = document.getElementById('emailBody').value.trim();

            if (!emailTo || !emailSubject || !emailBody) {
                alert('Prosím vyplňte všechny pole.');
                return;
            }

            try {
                // Zobrazíme loading
                const sendBtn = document.querySelector('#emailModal .btn-pdf');
                const originalText = sendBtn.textContent;
                sendBtn.textContent = '⏳ Generuji PDF...';
                sendBtn.disabled = true;

                // Generujeme PDF
                const pdfBlob = await generatePDFBlob();
                
                // Zkusíme použít Web Share API (moderní prohlížeče)
                if (navigator.share && navigator.canShare) {
                    const fileName = generateFileName();
                    
                    const file = new File([pdfBlob], fileName, { type: 'application/pdf' });
                    
                    if (navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            title: emailSubject,
                            text: emailBody,
                            files: [file]
                        });
                        
                        alert('PDF bylo úspěšně sdíleno!');
                        closeEmailModal();
                        return;
                    }
                }
                
                // Fallback: Stažení PDF a otevření email klienta
                const fileName = generateFileName();
                const url = URL.createObjectURL(pdfBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                // Otevřeme email klienta s informací o staženém PDF
                const mailtoLink = createMailtoLink(emailTo, emailSubject, emailBody + '\n\nPoznámka: PDF příloha byla stažena do vašeho počítače.');
                window.location.href = mailtoLink;
                
                // Resetujeme tlačítko
                sendBtn.textContent = originalText;
                sendBtn.disabled = false;
                
                // Zavřeme modal
                closeEmailModal();
                
                alert('PDF bylo staženo a email klient byl otevřen. PDF přílohu najdete ve složce Stažené soubory.');
                
            } catch (error) {
                console.error('Chyba při generování PDF pro email:', error);
                alert('Nepodařilo se vygenerovat PDF pro email. Zkuste to prosím znovu.');
                
                // Resetujeme tlačítko
                const sendBtn = document.querySelector('#emailModal .btn-pdf');
                sendBtn.textContent = '📧 Odeslat';
                sendBtn.disabled = false;
            }
        }

        async function generatePDFBlob() {
            const { jsPDF } = window.jspdf;
            
            if (!jsPDF) {
                throw new Error('PDF knihovna není k dispozici');
            }

            // Zapneme kompaktní režim pro PDF
            const formDocument = document.getElementById('formDocument');
            const wasCompact = formDocument.classList.contains('compact-mode');
            if (!wasCompact) {
                formDocument.classList.add('compact-mode');
            }

            // Převedeme obrázky na data URL pro zabránění tainted canvas
            await convertImagesToDataURL(formDocument);

            // Vytvoříme canvas z formuláře
            const canvas = await html2canvas(formDocument, {
                scale: 1.2,
                useCORS: false,
                allowTaint: false, // Klíčové pro řešení tainted canvas
                backgroundColor: '#ffffff',
                width: formDocument.scrollWidth,
                height: formDocument.scrollHeight,
                logging: false,
                removeContainer: false,
                ignoreElements: function(element) {
                    // Ignorujeme pouze obrázky, které nejsou data URL
                    return element.tagName === 'IMG' && element.src && !element.src.startsWith('data:');
                }
            });

            // Vytvoříme PDF
            const imgData = canvas.toDataURL('image/jpeg', 0.8);
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            const imgWidth = 200;
            const pageHeight = 285;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            let heightLeft = imgHeight;
            let position = 5;

            pdf.addImage(imgData, 'JPEG', 5, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;

            while (heightLeft >= 0) {
                position = heightLeft - imgHeight + 5;
                pdf.addPage();
                pdf.addImage(imgData, 'JPEG', 5, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }

            // Vrátíme původní režim
            if (!wasCompact) {
                formDocument.classList.remove('compact-mode');
            }

            // Připojíme PDF přílohu pokud existuje
            if (pdfAttachment) {
                try {
                    console.log('Připojuji PDF přílohu pro email:', pdfAttachment.name);
                    
                    // Kontrola dostupnosti PDF.js
                    if (!window.pdfjsLib) {
                        throw new Error('PDF.js knihovna není k dispozici');
                    }
                    
                    // Načteme PDF přílohu
                    const attachmentPDF = await loadPDFFromDataURL(pdfAttachment.data);
                    console.log('PDF příloha načtena pro email, počet stránek:', attachmentPDF.getNumberOfPages());
                    
                    // Přidáme všechny stránky z přílohy
                    const totalPages = attachmentPDF.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        console.log(`Přidávám stránku ${i} z ${totalPages} pro email`);
                        pdf.addPage();
                        const page = await attachmentPDF.getPage(i);
                        const viewport = page.getViewport({ scale: 1.5 }); // Zvětšíme škálování pro lepší kvalitu
                        
                        // Přidáme stránku jako obrázek
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        
                        const renderContext = {
                            canvasContext: context,
                            viewport: viewport
                        };
                        
                        await page.render(renderContext).promise;
                        const imgData = canvas.toDataURL('image/jpeg', 0.9); // Vyšší kvalita
                        
                        // Přidáme obrázek do PDF s lepším umístěním
                        const imgWidth = 200;
                        const imgHeight = (canvas.height * imgWidth) / canvas.width;
                        pdf.addImage(imgData, 'JPEG', 5, 5, imgWidth, imgHeight);
                        console.log(`Stránka ${i} přidána do PDF pro email`);
                    }
                    console.log('PDF příloha úspěšně připojena pro email');
                } catch (error) {
                    console.error('Chyba při připojování PDF přílohy pro email:', error);
                    alert(`Nepodařilo se připojit PDF přílohu pro email: ${error.message}`);
                }
            }

            // Vytvoříme blob z PDF
            const pdfBlob = pdf.output('blob');
            return pdfBlob;
        }

        function createMailtoLink(to, subject, body) {
            const encodedSubject = encodeURIComponent(subject);
            const encodedBody = encodeURIComponent(body);
            
            return `mailto:${to}?subject=${encodedSubject}&body=${encodedBody}`;
        }

        function generateFileName() {
            const employeeName = document.getElementById('employeeName').value || defaultValues.employeeName;
            const destination = document.getElementById('destination').value || defaultValues.destination;
            const startDate = document.getElementById('startDate').value;
            
            const namePart = employeeName.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
            const destPart = destination.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
            const datePart = startDate ? startDate.replace(/-/g, '') : formatDate(new Date().toISOString().split('T')[0]).replace(/\./g, '');
            
            return `vyuctovani_${namePart}_${destPart}_${datePart}.pdf`;
        }

        async function downloadAndEmail() {
            const emailTo = document.getElementById('emailTo').value.trim();
            const emailSubject = document.getElementById('emailSubject').value.trim();
            const emailBody = document.getElementById('emailBody').value.trim();

            if (!emailTo || !emailSubject || !emailBody) {
                alert('Prosím vyplňte všechny pole.');
                return;
            }

            try {
                // Zobrazíme loading
                const downloadBtn = document.querySelector('#emailModal .btn-save');
                const originalText = downloadBtn.textContent;
                downloadBtn.textContent = '⏳ Generuji PDF...';
                downloadBtn.disabled = true;

                // Generujeme PDF
                const pdfBlob = await generatePDFBlob();
                const fileName = generateFileName();
                
                // Stažení PDF
                const url = URL.createObjectURL(pdfBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                // Otevřeme email klienta s informací o staženém PDF
                const mailtoLink = createMailtoLink(emailTo, emailSubject, emailBody + '\n\nPoznámka: PDF příloha byla stažena do vašeho počítače. Prosím připojte ji k emailu.');
                window.location.href = mailtoLink;
                
                // Resetujeme tlačítko
                downloadBtn.textContent = originalText;
                downloadBtn.disabled = false;
                
                // Zavřeme modal
                closeEmailModal();
                
                alert('PDF bylo staženo a email klient byl otevřen. Prosím připojte stažené PDF k emailu.');
                
            } catch (error) {
                console.error('Chyba při generování PDF:', error);
                alert('Nepodařilo se vygenerovat PDF. Zkuste to prosím znovu.');
                
                // Resetujeme tlačítko
                const downloadBtn = document.querySelector('#emailModal .btn-save');
                downloadBtn.textContent = '💾 Stažení + Email';
                downloadBtn.disabled = false;
            }
        }

        // Zavření modalu při kliknutí mimo něj
        window.onclick = function(event) {
            const modal = document.getElementById('emailModal');
            if (event.target === modal) {
                closeEmailModal();
            }
        }

        function saveAsNewTrip() {
            // Aktualizujeme výchozí hodnoty před uložením
            updateDefaultValues();
            
            // Dočasně resetujeme ID editované cesty
            const originalEditingId = currentEditingTripId;
            currentEditingTripId = null;
            
            // Uložíme jako novou cestu
            const tripData = {
                id: Date.now(),
                employeeName: document.getElementById('employeeName').value,
                residence: document.getElementById('residence').value,
                employer: document.getElementById('employer').value,
                employerIC: document.getElementById('employerIC').value,
                destination: document.getElementById('destination').value,
                purpose: document.getElementById('purpose').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                departureTime: document.getElementById('departureTime').value,
                arrivalTime: document.getElementById('arrivalTime').value,
                receipts: [...receipts],
                savedDate: new Date().toISOString(),
                hasPDFAttachment: !!pdfAttachment
            };

            savedTrips.push(tripData);
            localStorage.setItem('savedTrips', JSON.stringify(savedTrips));
            
            // Vrátíme původní ID pro případné další úpravy
            currentEditingTripId = originalEditingId;
            
            alert('Cesta byla úspěšně uložena jako nová cesta!');
            displaySavedTrips();
            updateSaveButtonText();
        }

        // Detekce mobilního zařízení
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   window.innerWidth <= 768;
        }

        // Inicializace při načtení stránky
        document.addEventListener('DOMContentLoaded', function() {
            // Načteme výchozí hodnoty
            loadDefaultValues();
            
            // Načteme podpisy
            loadSignatures();
            
            // Načteme PDF přílohu
            loadPDFAttachmentFromStorage();
            
            // Nastavíme výchozí hodnoty do formuláře
            document.getElementById('employeeName').placeholder = defaultValues.employeeName;
            document.getElementById('residence').placeholder = defaultValues.residence;
            document.getElementById('destination').placeholder = defaultValues.destination;
            
            // Automatická detekce mobilního zařízení
            if (isMobileDevice()) {
                document.body.classList.add('mobile-mode');
                const mobileBtn = document.getElementById('mobileBtn');
                mobileBtn.textContent = '💻 Desktop režim';
                mobileBtn.style.background = '#e67e22';
            }
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            displaySavedTrips();

        // Kontrola dostupnosti PDF knihoven
        setTimeout(() => {
            if (!window.jspdf) {
                console.error('jsPDF knihovna se nenačetla');
                alert('Upozornění: PDF knihovna se nenačetla. PDF funkce nemusí fungovat. Zkontrolujte internetové připojení.');
            }
            if (!window.html2canvas) {
                console.error('html2canvas knihovna se nenačetla');
                alert('Upozornění: Canvas knihovna se nenačetla. PDF funkce nemusí fungovat. Zkontrolujte internetové připojení.');
            }
            if (!window.pdfjsLib) {
                console.error('PDF.js knihovna se nenačetla');
                alert('Upozornění: PDF.js knihovna se nenačetla. PDF přílohy nemusí fungovat. Zkontrolujte internetové připojení.');
            }
            
            // Test dostupnosti funkcí
            console.log('PDF knihovny test:', {
                jsPDF: !!window.jspdf,
                html2canvas: !!window.html2canvas,
                pdfjsLib: !!window.pdfjsLib,
                navigator: !!navigator,
                userAgent: navigator.userAgent
            });
        }, 2000);
        });

        // Přidání event listeneru pro Enter klávesy v dokladech
        document.getElementById('receiptAmount').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addReceipt();
            }
        });

        document.getElementById('receiptDescription').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addReceipt();
            }
        });

        // Event listenery pro automatickou aktualizaci data vystavení
        document.getElementById('endDate').addEventListener('change', function() {
            // Aktualizujeme datum vystavení pouze pokud je formulář již zobrazen
            if (document.getElementById('formDocument').classList.contains('show')) {
                updateIssueDate();
            }
        });

        document.getElementById('endDate').addEventListener('input', function() {
            // Aktualizujeme datum vystavení pouze pokud je formulář již zobrazen
            if (document.getElementById('formDocument').classList.contains('show')) {
                updateIssueDate();
            }
        });
    </script>
</body>
</html>
